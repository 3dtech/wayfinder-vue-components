void 0===Float32Array&&(Float32Array=function(){return[0,0]}),"undefined"!=typeof window&&(window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(callback){window.setTimeout(callback,16)},window.cancelAnimationFrame||(window.cancelAnimationFrame=function(id){clearTimeout(id)}),"function"!=typeof String.prototype.format&&(String.prototype.format=function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return void 0!==args[number]?args[number]:match})}),window.log=function(){log.history=log.history||[],log.history.push(arguments),this.console&&console.log(Array.prototype.slice.call(arguments))}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}),window.console=window.console||{log:function(){},error:function(){}},Array.prototype.map||(Array.prototype.map=function(callback){var T,A,k;if(null==this)throw new TypeError("this is null or not defined");var kValue,O=Object(this),len=O.length>>>0;if("function"!=typeof callback)throw new TypeError(callback+" is not a function");for(1<arguments.length&&(T=arguments[1]),A=new Array(len),k=0;k<len;)k in O&&(kValue=O[k],kValue=callback.call(T,kValue,k,O),A[k]=kValue),k++;return A});var Float32Array,Class=function(){};function ClassCallback(classScope,fnCallback){return function(){return fnCallback.apply(classScope,arguments)}}!function(){var initializing=!1,fnTest=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(prop){var name,_super=this.prototype,prototype=(initializing=!0,new this);for(name in initializing=!1,prop)prototype[name]="function"==typeof prop[name]&&"function"==typeof _super[name]&&fnTest.test(prop[name])?function(name,fn){return function(){var tmp=this._super,ret=(this._super=_super[name],fn.apply(this,arguments));return this._super=tmp,ret}}(name,prop[name]):prop[name];function Class(){!initializing&&this.init&&this.init.apply(this,arguments)}return((Class.prototype=prototype).constructor=Class).extend=arguments.callee,Class}}();var Callback=ClassCallback,ArrayUtility=(!function(a,b,d){"use strict";function e(a,b,c){return setTimeout(j(a,c),b)}function f(a,b,c){return Array.isArray(a)&&(g(a,c[b],c),1)}function g(a,b,c){if(a)if(a.forEach)a.forEach(b,c);else if(a.length!==d)for(e=0;e<a.length;)b.call(c,a[e],e,a),e++;else for(var e in a)a.hasOwnProperty(e)&&b.call(c,a[e],e,a)}function h(b,c,d){var e="DEPRECATED METHOD: "+c+"\n"+d+" AT \n";return function(){var c=new Error("get-stack-trace"),c=c&&c.stack?c.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",f=a.console&&(a.console.warn||a.console.log);return f&&f.call(a.console,e,c),b.apply(this,arguments)}}function i(a,b,c){var b=b.prototype,d=a.prototype=Object.create(b);d.constructor=a,d._super=b,c&&la(d,c)}function j(a,b){return function(){return a.apply(b,arguments)}}function k(a,b){return typeof a==oa?a.apply(b&&b[0]||d,b):a}function l(a,b){return a===d?b:a}function m(a,b,c){g(q(b),function(b){a.addEventListener(b,c,!1)})}function n(a,b,c){g(q(b),function(b){a.removeEventListener(b,c,!1)})}function o(a,b){for(;a;){if(a==b)return!0;a=a.parentNode}return!1}function p(a,b){return-1<a.indexOf(b)}function q(a){return a.trim().split(/\s+/g)}function r(a,b,c){if(a.indexOf&&!c)return a.indexOf(b);for(var d=0;d<a.length;){if(c&&a[d][c]==b||!c&&a[d]===b)return d;d++}return-1}function s(a){return Array.prototype.slice.call(a,0)}function t(a,b,c){for(var d=[],e=[],f=0;f<a.length;){var g=b?a[f][b]:a[f];r(e,g)<0&&d.push(a[f]),e[f]=g,f++}return d=c?b?d.sort(function(a,c){return a[b]>c[b]}):d.sort():d}function u(a,b){for(var c,f=b[0].toUpperCase()+b.slice(1),g=0;g<ma.length;){if((c=(c=ma[g])?c+f:b)in a)return c;g++}return d}function w(b){b=b.ownerDocument||b;return b.defaultView||b.parentWindow||a}function x(a,b){var c=this;this.manager=a,this.callback=b,this.element=a.element,this.target=a.options.inputTarget,this.domHandler=function(b){k(a.options.enable,[a])&&c.handler(b)},this.init()}function z(a,b,c){var d=c.pointers.length,e=c.changedPointers.length,f=b&Ea&&d-e==0,d=b&(Ga|Ha)&&d-e==0;c.isFirst=!!f,c.isFinal=!!d,f&&(a.session={}),c.eventType=b,function(a,b){var c=a.session,d=b.pointers,e=d.length,e=(c.firstInput||(c.firstInput=D(b)),1<e&&!c.firstMultiple?c.firstMultiple=D(b):1===e&&(c.firstMultiple=!1),c.firstInput),g=c.firstMultiple,h=(g||e).center,i=b.center=E(d),e=(b.timeStamp=ra(),b.deltaTime=b.timeStamp-e.timeStamp,b.angle=I(h,i),b.distance=H(h,i),function(a,b){var c=b.center,d=a.offsetDelta||{},e=a.prevDelta||{},f=a.prevInput||{};b.eventType!==Ea&&f.eventType!==Ga||(e=a.prevDelta={x:f.deltaX||0,y:f.deltaY||0},d=a.offsetDelta={x:c.x,y:c.y}),b.deltaX=e.x+(c.x-d.x),b.deltaY=e.y+(c.y-d.y)}(c,b),b.offsetDirection=G(b.deltaX,b.deltaY),F(b.deltaTime,b.deltaX,b.deltaY)),h=(b.overallVelocityX=e.x,b.overallVelocityY=e.y,b.overallVelocity=qa(e.x)>qa(e.y)?e.x:e.y,b.scale=g?function(a,b){return H(b[0],b[1],Ra)/H(a[0],a[1],Ra)}(g.pointers,d):1,b.rotation=g?function(a,b){return I(b[1],b[0],Ra)+I(a[1],a[0],Ra)}(g.pointers,d):0,b.maxPointers=!c.prevInput||b.pointers.length>c.prevInput.maxPointers?b.pointers.length:c.prevInput.maxPointers,C(c,b),a.element);o(b.srcEvent.target,h)&&(h=b.srcEvent.target),b.target=h}(a,c),a.emit("hammer.input",c),a.recognize(c),a.session.prevInput=c}function C(a,b){var e,f,l,k,h=a.lastInterval||b,i=b.timeStamp-h.timeStamp;b.eventType!=Ha&&(Da<i||h.velocity===d)?(e=(l=F(i,i=b.deltaX-h.deltaX,k=b.deltaY-h.deltaY)).x,f=l.y,l=qa(l.x)>qa(l.y)?l.x:l.y,k=G(i,k),a.lastInterval=b):(l=h.velocity,e=h.velocityX,f=h.velocityY,k=h.direction),b.velocity=l,b.velocityX=e,b.velocityY=f,b.direction=k}function D(a){for(var b=[],c=0;c<a.pointers.length;)b[c]={clientX:pa(a.pointers[c].clientX),clientY:pa(a.pointers[c].clientY)},c++;return{timeStamp:ra(),pointers:b,center:E(b),deltaX:a.deltaX,deltaY:a.deltaY}}function E(a){var b=a.length;if(1===b)return{x:pa(a[0].clientX),y:pa(a[0].clientY)};for(var c=0,d=0,e=0;e<b;)c+=a[e].clientX,d+=a[e].clientY,e++;return{x:pa(c/b),y:pa(d/b)}}function F(a,b,c){return{x:b/a||0,y:c/a||0}}function G(a,b){return a===b?Ia:qa(a)>=qa(b)?a<0?Ja:Ka:b<0?La:Ma}function H(a,b,c){var d=b[(c=c||Qa)[0]]-a[c[0]],b=b[c[1]]-a[c[1]];return Math.sqrt(d*d+b*b)}function I(a,b,c){var d=b[(c=c||Qa)[0]]-a[c[0]],b=b[c[1]]-a[c[1]];return 180*Math.atan2(b,d)/Math.PI}function L(){this.evEl="mousedown",this.evWin="mousemove mouseup",this.pressed=!1,x.apply(this,arguments)}function M(){this.evEl=Xa,this.evWin=Ya,x.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}function N(){this.evTarget="touchstart",this.evWin="touchstart touchmove touchend touchcancel",this.started=!1,x.apply(this,arguments)}function P(){this.evTarget="touchstart touchmove touchend touchcancel",this.targetIds={},x.apply(this,arguments)}function R(){x.apply(this,arguments);var a=j(this.handler,this);this.touch=new P(this.manager,a),this.mouse=new L(this.manager,a),this.primaryTouch=null,this.lastTouches=[]}function T(a){var c,d,a=a.changedPointers[0];a.identifier===this.primaryTouch&&(c={x:a.clientX,y:a.clientY},this.lastTouches.push(c),d=this.lastTouches,setTimeout(function(){var a=d.indexOf(c);-1<a&&d.splice(a,1)},cb))}function V(a,b){this.manager=a,this.set(b)}function Y(a){this.options=la({},this.defaults,a||{}),this.id=ua++,this.manager=null,this.options.enable=l(this.options.enable,!0),this.state=1,this.simultaneous={},this.requireFail=[]}function Z(a){return 16&a?"cancel":8&a?"end":4&a?"move":2&a?"start":""}function $(a){return a==Ma?"down":a==La?"up":a==Ja?"left":a==Ka?"right":""}function _(a,b){b=b.manager;return b?b.get(a):a}function aa(){Y.apply(this,arguments)}function ba(){aa.apply(this,arguments),this.pX=null,this.pY=null}function ca(){aa.apply(this,arguments)}function da(){Y.apply(this,arguments),this._timer=null,this._input=null}function ea(){aa.apply(this,arguments)}function fa(){aa.apply(this,arguments)}function ga(){Y.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}function ha(a,b){return(b=b||{}).recognizers=l(b.recognizers,ha.defaults.preset),new ia(a,b)}function ia(a,b){this.options=la({},ha.defaults,b||{}),this.options.inputTarget=this.options.inputTarget||a,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=a,this.input=function(a){var c=a.options.inputClass;return new(c||(xa?M:ya?P:wa?R:L))(a,z)}(this),this.touchAction=new V(this,this.options.touchAction),ja(this,!0),g(this.options.recognizers,function(a){var b=this.add(new a[0](a[1]));a[2]&&b.recognizeWith(a[2]),a[3]&&b.requireFailure(a[3])},this)}function ja(a,b){var d,c=a.element;c.style&&(g(a.options.cssProps,function(e,f){d=u(c.style,f),b?(a.oldCssProps[d]=c.style[d],c.style[d]=e):c.style[d]=a.oldCssProps[d]||""}),b||(a.oldCssProps={}))}function ka(a,c){var d=b.createEvent("Event");d.initEvent(a,!0,!0),(d.gesture=c).target.dispatchEvent(d)}var ma=["","webkit","Moz","MS","ms","o"],na=b.createElement("div"),oa="function",pa=Math.round,qa=Math.abs,ra=Date.now,la="function"!=typeof Object.assign?function(a){if(a===d||null===a)throw new TypeError("Cannot convert undefined or null to object");for(var b=Object(a),c=1;c<arguments.length;c++){var e=arguments[c];if(e!==d&&null!==e)for(var f in e)e.hasOwnProperty(f)&&(b[f]=e[f])}return b}:Object.assign,sa=h(function(a,b,c){for(var e=Object.keys(b),f=0;f<e.length;)c&&a[e[f]]!==d||(a[e[f]]=b[e[f]]),f++;return a},"extend","Use `assign`."),ta=h(function(a,b){return sa(a,b,!0)},"merge","Use `assign`."),ua=1,wa="ontouchstart"in a,xa=u(a,"PointerEvent")!==d,ya=wa&&/mobile|tablet|ip(ad|hone|od)|android/i.test(navigator.userAgent),za="touch",Ba="mouse",Da=25,Ea=1,Ga=4,Ha=8,Ia=1,Ja=2,Ka=4,La=8,Ma=16,Na=Ja|Ka,Oa=La|Ma,Pa=Na|Oa,Qa=["x","y"],Ra=["clientX","clientY"],Sa=(x.prototype={handler:function(){},init:function(){this.evEl&&m(this.element,this.evEl,this.domHandler),this.evTarget&&m(this.target,this.evTarget,this.domHandler),this.evWin&&m(w(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&n(this.element,this.evEl,this.domHandler),this.evTarget&&n(this.target,this.evTarget,this.domHandler),this.evWin&&n(w(this.element),this.evWin,this.domHandler)}},{mousedown:Ea,mousemove:2,mouseup:Ga}),Va=(i(L,x,{handler:function(a){var b=Sa[a.type];b&Ea&&0===a.button&&(this.pressed=!0),2&b&&1!==a.which&&(b=Ga),this.pressed&&(b&Ga&&(this.pressed=!1),this.callback(this.manager,b,{pointers:[a],changedPointers:[a],pointerType:Ba,srcEvent:a}))}}),{pointerdown:Ea,pointermove:2,pointerup:Ga,pointercancel:Ha,pointerout:Ha}),Wa={2:za,3:"pen",4:Ba,5:"kinect"},Xa="pointerdown",Ya="pointermove pointerup pointercancel",Za=(a.MSPointerEvent&&!a.PointerEvent&&(Xa="MSPointerDown",Ya="MSPointerMove MSPointerUp MSPointerCancel"),i(M,x,{handler:function(a){var b=this.store,c=!1,d=a.type.toLowerCase().replace("ms",""),d=Va[d],f=Wa[a.pointerType]||a.pointerType,g=f==za,h=r(b,a.pointerId,"pointerId");d&Ea&&(0===a.button||g)?h<0&&(b.push(a),h=b.length-1):d&(Ga|Ha)&&(c=!0),h<0||(b[h]=a,this.callback(this.manager,d,{pointers:b,changedPointers:[a],pointerType:f,srcEvent:a}),c&&b.splice(h,1))}}),{touchstart:Ea,touchmove:2,touchend:Ga,touchcancel:Ha}),ab=(i(N,x,{handler:function(a){var c,b=Za[a.type];b===Ea&&(this.started=!0),this.started&&(c=function(a,b){var c=s(a.touches),a=s(a.changedTouches);return[c=b&(Ga|Ha)?t(c.concat(a),"identifier",!0):c,a]}.call(this,a,b),b&(Ga|Ha)&&c[0].length-c[1].length==0&&(this.started=!1),this.callback(this.manager,b,{pointers:c[0],changedPointers:c[1],pointerType:za,srcEvent:a}))}}),{touchstart:Ea,touchmove:2,touchend:Ga,touchcancel:Ha}),cb=(i(P,x,{handler:function(a){var b=ab[a.type],c=function(a,b){var c=s(a.touches),d=this.targetIds;if(b&(2|Ea)&&1===c.length)return d[c[0].identifier]=!0,[c,c];var e,g=s(a.changedTouches),h=[],i=this.target,f=c.filter(function(a){return o(a.target,i)});if(b===Ea)for(e=0;e<f.length;)d[f[e].identifier]=!0,e++;for(e=0;e<g.length;)d[g[e].identifier]&&h.push(g[e]),b&(Ga|Ha)&&delete d[g[e].identifier],e++;return h.length?[t(f.concat(h),"identifier",!0),h]:void 0}.call(this,a,b);c&&this.callback(this.manager,b,{pointers:c[0],changedPointers:c[1],pointerType:za,srcEvent:a})}}),2500),eb=(i(R,x,{handler:function(a,b,c){var d=c.pointerType==za,e=c.pointerType==Ba;if(!(e&&c.sourceCapabilities&&c.sourceCapabilities.firesTouchEvents)){if(d)!function(a,b){a&Ea?(this.primaryTouch=b.changedPointers[0].identifier,T.call(this,b)):a&(Ga|Ha)&&T.call(this,b)}.call(this,b,c);else if(e&&function(a){for(var b=a.srcEvent.clientX,c=a.srcEvent.clientY,d=0;d<this.lastTouches.length;d++){var e=this.lastTouches[d],f=Math.abs(b-e.x),e=Math.abs(c-e.y);if(f<=25&&e<=25)return!0}return!1}.call(this,c))return;this.callback(a,b,c)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}}),u(na.style,"touchAction")),fb=eb!==d,gb="compute",ib="manipulation",jb="none",kb="pan-x",lb="pan-y",mb=function(){var b,c;return fb&&(b={},c=a.CSS&&a.CSS.supports,["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach(function(d){b[d]=!c||a.CSS.supports("touch-action",d)}),b)}();V.prototype={set:function(a){a==gb&&(a=this.compute()),fb&&this.manager.element.style&&mb[a]&&(this.manager.element.style[eb]=a),this.actions=a.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var a=[];return g(this.manager.recognizers,function(b){k(b.options.enable,[b])&&(a=a.concat(b.getTouchAction()))}),function(a){var b,c;return p(a,jb)||(b=p(a,kb),c=p(a,lb),b&&c)?jb:b||c?b?kb:lb:p(a,ib)?ib:"auto"}(a.join(" "))},preventDefaults:function(a){var b=a.srcEvent,c=a.offsetDirection;if(!this.manager.session.prevented){var d=this.actions,e=p(d,jb)&&!mb[jb],f=p(d,lb)&&!mb[lb],d=p(d,kb)&&!mb[kb];if(e){var h=1===a.pointers.length,i=a.distance<2,a=a.deltaTime<250;if(h&&i&&a)return}return(!d||!f)&&(e||f&&c&Na||d&&c&Oa)?this.preventSrc(b):void 0}b.preventDefault()},preventSrc:function(a){this.manager.session.prevented=!0,a.preventDefault()}},Y.prototype={defaults:{},set:function(a){return la(this.options,a),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(a){var b;return f(a,"recognizeWith",this)||(b=this.simultaneous)[(a=_(a,this)).id]||(b[a.id]=a).recognizeWith(this),this},dropRecognizeWith:function(a){return f(a,"dropRecognizeWith",this)||(a=_(a,this),delete this.simultaneous[a.id]),this},requireFailure:function(a){var b;return f(a,"requireFailure",this)||-1===r(b=this.requireFail,a=_(a,this))&&(b.push(a),a.requireFailure(this)),this},dropRequireFailure:function(a){return f(a,"dropRequireFailure",this)||(a=_(a,this),-1<(a=r(this.requireFail,a))&&this.requireFail.splice(a,1)),this},hasRequireFailures:function(){return 0<this.requireFail.length},canRecognizeWith:function(a){return!!this.simultaneous[a.id]},emit:function(a){function b(b){c.manager.emit(b,a)}var c=this,d=this.state;d<8&&b(c.options.event+Z(d)),b(c.options.event),a.additionalEvent&&b(a.additionalEvent),8<=d&&b(c.options.event+Z(d))},tryEmit:function(a){return this.canEmit()?this.emit(a):void(this.state=32)},canEmit:function(){for(var a=0;a<this.requireFail.length;){if(!(33&this.requireFail[a].state))return!1;a++}return!0},recognize:function(a){a=la({},a);return k(this.options.enable,[this,a])?(56&this.state&&(this.state=1),this.state=this.process(a),void(30&this.state&&this.tryEmit(a))):(this.reset(),void(this.state=32))},process:function(a){},getTouchAction:function(){},reset:function(){}},i(aa,Y,{defaults:{pointers:1},attrTest:function(a){var b=this.options.pointers;return 0===b||a.pointers.length===b},process:function(a){var b=this.state,c=a.eventType,d=6&b,a=this.attrTest(a);return d&&(c&Ha||!a)?16|b:d||a?c&Ga?8|b:2&b?4|b:2:32}}),i(ba,aa,{defaults:{event:"pan",threshold:10,pointers:1,direction:Pa},getTouchAction:function(){var a=this.options.direction,b=[];return a&Na&&b.push(lb),a&Oa&&b.push(kb),b},directionTest:function(a){var b=this.options,c=!0,d=a.distance,e=a.direction,f=a.deltaX,g=a.deltaY;return e&b.direction||(d=b.direction&Na?(e=0===f?Ia:f<0?Ja:Ka,c=f!=this.pX,Math.abs(a.deltaX)):(e=0===g?Ia:g<0?La:Ma,c=g!=this.pY,Math.abs(a.deltaY))),a.direction=e,c&&d>b.threshold&&e&b.direction},attrTest:function(a){return aa.prototype.attrTest.call(this,a)&&(2&this.state||!(2&this.state)&&this.directionTest(a))},emit:function(a){this.pX=a.deltaX,this.pY=a.deltaY;var b=$(a.direction);b&&(a.additionalEvent=this.options.event+b),this._super.emit.call(this,a)}}),i(ca,aa,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[jb]},attrTest:function(a){return this._super.attrTest.call(this,a)&&(Math.abs(a.scale-1)>this.options.threshold||2&this.state)},emit:function(a){var b;1!==a.scale&&(b=a.scale<1?"in":"out",a.additionalEvent=this.options.event+b),this._super.emit.call(this,a)}}),i(da,Y,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return["auto"]},process:function(a){var b=this.options,c=a.pointers.length===b.pointers,d=a.distance<b.threshold,f=a.deltaTime>b.time;if(this._input=a,!d||!c||a.eventType&(Ga|Ha)&&!f)this.reset();else if(a.eventType&Ea)this.reset(),this._timer=e(function(){this.state=8,this.tryEmit()},b.time,this);else if(a.eventType&Ga)return 8;return 32},reset:function(){clearTimeout(this._timer)},emit:function(a){8===this.state&&(a&&a.eventType&Ga?this.manager.emit(this.options.event+"up",a):(this._input.timeStamp=ra(),this.manager.emit(this.options.event,this._input)))}}),i(ea,aa,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[jb]},attrTest:function(a){return this._super.attrTest.call(this,a)&&(Math.abs(a.rotation)>this.options.threshold||2&this.state)}}),i(fa,aa,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:Na|Oa,pointers:1},getTouchAction:function(){return ba.prototype.getTouchAction.call(this)},attrTest:function(a){var b,c=this.options.direction;return c&(Na|Oa)?b=a.overallVelocity:c&Na?b=a.overallVelocityX:c&Oa&&(b=a.overallVelocityY),this._super.attrTest.call(this,a)&&c&a.offsetDirection&&a.distance>this.options.threshold&&a.maxPointers==this.options.pointers&&qa(b)>this.options.velocity&&a.eventType&Ga},emit:function(a){var b=$(a.offsetDirection);b&&this.manager.emit(this.options.event+b,a),this.manager.emit(this.options.event,a)}}),i(ga,Y,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[ib]},process:function(a){var b=this.options,c=a.pointers.length===b.pointers,d=a.distance<b.threshold,f=a.deltaTime<b.time;if(this.reset(),a.eventType&Ea&&0===this.count)return this.failTimeout();if(d&&f&&c){if(a.eventType!=Ga)return this.failTimeout();d=!this.pTime||a.timeStamp-this.pTime<b.interval,f=!this.pCenter||H(this.pCenter,a.center)<b.posThreshold;if(this.pTime=a.timeStamp,this.pCenter=a.center,f&&d?this.count+=1:this.count=1,this._input=a,0==this.count%b.taps)return this.hasRequireFailures()?(this._timer=e(function(){this.state=8,this.tryEmit()},b.interval,this),2):8}return 32},failTimeout:function(){return this._timer=e(function(){this.state=32},this.options.interval,this),32},reset:function(){clearTimeout(this._timer)},emit:function(){8==this.state&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}}),ha.VERSION="2.0.8",ha.defaults={domEvents:!1,touchAction:gb,enable:!0,inputTarget:null,inputClass:null,preset:[[ea,{enable:!1}],[ca,{enable:!1},["rotate"]],[fa,{direction:Na}],[ba,{direction:Na},["swipe"]],[ga],[ga,{event:"doubletap",taps:2},["tap"]],[da]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};ia.prototype={set:function(a){return la(this.options,a),a.touchAction&&this.touchAction.update(),a.inputTarget&&(this.input.destroy(),this.input.target=a.inputTarget,this.input.init()),this},stop:function(a){this.session.stopped=a?2:1},recognize:function(a){var b=this.session;if(!b.stopped){this.touchAction.preventDefaults(a);var c,d=this.recognizers,e=b.curRecognizer;(!e||8&e.state)&&(e=b.curRecognizer=null);for(var f=0;f<d.length;)c=d[f],2===b.stopped||e&&c!=e&&!c.canRecognizeWith(e)?c.reset():c.recognize(a),!e&&14&c.state&&(e=b.curRecognizer=c),f++}},get:function(a){if(a instanceof Y)return a;for(var b=this.recognizers,c=0;c<b.length;c++)if(b[c].options.event==a)return b[c];return null},add:function(a){var b;return f(a,"add",this)?this:((b=this.get(a.options.event))&&this.remove(b),this.recognizers.push(a),(a.manager=this).touchAction.update(),a)},remove:function(a){var b;return f(a,"remove",this)||(a=this.get(a))&&-1!==(a=r(b=this.recognizers,a))&&(b.splice(a,1),this.touchAction.update()),this},on:function(a,b){var c;if(a!==d&&b!==d)return c=this.handlers,g(q(a),function(a){c[a]=c[a]||[],c[a].push(b)}),this},off:function(a,b){var c;if(a!==d)return c=this.handlers,g(q(a),function(a){b?c[a]&&c[a].splice(r(c[a],b),1):delete c[a]}),this},emit:function(a,b){this.options.domEvents&&ka(a,b);var c=this.handlers[a]&&this.handlers[a].slice();if(c&&c.length){b.type=a,b.preventDefault=function(){b.srcEvent.preventDefault()};for(var d=0;d<c.length;)c[d](b),d++}},destroy:function(){this.element&&ja(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}},la(ha,{INPUT_START:Ea,INPUT_MOVE:2,INPUT_END:Ga,INPUT_CANCEL:Ha,STATE_POSSIBLE:1,STATE_BEGAN:2,STATE_CHANGED:4,STATE_ENDED:8,STATE_RECOGNIZED:8,STATE_CANCELLED:16,STATE_FAILED:32,DIRECTION_NONE:Ia,DIRECTION_LEFT:Ja,DIRECTION_RIGHT:Ka,DIRECTION_UP:La,DIRECTION_DOWN:Ma,DIRECTION_HORIZONTAL:Na,DIRECTION_VERTICAL:Oa,DIRECTION_ALL:Pa,Manager:ia,Input:x,TouchAction:V,TouchInput:P,MouseInput:L,PointerEventInput:M,TouchMouseInput:R,SingleTouchInput:N,Recognizer:Y,AttrRecognizer:aa,Tap:ga,Pan:ba,Swipe:fa,Pinch:ca,Rotate:ea,Press:da,on:m,off:n,each:g,merge:ta,extend:sa,assign:la,inherit:i,bindFn:j,prefixed:u}),(void 0!==a?a:"undefined"!=typeof self?self:{}).Hammer=ha,"function"==typeof define&&define.amd?define(function(){return ha}):"undefined"!=typeof module&&module.exports?module.exports=ha:a.Hammer=ha}(window,document),!function(){"use strict";var shim={};"undefined"==typeof exports?"function"==typeof define&&"object"==typeof define.amd&&define.amd?(shim.exports={},define(function(){return shim.exports})):shim.exports=window:shim.exports=exports,function(exports){var vec,GLMAT_EPSILON,vec2={},vec2=(GLMAT_EPSILON=GLMAT_EPSILON||1e-6,vec2.create=function(){return new Float32Array(2)},vec2.clone=function(a){var out=new Float32Array(2);return out[0]=a[0],out[1]=a[1],out},vec2.fromValues=function(x,y){var out=new Float32Array(2);return out[0]=x,out[1]=y,out},vec2.copy=function(out,a){return out[0]=a[0],out[1]=a[1],out},vec2.set=function(out,x,y){return out[0]=x,out[1]=y,out},vec2.add=function(out,a,b){return out[0]=a[0]+b[0],out[1]=a[1]+b[1],out},vec2.sub=vec2.subtract=function(out,a,b){return out[0]=a[0]-b[0],out[1]=a[1]-b[1],out},vec2.mul=vec2.multiply=function(out,a,b){return out[0]=a[0]*b[0],out[1]=a[1]*b[1],out},vec2.div=vec2.divide=function(out,a,b){return out[0]=a[0]/b[0],out[1]=a[1]/b[1],out},vec2.min=function(out,a,b){return out[0]=Math.min(a[0],b[0]),out[1]=Math.min(a[1],b[1]),out},vec2.max=function(out,a,b){return out[0]=Math.max(a[0],b[0]),out[1]=Math.max(a[1],b[1]),out},vec2.scale=function(out,a,b){return out[0]=a[0]*b,out[1]=a[1]*b,out},vec2.dist=vec2.distance=function(a,b){var x=b[0]-a[0],b=b[1]-a[1];return Math.sqrt(x*x+b*b)},vec2.sqrDist=vec2.squaredDistance=function(a,b){var x=b[0]-a[0],b=b[1]-a[1];return x*x+b*b},vec2.len=vec2.length=function(a){var x=a[0],a=a[1];return Math.sqrt(x*x+a*a)},vec2.sqrLen=vec2.squaredLength=function(a){var x=a[0],a=a[1];return x*x+a*a},vec2.negate=function(out,a){return out[0]=-a[0],out[1]=-a[1],out},vec2.normalize=function(out,a){var x=a[0],y=a[1],x=x*x+y*y;return 0<x&&(x=1/Math.sqrt(x),out[0]=a[0]*x,out[1]=a[1]*x),out},vec2.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]},vec2.cross=function(out,a,b){a=a[0]*b[1]-a[1]*b[0];return out[0]=out[1]=0,out[2]=a,out},vec2.lerp=function(out,a,b,t){var ax=a[0],a=a[1];return out[0]=ax+t*(b[0]-ax),out[1]=a+t*(b[1]-a),out},vec2.transformMat2=function(out,a,m){var x=a[0],a=a[1];return out[0]=x*m[0]+a*m[1],out[1]=x*m[2]+a*m[3],out},vec2.forEach=(vec=new Float32Array(2),function(a,stride,offset,count,fn,arg){var i,l;for(stride=stride||2,offset=offset||0,l=count?Math.min(count*stride+offset,a.length):a.length,i=offset;i<l;i+=stride)vec[0]=a[i],vec[1]=a[i+1],fn(vec,vec,arg),a[i]=vec[0],a[i+1]=vec[1];return a}),vec2.str=function(a){return"vec2("+a[0]+", "+a[1]+")"},void 0!==exports&&(exports.vec2=vec2),{}),vec2=(GLMAT_EPSILON=GLMAT_EPSILON||1e-6,vec2.create=function(){return new Float32Array(3)},vec2.clone=function(a){var out=new Float32Array(3);return out[0]=a[0],out[1]=a[1],out[2]=a[2],out},vec2.fromValues=function(x,y,z){var out=new Float32Array(3);return out[0]=x,out[1]=y,out[2]=z,out},vec2.copy=function(out,a){return out[0]=a[0],out[1]=a[1],out[2]=a[2],out},vec2.set=function(out,x,y,z){return out[0]=x,out[1]=y,out[2]=z,out},vec2.add=function(out,a,b){return out[0]=a[0]+b[0],out[1]=a[1]+b[1],out[2]=a[2]+b[2],out},vec2.sub=vec2.subtract=function(out,a,b){return out[0]=a[0]-b[0],out[1]=a[1]-b[1],out[2]=a[2]-b[2],out},vec2.mul=vec2.multiply=function(out,a,b){return out[0]=a[0]*b[0],out[1]=a[1]*b[1],out[2]=a[2]*b[2],out},vec2.div=vec2.divide=function(out,a,b){return out[0]=a[0]/b[0],out[1]=a[1]/b[1],out[2]=a[2]/b[2],out},vec2.min=function(out,a,b){return out[0]=Math.min(a[0],b[0]),out[1]=Math.min(a[1],b[1]),out[2]=Math.min(a[2],b[2]),out},vec2.max=function(out,a,b){return out[0]=Math.max(a[0],b[0]),out[1]=Math.max(a[1],b[1]),out[2]=Math.max(a[2],b[2]),out},vec2.scale=function(out,a,b){return out[0]=a[0]*b,out[1]=a[1]*b,out[2]=a[2]*b,out},vec2.dist=vec2.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],b=b[2]-a[2];return Math.sqrt(x*x+y*y+b*b)},vec2.sqrDist=vec2.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],b=b[2]-a[2];return x*x+y*y+b*b},vec2.len=vec2.length=function(a){var x=a[0],y=a[1],a=a[2];return Math.sqrt(x*x+y*y+a*a)},vec2.sqrLen=vec2.squaredLength=function(a){var x=a[0],y=a[1],a=a[2];return x*x+y*y+a*a},vec2.negate=function(out,a){return out[0]=-a[0],out[1]=-a[1],out[2]=-a[2],out},vec2.normalize=function(out,a){var x=a[0],y=a[1],z=a[2],x=x*x+y*y+z*z;return 0<x&&(x=1/Math.sqrt(x),out[0]=a[0]*x,out[1]=a[1]*x,out[2]=a[2]*x),out},vec2.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},vec2.cross=function(out,a,b){var ax=a[0],ay=a[1],a=a[2],bx=b[0],by=b[1],b=b[2];return out[0]=ay*b-a*by,out[1]=a*bx-ax*b,out[2]=ax*by-ay*bx,out},vec2.lerp=function(out,a,b,t){var ax=a[0],ay=a[1],a=a[2];return out[0]=ax+t*(b[0]-ax),out[1]=ay+t*(b[1]-ay),out[2]=a+t*(b[2]-a),out},vec2.transformMat4=function(out,a,m){var x=a[0],y=a[1],a=a[2];return out[0]=m[0]*x+m[4]*y+m[8]*a+m[12],out[1]=m[1]*x+m[5]*y+m[9]*a+m[13],out[2]=m[2]*x+m[6]*y+m[10]*a+m[14],out},vec2.transformQuat=function(out,a,q){var x=a[0],y=a[1],a=a[2],qx=q[0],qy=q[1],qz=q[2],q=q[3],ix=q*x+qy*a-qz*y,iy=q*y+qz*x-qx*a,iz=q*a+qx*y-qy*x,x=-qx*x-qy*y-qz*a;return out[0]=ix*q+x*-qx+iy*-qz-iz*-qy,out[1]=iy*q+x*-qy+iz*-qx-ix*-qz,out[2]=iz*q+x*-qz+ix*-qy-iy*-qx,out},vec2.forEach=function(){var vec=new Float32Array(3);return function(a,stride,offset,count,fn,arg){var i,l;for(stride=stride||3,offset=offset||0,l=count?Math.min(count*stride+offset,a.length):a.length,i=offset;i<l;i+=stride)vec[0]=a[i],vec[1]=a[i+1],vec[2]=a[i+2],fn(vec,vec,arg),a[i]=vec[0],a[i+1]=vec[1],a[i+2]=vec[2];return a}}(),vec2.str=function(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"},void 0!==exports&&(exports.vec3=vec2),{}),mat2=(GLMAT_EPSILON=GLMAT_EPSILON||1e-6,vec2.create=function(){return new Float32Array(4)},vec2.clone=function(a){var out=new Float32Array(4);return out[0]=a[0],out[1]=a[1],out[2]=a[2],out[3]=a[3],out},vec2.fromValues=function(x,y,z,w){var out=new Float32Array(4);return out[0]=x,out[1]=y,out[2]=z,out[3]=w,out},vec2.copy=function(out,a){return out[0]=a[0],out[1]=a[1],out[2]=a[2],out[3]=a[3],out},vec2.set=function(out,x,y,z,w){return out[0]=x,out[1]=y,out[2]=z,out[3]=w,out},vec2.add=function(out,a,b){return out[0]=a[0]+b[0],out[1]=a[1]+b[1],out[2]=a[2]+b[2],out[3]=a[3]+b[3],out},vec2.sub=vec2.subtract=function(out,a,b){return out[0]=a[0]-b[0],out[1]=a[1]-b[1],out[2]=a[2]-b[2],out[3]=a[3]-b[3],out},vec2.mul=vec2.multiply=function(out,a,b){return out[0]=a[0]*b[0],out[1]=a[1]*b[1],out[2]=a[2]*b[2],out[3]=a[3]*b[3],out},vec2.div=vec2.divide=function(out,a,b){return out[0]=a[0]/b[0],out[1]=a[1]/b[1],out[2]=a[2]/b[2],out[3]=a[3]/b[3],out},vec2.min=function(out,a,b){return out[0]=Math.min(a[0],b[0]),out[1]=Math.min(a[1],b[1]),out[2]=Math.min(a[2],b[2]),out[3]=Math.min(a[3],b[3]),out},vec2.max=function(out,a,b){return out[0]=Math.max(a[0],b[0]),out[1]=Math.max(a[1],b[1]),out[2]=Math.max(a[2],b[2]),out[3]=Math.max(a[3],b[3]),out},vec2.scale=function(out,a,b){return out[0]=a[0]*b,out[1]=a[1]*b,out[2]=a[2]*b,out[3]=a[3]*b,out},vec2.dist=vec2.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],b=b[3]-a[3];return Math.sqrt(x*x+y*y+z*z+b*b)},vec2.sqrDist=vec2.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],b=b[3]-a[3];return x*x+y*y+z*z+b*b},vec2.len=vec2.length=function(a){var x=a[0],y=a[1],z=a[2],a=a[3];return Math.sqrt(x*x+y*y+z*z+a*a)},vec2.sqrLen=vec2.squaredLength=function(a){var x=a[0],y=a[1],z=a[2],a=a[3];return x*x+y*y+z*z+a*a},vec2.negate=function(out,a){return out[0]=-a[0],out[1]=-a[1],out[2]=-a[2],out[3]=-a[3],out},vec2.normalize=function(out,a){var x=a[0],y=a[1],z=a[2],w=a[3],x=x*x+y*y+z*z+w*w;return 0<x&&(x=1/Math.sqrt(x),out[0]=a[0]*x,out[1]=a[1]*x,out[2]=a[2]*x,out[3]=a[3]*x),out},vec2.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},vec2.lerp=function(out,a,b,t){var ax=a[0],ay=a[1],az=a[2],a=a[3];return out[0]=ax+t*(b[0]-ax),out[1]=ay+t*(b[1]-ay),out[2]=az+t*(b[2]-az),out[3]=a+t*(b[3]-a),out},vec2.transformMat4=function(out,a,m){var x=a[0],y=a[1],z=a[2],a=a[3];return out[0]=m[0]*x+m[4]*y+m[8]*z+m[12]*a,out[1]=m[1]*x+m[5]*y+m[9]*z+m[13]*a,out[2]=m[2]*x+m[6]*y+m[10]*z+m[14]*a,out[3]=m[3]*x+m[7]*y+m[11]*z+m[15]*a,out},vec2.transformQuat=function(out,a,q){var x=a[0],y=a[1],a=a[2],qx=q[0],qy=q[1],qz=q[2],q=q[3],ix=q*x+qy*a-qz*y,iy=q*y+qz*x-qx*a,iz=q*a+qx*y-qy*x,x=-qx*x-qy*y-qz*a;return out[0]=ix*q+x*-qx+iy*-qz-iz*-qy,out[1]=iy*q+x*-qy+iz*-qx-ix*-qz,out[2]=iz*q+x*-qz+ix*-qy-iy*-qx,out},vec2.forEach=function(){var vec=new Float32Array(4);return function(a,stride,offset,count,fn,arg){var i,l;for(stride=stride||4,offset=offset||0,l=count?Math.min(count*stride+offset,a.length):a.length,i=offset;i<l;i+=stride)vec[0]=a[i],vec[1]=a[i+1],vec[2]=a[i+2],vec[3]=a[i+3],fn(vec,vec,arg),a[i]=vec[0],a[i+1]=vec[1],a[i+2]=vec[2],a[i+3]=vec[3];return a}}(),vec2.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},void 0!==exports&&(exports.vec4=vec2),{}),mat2Identity=new Float32Array([1,0,0,1]),mat2=(GLMAT_EPSILON=GLMAT_EPSILON||1e-6,mat2.create=function(){return new Float32Array(mat2Identity)},mat2.clone=function(a){var out=new Float32Array(4);return out[0]=a[0],out[1]=a[1],out[2]=a[2],out[3]=a[3],out},mat2.copy=function(out,a){return out[0]=a[0],out[1]=a[1],out[2]=a[2],out[3]=a[3],out},mat2.identity=function(out){return out[0]=1,out[1]=0,out[2]=0,out[3]=1,out},mat2.transpose=function(out,a){var a1;return out===a?(a1=a[1],out[1]=a[2],out[2]=a1):(out[0]=a[0],out[1]=a[2],out[2]=a[1],out[3]=a[3]),out},mat2.invert=function(out,a){var a0=a[0],a1=a[1],a2=a[2],a=a[3],det=a0*a-a2*a1;return det?(out[0]=a*(det=1/det),out[1]=-a1*det,out[2]=-a2*det,out[3]=a0*det,out):null},mat2.adjoint=function(out,a){var a0=a[0];return out[0]=a[3],out[1]=-a[1],out[2]=-a[2],out[3]=a0,out},mat2.determinant=function(a){return a[0]*a[3]-a[2]*a[1]},mat2.mul=mat2.multiply=function(out,a,b){var a0=a[0],a1=a[1],a2=a[2],a=a[3],b0=b[0],b1=b[1],b2=b[2],b=b[3];return out[0]=a0*b0+a1*b2,out[1]=a0*b1+a1*b,out[2]=a2*b0+a*b2,out[3]=a2*b1+a*b,out},mat2.rotate=function(out,a,rad){var a0=a[0],a1=a[1],a2=a[2],a=a[3],s=Math.sin(rad),rad=Math.cos(rad);return out[0]=a0*rad+a1*s,out[1]=a0*-s+a1*rad,out[2]=a2*rad+a*s,out[3]=a2*-s+a*rad,out},mat2.scale=function(out,a,v){var a0=a[0],a1=a[1],a2=a[2],a=a[3],v0=v[0],v=v[1];return out[0]=a0*v0,out[1]=a1*v,out[2]=a2*v0,out[3]=a*v,out},mat2.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},void 0!==exports&&(exports.mat2=mat2),{}),mat3Identity=new Float32Array([1,0,0,0,1,0,0,0,1]),mat4=(GLMAT_EPSILON=GLMAT_EPSILON||1e-6,mat2.create=function(){return new Float32Array(mat3Identity)},mat2.clone=function(a){var out=new Float32Array(9);return out[0]=a[0],out[1]=a[1],out[2]=a[2],out[3]=a[3],out[4]=a[4],out[5]=a[5],out[6]=a[6],out[7]=a[7],out[8]=a[8],out},mat2.copy=function(out,a){return out[0]=a[0],out[1]=a[1],out[2]=a[2],out[3]=a[3],out[4]=a[4],out[5]=a[5],out[6]=a[6],out[7]=a[7],out[8]=a[8],out},mat2.identity=function(out){return out[0]=1,out[1]=0,out[2]=0,out[3]=0,out[4]=1,out[5]=0,out[6]=0,out[7]=0,out[8]=1,out},mat2.transpose=function(out,a){var a01,a02,a12;return out===a?(a01=a[1],a02=a[2],a12=a[5],out[1]=a[3],out[2]=a[6],out[3]=a01,out[5]=a[7],out[6]=a02,out[7]=a12):(out[0]=a[0],out[1]=a[3],out[2]=a[6],out[3]=a[1],out[4]=a[4],out[5]=a[7],out[6]=a[2],out[7]=a[5],out[8]=a[8]),out},mat2.invert=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a=a[8],b01=a*a11-a12*a21,b11=-a*a10+a12*a20,b21=a21*a10-a11*a20,det=a00*b01+a01*b11+a02*b21;return det?(out[0]=b01*(det=1/det),out[1]=(-a*a01+a02*a21)*det,out[2]=(a12*a01-a02*a11)*det,out[3]=b11*det,out[4]=(a*a00-a02*a20)*det,out[5]=(-a12*a00+a02*a10)*det,out[6]=b21*det,out[7]=(-a21*a00+a01*a20)*det,out[8]=(a11*a00-a01*a10)*det,out):null},mat2.adjoint=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a=a[8];return out[0]=a11*a-a12*a21,out[1]=a02*a21-a01*a,out[2]=a01*a12-a02*a11,out[3]=a12*a20-a10*a,out[4]=a00*a-a02*a20,out[5]=a02*a10-a00*a12,out[6]=a10*a21-a11*a20,out[7]=a01*a20-a00*a21,out[8]=a00*a11-a01*a10,out},mat2.determinant=function(a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a=a[8];return a00*(a*a11-a12*a21)+a01*(-a*a10+a12*a20)+a02*(a21*a10-a11*a20)},mat2.mul=mat2.multiply=function(out,a,b){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a=a[8],b00=b[0],b01=b[1],b02=b[2],b10=b[3],b11=b[4],b12=b[5],b20=b[6],b21=b[7],b=b[8];return out[0]=b00*a00+b01*a10+b02*a20,out[1]=b00*a01+b01*a11+b02*a21,out[2]=b00*a02+b01*a12+b02*a,out[3]=b10*a00+b11*a10+b12*a20,out[4]=b10*a01+b11*a11+b12*a21,out[5]=b10*a02+b11*a12+b12*a,out[6]=b20*a00+b21*a10+b*a20,out[7]=b20*a01+b21*a11+b*a21,out[8]=b20*a02+b21*a12+b*a,out},mat2.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"},void 0!==exports&&(exports.mat3=mat2),{}),mat4Identity=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),mat2=(GLMAT_EPSILON=GLMAT_EPSILON||1e-6,mat4.create=function(){return new Float32Array(mat4Identity)},mat4.clone=function(a){var out=new Float32Array(16);return out[0]=a[0],out[1]=a[1],out[2]=a[2],out[3]=a[3],out[4]=a[4],out[5]=a[5],out[6]=a[6],out[7]=a[7],out[8]=a[8],out[9]=a[9],out[10]=a[10],out[11]=a[11],out[12]=a[12],out[13]=a[13],out[14]=a[14],out[15]=a[15],out},mat4.copy=function(out,a){return out[0]=a[0],out[1]=a[1],out[2]=a[2],out[3]=a[3],out[4]=a[4],out[5]=a[5],out[6]=a[6],out[7]=a[7],out[8]=a[8],out[9]=a[9],out[10]=a[10],out[11]=a[11],out[12]=a[12],out[13]=a[13],out[14]=a[14],out[15]=a[15],out},mat4.identity=function(out){return out[0]=1,out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[5]=1,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[10]=1,out[11]=0,out[12]=0,out[13]=0,out[14]=0,out[15]=1,out},mat4.transpose=function(out,a){var a01,a02,a03,a12,a13,a23;return out===a?(a01=a[1],a02=a[2],a03=a[3],a12=a[6],a13=a[7],a23=a[11],out[1]=a[4],out[2]=a[8],out[3]=a[12],out[4]=a01,out[6]=a[9],out[7]=a[13],out[8]=a02,out[9]=a12,out[11]=a[14],out[12]=a03,out[13]=a13,out[14]=a23):(out[0]=a[0],out[1]=a[4],out[2]=a[8],out[3]=a[12],out[4]=a[1],out[5]=a[5],out[6]=a[9],out[7]=a[13],out[8]=a[2],out[9]=a[6],out[10]=a[10],out[11]=a[14],out[12]=a[3],out[13]=a[7],out[14]=a[11],out[15]=a[15]),out},mat4.invert=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a-a23*a30,b09=a21*a32-a22*a31,b10=a21*a-a23*a31,b11=a22*a-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;return det?(out[0]=(a11*b11-a12*b10+a13*b09)*(det=1/det),out[1]=(a02*b10-a01*b11-a03*b09)*det,out[2]=(a31*b05-a32*b04+a*b03)*det,out[3]=(a22*b04-a21*b05-a23*b03)*det,out[4]=(a12*b08-a10*b11-a13*b07)*det,out[5]=(a00*b11-a02*b08+a03*b07)*det,out[6]=(a32*b02-a30*b05-a*b01)*det,out[7]=(a20*b05-a22*b02+a23*b01)*det,out[8]=(a10*b10-a11*b08+a13*b06)*det,out[9]=(a01*b08-a00*b10-a03*b06)*det,out[10]=(a30*b04-a31*b02+a*b00)*det,out[11]=(a21*b02-a20*b04-a23*b00)*det,out[12]=(a11*b07-a10*b09-a12*b06)*det,out[13]=(a00*b09-a01*b07+a02*b06)*det,out[14]=(a31*b01-a30*b03-a32*b00)*det,out[15]=(a20*b03-a21*b01+a22*b00)*det,out):null},mat4.adjoint=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a=a[15];return out[0]=a11*(a22*a-a23*a32)-a21*(a12*a-a13*a32)+a31*(a12*a23-a13*a22),out[1]=-(a01*(a22*a-a23*a32)-a21*(a02*a-a03*a32)+a31*(a02*a23-a03*a22)),out[2]=a01*(a12*a-a13*a32)-a11*(a02*a-a03*a32)+a31*(a02*a13-a03*a12),out[3]=-(a01*(a12*a23-a13*a22)-a11*(a02*a23-a03*a22)+a21*(a02*a13-a03*a12)),out[4]=-(a10*(a22*a-a23*a32)-a20*(a12*a-a13*a32)+a30*(a12*a23-a13*a22)),out[5]=a00*(a22*a-a23*a32)-a20*(a02*a-a03*a32)+a30*(a02*a23-a03*a22),out[6]=-(a00*(a12*a-a13*a32)-a10*(a02*a-a03*a32)+a30*(a02*a13-a03*a12)),out[7]=a00*(a12*a23-a13*a22)-a10*(a02*a23-a03*a22)+a20*(a02*a13-a03*a12),out[8]=a10*(a21*a-a23*a31)-a20*(a11*a-a13*a31)+a30*(a11*a23-a13*a21),out[9]=-(a00*(a21*a-a23*a31)-a20*(a01*a-a03*a31)+a30*(a01*a23-a03*a21)),out[10]=a00*(a11*a-a13*a31)-a10*(a01*a-a03*a31)+a30*(a01*a13-a03*a11),out[11]=-(a00*(a11*a23-a13*a21)-a10*(a01*a23-a03*a21)+a20*(a01*a13-a03*a11)),out[12]=-(a10*(a21*a32-a22*a31)-a20*(a11*a32-a12*a31)+a30*(a11*a22-a12*a21)),out[13]=a00*(a21*a32-a22*a31)-a20*(a01*a32-a02*a31)+a30*(a01*a22-a02*a21),out[14]=-(a00*(a11*a32-a12*a31)-a10*(a01*a32-a02*a31)+a30*(a01*a12-a02*a11)),out[15]=a00*(a11*a22-a12*a21)-a10*(a01*a22-a02*a21)+a20*(a01*a12-a02*a11),out},mat4.determinant=function(a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a=a[15];return(a00*a11-a01*a10)*(a22*a-a23*a32)-(a00*a12-a02*a10)*(a21*a-a23*a31)+(a00*a13-a03*a10)*(a21*a32-a22*a31)+(a01*a12-a02*a11)*(a20*a-a23*a30)-(a01*a13-a03*a11)*(a20*a32-a22*a30)+(a02*a13-a03*a12)*(a20*a31-a21*a30)},mat4.mul=mat4.multiply=function(out,a,b){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a=a[15],b0=b[0],b1=b[1],b2=b[2],b3=b[3];return out[0]=b0*a00+b1*a10+b2*a20+b3*a30,out[1]=b0*a01+b1*a11+b2*a21+b3*a31,out[2]=b0*a02+b1*a12+b2*a22+b3*a32,out[3]=b0*a03+b1*a13+b2*a23+b3*a,b0=b[4],b1=b[5],b2=b[6],b3=b[7],out[4]=b0*a00+b1*a10+b2*a20+b3*a30,out[5]=b0*a01+b1*a11+b2*a21+b3*a31,out[6]=b0*a02+b1*a12+b2*a22+b3*a32,out[7]=b0*a03+b1*a13+b2*a23+b3*a,b0=b[8],b1=b[9],b2=b[10],b3=b[11],out[8]=b0*a00+b1*a10+b2*a20+b3*a30,out[9]=b0*a01+b1*a11+b2*a21+b3*a31,out[10]=b0*a02+b1*a12+b2*a22+b3*a32,out[11]=b0*a03+b1*a13+b2*a23+b3*a,b0=b[12],b1=b[13],b2=b[14],b3=b[15],out[12]=b0*a00+b1*a10+b2*a20+b3*a30,out[13]=b0*a01+b1*a11+b2*a21+b3*a31,out[14]=b0*a02+b1*a12+b2*a22+b3*a32,out[15]=b0*a03+b1*a13+b2*a23+b3*a,out},mat4.translate=function(out,a,v){var a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23,x=v[0],y=v[1],v=v[2];return a===out?(out[12]=a[0]*x+a[4]*y+a[8]*v+a[12],out[13]=a[1]*x+a[5]*y+a[9]*v+a[13],out[14]=a[2]*x+a[6]*y+a[10]*v+a[14],out[15]=a[3]*x+a[7]*y+a[11]*v+a[15]):(a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],out[0]=a00,out[1]=a01,out[2]=a02,out[3]=a03,out[4]=a10,out[5]=a11,out[6]=a12,out[7]=a13,out[8]=a20,out[9]=a21,out[10]=a22,out[11]=a23,out[12]=a00*x+a10*y+a20*v+a[12],out[13]=a01*x+a11*y+a21*v+a[13],out[14]=a02*x+a12*y+a22*v+a[14],out[15]=a03*x+a13*y+a23*v+a[15]),out},mat4.scale=function(out,a,v){var x=v[0],y=v[1],v=v[2];return out[0]=a[0]*x,out[1]=a[1]*x,out[2]=a[2]*x,out[3]=a[3]*x,out[4]=a[4]*y,out[5]=a[5]*y,out[6]=a[6]*y,out[7]=a[7]*y,out[8]=a[8]*v,out[9]=a[9]*v,out[10]=a[10]*v,out[11]=a[11]*v,out[12]=a[12],out[13]=a[13],out[14]=a[14],out[15]=a[15],out},mat4.rotate=function(out,a,rad,axis){var t,a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23,b01,b10,b11,b12,b20,b21,b22,x=axis[0],y=axis[1],axis=axis[2],len=Math.sqrt(x*x+y*y+axis*axis);return Math.abs(len)<GLMAT_EPSILON?null:(x*=len=1/len,y*=len,axis*=len,len=Math.sin(rad),rad=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],b10=x*y*(t=1-rad)-axis*len,b11=y*y*t+rad,b12=axis*y*t+x*len,b20=x*axis*t+y*len,b21=y*axis*t-x*len,b22=axis*axis*t+rad,out[0]=a00*(rad=x*x*t+rad)+a10*(b01=y*x*t+axis*len)+a20*(axis=axis*x*t-y*len),out[1]=a01*rad+a11*b01+a21*axis,out[2]=a02*rad+a12*b01+a22*axis,out[3]=a03*rad+a13*b01+a23*axis,out[4]=a00*b10+a10*b11+a20*b12,out[5]=a01*b10+a11*b11+a21*b12,out[6]=a02*b10+a12*b11+a22*b12,out[7]=a03*b10+a13*b11+a23*b12,out[8]=a00*b20+a10*b21+a20*b22,out[9]=a01*b20+a11*b21+a21*b22,out[10]=a02*b20+a12*b21+a22*b22,out[11]=a03*b20+a13*b21+a23*b22,a!==out&&(out[12]=a[12],out[13]=a[13],out[14]=a[14],out[15]=a[15]),out)},mat4.rotateX=function(out,a,rad){var s=Math.sin(rad),rad=Math.cos(rad),a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11];return a!==out&&(out[0]=a[0],out[1]=a[1],out[2]=a[2],out[3]=a[3],out[12]=a[12],out[13]=a[13],out[14]=a[14],out[15]=a[15]),out[4]=a10*rad+a20*s,out[5]=a11*rad+a21*s,out[6]=a12*rad+a22*s,out[7]=a13*rad+a23*s,out[8]=a20*rad-a10*s,out[9]=a21*rad-a11*s,out[10]=a22*rad-a12*s,out[11]=a23*rad-a13*s,out},mat4.rotateY=function(out,a,rad){var s=Math.sin(rad),rad=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a20=a[8],a21=a[9],a22=a[10],a23=a[11];return a!==out&&(out[4]=a[4],out[5]=a[5],out[6]=a[6],out[7]=a[7],out[12]=a[12],out[13]=a[13],out[14]=a[14],out[15]=a[15]),out[0]=a00*rad-a20*s,out[1]=a01*rad-a21*s,out[2]=a02*rad-a22*s,out[3]=a03*rad-a23*s,out[8]=a00*s+a20*rad,out[9]=a01*s+a21*rad,out[10]=a02*s+a22*rad,out[11]=a03*s+a23*rad,out},mat4.rotateZ=function(out,a,rad){var s=Math.sin(rad),rad=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7];return a!==out&&(out[8]=a[8],out[9]=a[9],out[10]=a[10],out[11]=a[11],out[12]=a[12],out[13]=a[13],out[14]=a[14],out[15]=a[15]),out[0]=a00*rad+a10*s,out[1]=a01*rad+a11*s,out[2]=a02*rad+a12*s,out[3]=a03*rad+a13*s,out[4]=a10*rad-a00*s,out[5]=a11*rad-a01*s,out[6]=a12*rad-a02*s,out[7]=a13*rad-a03*s,out},mat4.fromRotationTranslation=function(out,q,v){var x=q[0],y=q[1],z=q[2],q=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,x=x*z2,yy=y*y2,y=y*z2,z=z*z2,x2=q*x2,y2=q*y2,q=q*z2;return out[0]=1-(yy+z),out[1]=xy+q,out[2]=x-y2,out[3]=0,out[4]=xy-q,out[5]=1-(xx+z),out[6]=y+x2,out[7]=0,out[8]=x+y2,out[9]=y-x2,out[10]=1-(xx+yy),out[11]=0,out[12]=v[0],out[13]=v[1],out[14]=v[2],out[15]=1,out},mat4.frustum=function(out,left,right,bottom,top,near,far){var rl=1/(right-left),tb=1/(top-bottom),nf=1/(near-far);return out[0]=2*near*rl,out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[5]=2*near*tb,out[6]=0,out[7]=0,out[8]=(right+left)*rl,out[9]=(top+bottom)*tb,out[10]=(far+near)*nf,out[11]=-1,out[12]=0,out[13]=0,out[14]=far*near*2*nf,out[15]=0,out},mat4.perspective=function(out,fovy,aspect,near,far){var fovy=1/Math.tan(fovy/2),nf=1/(near-far);return out[0]=fovy/aspect,out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[5]=fovy,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[10]=(far+near)*nf,out[11]=-1,out[12]=0,out[13]=0,out[14]=2*far*near*nf,out[15]=0,out},mat4.ortho=function(out,left,right,bottom,top,near,far){var lr=1/(left-right),bt=1/(bottom-top),nf=1/(near-far);return out[0]=-2*lr,out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[5]=-2*bt,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[10]=2*nf,out[11]=0,out[12]=(left+right)*lr,out[13]=(top+bottom)*bt,out[14]=(far+near)*nf,out[15]=1,out},mat4.lookAt=function(out,eye,center,up){var x0,y1,y2,len,eyex=eye[0],eyey=eye[1],eye=eye[2],upx=up[0],upy=up[1],up=up[2],centerx=center[0],centery=center[1],center=center[2];return Math.abs(eyex-centerx)<GLMAT_EPSILON&&Math.abs(eyey-centery)<GLMAT_EPSILON&&Math.abs(eye-center)<GLMAT_EPSILON?mat4.identity(out):(centerx=eyex-centerx,centery=eyey-centery,center=eye-center,x0=upy*(center*=len=1/Math.sqrt(centerx*centerx+centery*centery+center*center))-up*(centery*=len),up=up*(centerx*=len)-upx*center,upx=upx*centery-upy*centerx,(len=Math.sqrt(x0*x0+up*up+upx*upx))?(x0*=len=1/len,up*=len,upx*=len):upx=up=x0=0,upy=centery*upx-center*up,y1=center*x0-centerx*upx,y2=centerx*up-centery*x0,(len=Math.sqrt(upy*upy+y1*y1+y2*y2))?(upy*=len=1/len,y1*=len,y2*=len):y2=y1=upy=0,out[0]=x0,out[1]=upy,out[2]=centerx,out[3]=0,out[4]=up,out[5]=y1,out[6]=centery,out[7]=0,out[8]=upx,out[9]=y2,out[10]=center,out[11]=0,out[12]=-(x0*eyex+up*eyey+upx*eye),out[13]=-(upy*eyex+y1*eyey+y2*eye),out[14]=-(centerx*eyex+centery*eyey+center*eye),out[15]=1,out)},mat4.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"},void 0!==exports&&(exports.mat4=mat4),{}),quatIdentity=new Float32Array([0,0,0,1]);GLMAT_EPSILON=GLMAT_EPSILON||1e-6,mat2.create=function(){return new Float32Array(quatIdentity)},mat2.clone=vec2.clone,mat2.fromValues=vec2.fromValues,mat2.copy=vec2.copy,mat2.set=vec2.set,mat2.identity=function(out){return out[0]=0,out[1]=0,out[2]=0,out[3]=1,out},mat2.setAxisAngle=function(out,axis,rad){rad*=.5;var s=Math.sin(rad);return out[0]=s*axis[0],out[1]=s*axis[1],out[2]=s*axis[2],out[3]=Math.cos(rad),out},mat2.add=vec2.add,mat2.mul=mat2.multiply=function(out,a,b){var ax=a[0],ay=a[1],az=a[2],a=a[3],bx=b[0],by=b[1],bz=b[2],b=b[3];return out[0]=ax*b+a*bx+ay*bz-az*by,out[1]=ay*b+a*by+az*bx-ax*bz,out[2]=az*b+a*bz+ax*by-ay*bx,out[3]=a*b-ax*bx-ay*by-az*bz,out},mat2.scale=vec2.scale,mat2.rotateX=function(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],a=a[3],bx=Math.sin(rad),rad=Math.cos(rad);return out[0]=ax*rad+a*bx,out[1]=ay*rad+az*bx,out[2]=az*rad-ay*bx,out[3]=a*rad-ax*bx,out},mat2.rotateY=function(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],a=a[3],by=Math.sin(rad),rad=Math.cos(rad);return out[0]=ax*rad-az*by,out[1]=ay*rad+a*by,out[2]=az*rad+ax*by,out[3]=a*rad-ay*by,out},mat2.rotateZ=function(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],a=a[3],bz=Math.sin(rad),rad=Math.cos(rad);return out[0]=ax*rad+ay*bz,out[1]=ay*rad-ax*bz,out[2]=az*rad+a*bz,out[3]=a*rad-az*bz,out},mat2.calculateW=function(out,a){var x=a[0],y=a[1],a=a[2];return out[0]=x,out[1]=y,out[2]=a,out[3]=-Math.sqrt(Math.abs(1-x*x-y*y-a*a)),out},mat2.dot=vec2.dot,mat2.lerp=vec2.lerp,mat2.slerp=function(out,a,b,t){var ratioA,ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],b=b[2],bw=a[3],cosHalfTheta=ax*bx+ay*by+az*b+aw*bw;return 1<=Math.abs(cosHalfTheta)?out!==a&&(out[0]=ax,out[1]=ay,out[2]=az,out[3]=aw):(a=Math.acos(cosHalfTheta),cosHalfTheta=Math.sqrt(1-cosHalfTheta*cosHalfTheta),Math.abs(cosHalfTheta)<.001?(out[0]=.5*ax+.5*bx,out[1]=.5*ay+.5*by,out[2]=.5*az+.5*b,out[3]=.5*aw+.5*bw):(ratioA=Math.sin((1-t)*a)/cosHalfTheta,t=Math.sin(t*a)/cosHalfTheta,out[0]=ax*ratioA+bx*t,out[1]=ay*ratioA+by*t,out[2]=az*ratioA+b*t,out[3]=aw*ratioA+bw*t)),out},mat2.invert=function(out,a){var a0=a[0],a1=a[1],a2=a[2],a=a[3],dot=a0*a0+a1*a1+a2*a2+a*a,dot=dot?1/dot:0;return out[0]=-a0*dot,out[1]=-a1*dot,out[2]=-a2*dot,out[3]=a*dot,out},mat2.conjugate=function(out,a){return out[0]=-a[0],out[1]=-a[1],out[2]=-a[2],out[3]=a[3],out},mat2.len=mat2.length=vec2.length,mat2.sqrLen=mat2.squaredLength=vec2.squaredLength,mat2.normalize=vec2.normalize,mat2.str=function(a){return"quat("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},void 0!==exports&&(exports.quat=mat2)}(shim.exports)}(),Class.extend({init:function(objectOrArray){if(objectOrArray instanceof Object){var i,object=objectOrArray;for(i in this.data=[],object)this.data.push(object[i])}else{if(!(objectOrArray instanceof Array))throw"Argument objectOrArray must be an object or array";this.data=objectOrArray}},get:function(){return this.data},sort:function(callback){return this.data.sort(function(a,b){return callback(a,b)?1:callback(b,a)?-1:0}),this.data}})),Color=function(r,g,b,a){this.r=1,this.g=1,this.b=1,this.a=1,this.clone=function(){return new Color(this.r,this.g,this.b,this.a)},this.fromHex=function(hex){hex=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})?$/i.exec(hex);return hex&&(this.r=parseInt(hex[1],16)/255,this.g=parseInt(hex[2],16)/255,this.b=parseInt(hex[3],16)/255,hex[4])&&(this.a=parseInt(hex[4],16)/255),this},this.toHex=function(){function componentToHex(v){return 1==(v=v.toString(16)).length?"0"+v:v}return"#"+componentToHex(255*this.r)+componentToHex(255*this.g)+componentToHex(255*this.b)+componentToHex(255*this.a)},this.toString=function(){return"rgba("+Math.floor(255*this.r)+", "+Math.floor(255*this.g)+", "+Math.floor(255*this.b)+", "+this.a+")"},this.toVector=function(){return vec4.fromValues(this.r,this.g,this.b,this.a)},this.set=function(r,g,b,a){"number"==typeof r&&(this.r=r),"number"==typeof g&&(this.g=g),"number"==typeof b&&(this.b=b),"number"==typeof a&&(this.a=a)},this.set(r,g,b,a)};function Rectangle(_x,_y,_width,_height){this.x=_x,this.y=_y,this.width=_width,this.height=_height,this.intersects=function(other){return!(other.x>this.x+this.width||other.x+other.width<this.x||other.y>this.y+this.height||other.y+other.height<this.y)}}var WayfinderAPI={LOCATION:"//api.3dwayfinder.com/",LIVE_LOCATION:"//api.3dwayfinder.com/",PROJECT:!1,LIVE:!1,getLOCATION(live){return live||WayfinderAPI.LIVE?WayfinderAPI.LIVE_LOCATION:WayfinderAPI.LOCATION},getJSON:function(url,callback){Logistics.getJSON(url,callback).error(function(info){console&&console.log&&console.log("Failed to get JSON: "+JSON.stringify(info))})},getURL:function(classname,method,args,live){if(!1===WayfinderAPI.PROJECT)throw"No project opened! Call WayfinderAPI.open(<project name>);";return args=args||[],[WayfinderAPI.getLOCATION(live),"public",WayfinderAPI.PROJECT,classname,method].concat(args).join("/")},open:function(project){WayfinderAPI.PROJECT=project},"2d":{},"3d":{},access:{},advertisements:{},beacons:{},building:{},guitranslations:{},images:{},kiosks:{},languages:{},lights:{},locationgroups:{},locations:{},materials:{},mobile:{},models:{},navigation:{},poisettings:{},pages:{},svg:{},settings:{},snapshot:{},statistics:{},templates:{},textures:{}},DeviceFactory=(WayfinderAPI["2d"].bundle=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("2d","bundle",[],live),callback)},WayfinderAPI["2d"].bundle.url=function(){return WayfinderAPI.getURL("2d","bundle",Array.prototype.slice.call(arguments,0))},WayfinderAPI["2d"].edges=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("2d","edges",[],live),callback)},WayfinderAPI["2d"].edges.url=function(){return WayfinderAPI.getURL("2d","edges",Array.prototype.slice.call(arguments,0))},WayfinderAPI["2d"].getWatermark=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("2d","getWatermark",[],live),callback)},WayfinderAPI["2d"].getWatermark.url=function(){return WayfinderAPI.getURL("2d","getWatermark",Array.prototype.slice.call(arguments,0))},WayfinderAPI["2d"].image=function(level_id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("2d","image",[level_id],live),callback)},WayfinderAPI["2d"].image.url=function(level_id){return WayfinderAPI.getURL("2d","image",Array.prototype.slice.call(arguments,0))},WayfinderAPI["2d"].lod=function(level_id,lod,x,y,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("2d","lod",[level_id,lod,x,y],live),callback)},WayfinderAPI["2d"].lod.url=function(level_id,lod,x,y){return WayfinderAPI.getURL("2d","lod",Array.prototype.slice.call(arguments,0))},WayfinderAPI["2d"].lodcount=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("2d","lodcount",[],live),callback)},WayfinderAPI["2d"].lodcount.url=function(){return WayfinderAPI.getURL("2d","lodcount",Array.prototype.slice.call(arguments,0))},WayfinderAPI["2d"].nodes=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("2d","nodes",[],live),callback)},WayfinderAPI["2d"].nodes.url=function(){return WayfinderAPI.getURL("2d","nodes",Array.prototype.slice.call(arguments,0))},WayfinderAPI["2d"].overlays=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("2d","overlays",[],live),callback)},WayfinderAPI["2d"].overlays.url=function(){return WayfinderAPI.getURL("2d","overlays",Array.prototype.slice.call(arguments,0))},WayfinderAPI["2d"].pack=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("2d","pack",[],live),callback)},WayfinderAPI["2d"].pack.url=function(){return WayfinderAPI.getURL("2d","pack",Array.prototype.slice.call(arguments,0))},WayfinderAPI["3d"].getWatermark=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("3d","getWatermark",[],live),callback)},WayfinderAPI["3d"].getWatermark.url=function(){return WayfinderAPI.getURL("3d","getWatermark",Array.prototype.slice.call(arguments,0))},WayfinderAPI["3d"].pack=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("3d","pack",[],live),callback)},WayfinderAPI["3d"].pack.url=function(){return WayfinderAPI.getURL("3d","pack",Array.prototype.slice.call(arguments,0))},WayfinderAPI["3d"].scene=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("3d","scene",[],live),callback)},WayfinderAPI["3d"].scene.url=function(){return WayfinderAPI.getURL("3d","scene",Array.prototype.slice.call(arguments,0))},WayfinderAPI.access.hasWatermark=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("access","hasWatermark",[],live),callback)},WayfinderAPI.access.hasWatermark.url=function(){return WayfinderAPI.getURL("access","hasWatermark",Array.prototype.slice.call(arguments,0))},WayfinderAPI.access.template=function(templateName,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("access","template",[templateName],live),callback)},WayfinderAPI.access.template.url=function(templateName){return WayfinderAPI.getURL("access","template",Array.prototype.slice.call(arguments,0))},WayfinderAPI.advertisements.all=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("advertisements","all",[],live),callback)},WayfinderAPI.advertisements.all.url=function(){return WayfinderAPI.getURL("advertisements","all",Array.prototype.slice.call(arguments,0))},WayfinderAPI.advertisements.data=function(id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("advertisements","data",[id],live),callback)},WayfinderAPI.advertisements.data.url=function(id){return WayfinderAPI.getURL("advertisements","data",Array.prototype.slice.call(arguments,0))},WayfinderAPI.advertisements.frames=function(template_id,container_id,check_time,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("advertisements","frames",[template_id,container_id,check_time],live),callback)},WayfinderAPI.advertisements.frames.url=function(template_id,container_id,check_time){return WayfinderAPI.getURL("advertisements","frames",Array.prototype.slice.call(arguments,0))},WayfinderAPI.beacons.getBeacon=function(id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("beacons","getBeacon",[id],live),callback)},WayfinderAPI.beacons.getBeacon.url=function(id){return WayfinderAPI.getURL("beacons","getBeacon",Array.prototype.slice.call(arguments,0))},WayfinderAPI.beacons.getBeacons=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("beacons","getBeacons",[],live),callback)},WayfinderAPI.beacons.getBeacons.url=function(){return WayfinderAPI.getURL("beacons","getBeacons",Array.prototype.slice.call(arguments,0))},WayfinderAPI.building.levels=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("building","levels",[],live),callback)},WayfinderAPI.building.levels.url=function(){return WayfinderAPI.getURL("building","levels",Array.prototype.slice.call(arguments,0))},WayfinderAPI.building.location=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("building","location",[],live),callback)},WayfinderAPI.building.location.url=function(){return WayfinderAPI.getURL("building","location",Array.prototype.slice.call(arguments,0))},WayfinderAPI.building.pack=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("building","pack",[],live),callback)},WayfinderAPI.building.pack.url=function(){return WayfinderAPI.getURL("building","pack",Array.prototype.slice.call(arguments,0))},WayfinderAPI.guitranslations.get=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("guitranslations","get",[],live),callback)},WayfinderAPI.guitranslations.get.url=function(){return WayfinderAPI.getURL("guitranslations","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.images.checkImage=function(id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("images","checkImage",[id],live),callback)},WayfinderAPI.images.checkImage.url=function(id){return WayfinderAPI.getURL("images","checkImage",Array.prototype.slice.call(arguments,0))},WayfinderAPI.images.get=function(id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("images","get",[id],live),callback)},WayfinderAPI.images.get.url=function(id){return WayfinderAPI.getURL("images","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.images.thumbnail=function(id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("images","thumbnail",[id],live),callback)},WayfinderAPI.images.thumbnail.url=function(id){return WayfinderAPI.getURL("images","thumbnail",Array.prototype.slice.call(arguments,0))},WayfinderAPI.kiosks.all=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("kiosks","all",[],live),callback)},WayfinderAPI.kiosks.all.url=function(){return WayfinderAPI.getURL("kiosks","all",Array.prototype.slice.call(arguments,0))},WayfinderAPI.kiosks.start=function(kioskId,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("kiosks","start",[kioskId],live),callback)},WayfinderAPI.kiosks.start.url=function(kioskId){return WayfinderAPI.getURL("kiosks","start",Array.prototype.slice.call(arguments,0))},WayfinderAPI.languages.get=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("languages","get",[],live),callback)},WayfinderAPI.languages.get.url=function(){return WayfinderAPI.getURL("languages","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.languages.translation=function(id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("languages","translation",[id],live),callback)},WayfinderAPI.languages.translation.url=function(id){return WayfinderAPI.getURL("languages","translation",Array.prototype.slice.call(arguments,0))},WayfinderAPI.lights.get=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("lights","get",[],live),callback)},WayfinderAPI.lights.get.url=function(){return WayfinderAPI.getURL("lights","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.locationgroups.get=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("locationgroups","get",[],live),callback)},WayfinderAPI.locationgroups.get.url=function(){return WayfinderAPI.getURL("locationgroups","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.locations.byfloor=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("locations","byfloor",[],live),callback)},WayfinderAPI.locations.byfloor.url=function(){return WayfinderAPI.getURL("locations","byfloor",Array.prototype.slice.call(arguments,0))},WayfinderAPI.locations.bygroup=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("locations","bygroup",[],live),callback)},WayfinderAPI.locations.bygroup.url=function(){return WayfinderAPI.getURL("locations","bygroup",Array.prototype.slice.call(arguments,0))},WayfinderAPI.locations.bynode=function(node_id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("locations","bynode",[node_id],live),callback)},WayfinderAPI.locations.bynode.url=function(node_id){return WayfinderAPI.getURL("locations","bynode",Array.prototype.slice.call(arguments,0))},WayfinderAPI.locations.get=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("locations","get",[],live),callback)},WayfinderAPI.locations.get.url=function(){return WayfinderAPI.getURL("locations","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.locations.location=function(poi_id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("locations","location",[poi_id],live),callback)},WayfinderAPI.locations.location.url=function(poi_id){return WayfinderAPI.getURL("locations","location",Array.prototype.slice.call(arguments,0))},WayfinderAPI.locations.tags=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("locations","tags",[],live),callback)},WayfinderAPI.locations.tags.url=function(){return WayfinderAPI.getURL("locations","tags",Array.prototype.slice.call(arguments,0))},WayfinderAPI.materials.get=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("materials","get",[],live),callback)},WayfinderAPI.materials.get.url=function(){return WayfinderAPI.getURL("materials","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.materials.textureMaterialNames=function(names,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("materials","textureMaterialNames",[names],live),callback)},WayfinderAPI.materials.textureMaterialNames.url=function(names){return WayfinderAPI.getURL("materials","textureMaterialNames",Array.prototype.slice.call(arguments,0))},WayfinderAPI.materials.textures=function(materialName,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("materials","textures",[materialName],live),callback)},WayfinderAPI.materials.textures.url=function(materialName){return WayfinderAPI.getURL("materials","textures",Array.prototype.slice.call(arguments,0))},WayfinderAPI.materials.uniforms=function(materialName,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("materials","uniforms",[materialName],live),callback)},WayfinderAPI.materials.uniforms.url=function(materialName){return WayfinderAPI.getURL("materials","uniforms",Array.prototype.slice.call(arguments,0))},WayfinderAPI.mobile.bundle=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("mobile","bundle",[],live),callback)},WayfinderAPI.mobile.bundle.url=function(){return WayfinderAPI.getURL("mobile","bundle",Array.prototype.slice.call(arguments,0))},WayfinderAPI.models.all=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("models","all",[],live),callback)},WayfinderAPI.models.all.url=function(){return WayfinderAPI.getURL("models","all",Array.prototype.slice.call(arguments,0))},WayfinderAPI.models.allmeshes=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("models","allmeshes",[],live),callback)},WayfinderAPI.models.allmeshes.url=function(){return WayfinderAPI.getURL("models","allmeshes",Array.prototype.slice.call(arguments,0))},WayfinderAPI.models.get=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("models","get",[],live),callback)},WayfinderAPI.models.get.url=function(){return WayfinderAPI.getURL("models","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.models.instances=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("models","instances",[],live),callback)},WayfinderAPI.models.instances.url=function(){return WayfinderAPI.getURL("models","instances",Array.prototype.slice.call(arguments,0))},WayfinderAPI.models.json=function(model_id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("models","json",[model_id],live),callback)},WayfinderAPI.models.json.url=function(model_id){return WayfinderAPI.getURL("models","json",Array.prototype.slice.call(arguments,0))},WayfinderAPI.models.meshes=function(model_id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("models","meshes",[model_id],live),callback)},WayfinderAPI.models.meshes.url=function(model_id){return WayfinderAPI.getURL("models","meshes",Array.prototype.slice.call(arguments,0))},WayfinderAPI.models.meshesOfInstances=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("models","meshesOfInstances",[],live),callback)},WayfinderAPI.models.meshesOfInstances.url=function(){return WayfinderAPI.getURL("models","meshesOfInstances",Array.prototype.slice.call(arguments,0))},WayfinderAPI.models.meshesbyfloor=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("models","meshesbyfloor",[],live),callback)},WayfinderAPI.models.meshesbyfloor.url=function(){return WayfinderAPI.getURL("models","meshesbyfloor",Array.prototype.slice.call(arguments,0))},WayfinderAPI.models.model=function(model_id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("models","model",[model_id],live),callback)},WayfinderAPI.models.model.url=function(model_id){return WayfinderAPI.getURL("models","model",Array.prototype.slice.call(arguments,0))},WayfinderAPI.navigation.allAttributes=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("navigation","allAttributes",[],live),callback)},WayfinderAPI.navigation.allAttributes.url=function(){return WayfinderAPI.getURL("navigation","allAttributes",Array.prototype.slice.call(arguments,0))},WayfinderAPI.navigation.attributes=function(id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("navigation","attributes",[id],live),callback)},WayfinderAPI.navigation.attributes.url=function(id){return WayfinderAPI.getURL("navigation","attributes",Array.prototype.slice.call(arguments,0))},WayfinderAPI.navigation.edges=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("navigation","edges",[],live),callback)},WayfinderAPI.navigation.edges.url=function(){return WayfinderAPI.getURL("navigation","edges",Array.prototype.slice.call(arguments,0))},WayfinderAPI.navigation.node=function(id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("navigation","node",[id],live),callback)},WayfinderAPI.navigation.node.url=function(id){return WayfinderAPI.getURL("navigation","node",Array.prototype.slice.call(arguments,0))},WayfinderAPI.navigation.nodes=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("navigation","nodes",[],live),callback)},WayfinderAPI.navigation.nodes.url=function(){return WayfinderAPI.getURL("navigation","nodes",Array.prototype.slice.call(arguments,0))},WayfinderAPI.navigation.nodesbytype=function(type,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("navigation","nodesbytype",[type],live),callback)},WayfinderAPI.navigation.nodesbytype.url=function(type){return WayfinderAPI.getURL("navigation","nodesbytype",Array.prototype.slice.call(arguments,0))},WayfinderAPI.poisettings.get=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("poisettings","get",[],live),callback)},WayfinderAPI.poisettings.get.url=function(){return WayfinderAPI.getURL("poisettings","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.poisettings.getAllPOISettings=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("poisettings","getAllPOISettings",[],live),callback)},WayfinderAPI.poisettings.getAllPOISettings.url=function(){return WayfinderAPI.getURL("poisettings","getAllPOISettings",Array.prototype.slice.call(arguments,0))},WayfinderAPI.poisettings.getText=function(key,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("poisettings","getText",[key],live),callback)},WayfinderAPI.poisettings.getText.url=function(key){return WayfinderAPI.getURL("poisettings","getText",Array.prototype.slice.call(arguments,0))},WayfinderAPI.poisettings.getTexts=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("poisettings","getTexts",[],live),callback)},WayfinderAPI.poisettings.getTexts.url=function(){return WayfinderAPI.getURL("poisettings","getTexts",Array.prototype.slice.call(arguments,0))},WayfinderAPI.poisettings.map=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("poisettings","map",[],live),callback)},WayfinderAPI.poisettings.map.url=function(){return WayfinderAPI.getURL("poisettings","map",Array.prototype.slice.call(arguments,0))},WayfinderAPI.poisettings.setting=function(key,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("poisettings","setting",[key],live),callback)},WayfinderAPI.poisettings.setting.url=function(key){return WayfinderAPI.getURL("poisettings","setting",Array.prototype.slice.call(arguments,0))},WayfinderAPI.pages.getAll=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("pages","getAll",[],live),callback)},WayfinderAPI.pages.getAll.url=function(){return WayfinderAPI.getURL("pages","getAll",Array.prototype.slice.call(arguments,0))},WayfinderAPI.svg.bundle=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("svg","bundle",[],live),callback)},WayfinderAPI.svg.bundle.url=function(){return WayfinderAPI.getURL("svg","bundle",Array.prototype.slice.call(arguments,0))},WayfinderAPI.svg.get=function(id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("svg","get",[id],live),callback)},WayfinderAPI.svg.get.url=function(id){return WayfinderAPI.getURL("svg","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.svg.getBuilding=function(id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("svg","getBuilding",[id],live),callback)},WayfinderAPI.svg.getBuilding.url=function(id){return WayfinderAPI.getURL("svg","getBuilding",Array.prototype.slice.call(arguments,0))},WayfinderAPI.settings.get=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("settings","get",[],live),callback)},WayfinderAPI.settings.get.url=function(){return WayfinderAPI.getURL("settings","get",Array.prototype.slice.call(arguments,0))},WayfinderAPI.settings.getText=function(key,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("settings","getText",[key],live),callback)},WayfinderAPI.settings.getText.url=function(key){return WayfinderAPI.getURL("settings","getText",Array.prototype.slice.call(arguments,0))},WayfinderAPI.settings.getTexts=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("settings","getTexts",[],live),callback)},WayfinderAPI.settings.getTexts.url=function(){return WayfinderAPI.getURL("settings","getTexts",Array.prototype.slice.call(arguments,0))},WayfinderAPI.settings.map=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("settings","map",[],live),callback)},WayfinderAPI.settings.map.url=function(){return WayfinderAPI.getURL("settings","map",Array.prototype.slice.call(arguments,0))},WayfinderAPI.settings.setting=function(key,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("settings","setting",[key],live),callback)},WayfinderAPI.settings.setting.url=function(key){return WayfinderAPI.getURL("settings","setting",Array.prototype.slice.call(arguments,0))},WayfinderAPI.snapshot.current=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("snapshot","current",[],live),callback)},WayfinderAPI.snapshot.current.url=function(){return WayfinderAPI.getURL("snapshot","current",Array.prototype.slice.call(arguments,0))},WayfinderAPI.snapshot.getLatestId=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("snapshot","getLatestId",[],live),callback)},WayfinderAPI.snapshot.getLatestId.url=function(){return WayfinderAPI.getURL("snapshot","getLatestId",Array.prototype.slice.call(arguments,0))},WayfinderAPI.statistics.click=function(data,session_id,type,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("statistics","click",[data,session_id,type],live),callback)},WayfinderAPI.statistics.click.url=function(data,session_id,type){return WayfinderAPI.getURL("statistics","click",Array.prototype.slice.call(arguments,0))},WayfinderAPI.statistics.device=function(width,height,kiosk,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("statistics","device",[width,height,kiosk],live),callback)},WayfinderAPI.statistics.device.url=function(width,height,kiosk){return WayfinderAPI.getURL("statistics","device",Array.prototype.slice.call(arguments,0))},WayfinderAPI.statistics.endSession=function(session_id,language_id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("statistics","endSession",[session_id,language_id],live),callback)},WayfinderAPI.statistics.endSession.url=function(session_id,language_id){return WayfinderAPI.getURL("statistics","endSession",Array.prototype.slice.call(arguments,0))},WayfinderAPI.statistics.search=function(data,session_id,type,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("statistics","search",[data,session_id,type],live),callback)},WayfinderAPI.statistics.search.url=function(data,session_id,type){return WayfinderAPI.getURL("statistics","search",Array.prototype.slice.call(arguments,0))},WayfinderAPI.statistics.startSession=function(language_id,kiosk,application,layout,device_id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("statistics","startSession",[language_id,kiosk,application,layout,device_id],live),callback)},WayfinderAPI.statistics.startSession.url=function(language_id,kiosk,application,layout,device_id){return WayfinderAPI.getURL("statistics","startSession",Array.prototype.slice.call(arguments,0))},WayfinderAPI.templates.css=function(template_id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("templates","css",[template_id],live),callback)},WayfinderAPI.templates.css.url=function(template_id){return WayfinderAPI.getURL("templates","css",Array.prototype.slice.call(arguments,0))},WayfinderAPI.textures.count=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("textures","count",[],live),callback)},WayfinderAPI.textures.count.url=function(){return WayfinderAPI.getURL("textures","count",Array.prototype.slice.call(arguments,0))},WayfinderAPI.textures.map=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("textures","map",[],live),callback)},WayfinderAPI.textures.map.url=function(){return WayfinderAPI.getURL("textures","map",Array.prototype.slice.call(arguments,0))},WayfinderAPI.textures.mipmap=function(level,name,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("textures","mipmap",[level,name],live),callback)},WayfinderAPI.textures.mipmap.url=function(level,name){return WayfinderAPI.getURL("textures","mipmap",Array.prototype.slice.call(arguments,0))},WayfinderAPI.textures.names=function(callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("textures","names",[],live),callback)},WayfinderAPI.textures.names.url=function(){return WayfinderAPI.getURL("textures","names",Array.prototype.slice.call(arguments,0))},WayfinderAPI.textures.texture=function(name,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("textures","texture",[name],live),callback)},WayfinderAPI.textures.texture.url=function(name){return WayfinderAPI.getURL("textures","texture",Array.prototype.slice.call(arguments,0))},WayfinderAPI.textures.texturebyid=function(texture_id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("textures","texturebyid",[texture_id],live),callback)},WayfinderAPI.textures.texturebyid.url=function(texture_id){return WayfinderAPI.getURL("textures","texturebyid",Array.prototype.slice.call(arguments,0))},WayfinderAPI.textures.thumbnail=function(name,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("textures","thumbnail",[name],live),callback)},WayfinderAPI.textures.thumbnail.url=function(name){return WayfinderAPI.getURL("textures","thumbnail",Array.prototype.slice.call(arguments,0))},WayfinderAPI.textures.thumbnailbyid=function(texture_id,callback,live){WayfinderAPI.getJSON(WayfinderAPI.getURL("textures","thumbnailbyid",[texture_id],live),callback)},WayfinderAPI.textures.thumbnailbyid.url=function(texture_id){return WayfinderAPI.getURL("textures","thumbnailbyid",Array.prototype.slice.call(arguments,0))},{init:function(){},getDevice:function(wayfinder){if(!this.isCordova())return"undefined"!=typeof navigator?new Device(wayfinder,navigator.userAgent,navigator.platform,"",""):"undefined"!=typeof Qt?new QtDevice(wayfinder,Qt):new Device(wayfinder,"unknown","unknown","","");var device=window.device;switch(device.platform){case"Android":return new AndroidDevice(wayfinder,device.name,device.platform,device.uuid,device.version);case"iPhone":case"iOS":return new iOSDevice(wayfinder,device.name,device.platform,device.uuid,device.version);default:return new Device(wayfinder,navigator.userAgent,navigator.platform,"","")}},isCordova:function(){if("undefined"!=typeof window)for(var cordovas=[window.cordova,window.device,window.PhoneGap,window.phonegap],i=0;i<cordovas.length;i++)if(cordovas[i])return cordovas[i];return!1},checkClass:function(){return"function"==typeof class_a}}),Device=Class.extend({init:function(wayfinder,name,platform,uuid,version){this.wayfinder=wayfinder,this.name=name,this.platform=platform,this.uuid=uuid,this.version=version,this.locationManager,console.log("Device",typeof LocationManager),"function"==typeof LocationManager&&(this.locationManager=new LocationManager(this.wayfinder),this.locationManager.cbOnLocationChange=ClassCallback(this,this.onLocationChange)),this.broadcastChannel,this.setup()},cbOnPause:function(){},cbOnRasume:function(){},setup:function(){var scope;BroadcastChannel&&("object"==typeof WayfinderChannel?this.broadcastChannel=WayfinderChannel:this.broadcastChannel=new BroadcastChannel("WayfinderChannel"),(scope=this).wayfinder.events.on("any",function(){var msg;scope.broadcastChannel&&(msg=JSON.stringify(Array.from(arguments),function(k,v){return k&&v&&"number"!=typeof v?Array.isArray(v)?"[object Array]":""+v:v}),scope.broadcastChannel.postMessage(msg))}))},openMaps:function(latitude,longitude,zoom){window.open("https://maps.google.com/maps?q="+latitude+","+longitude+"&z="+zoom)},openMapsWidthAddress:function(address,zoom){window.open("https://maps.google.com/maps?q="+address+"&z="+zoom)},openURL:function(url){window.open(url,"_blank")},trackEvent:function(category,action,label,id){},isWIFITurnedOn:function(){return!0},isBluetoothEnabled:function(){return new Promise(function(resolve,reject){reject(new Error("No bluetooth"))})},enableBluetooth:function(){},startRangingBeacons:function(){},locationAcquired:function(status){status?this.wayfinder.events.trigger("location-success"):this.wayfinder.events.trigger("location-failed")},startGeoLocating:function(){this.locationManager&&(this.wayfinder.events.trigger("location-start"),this.locationManager.addProvider("gps",GeolocationProvider,this,this.wayfinder.building),this.locationManager.start(ClassCallback(this,this.locationAcquired)))},startBeaconLocating:function(){this.locationManager&&(this.locationManager.hasProvider("ble")||this.locationManager.addProvider("ble",BeaconProvider,this.device,this.wayfinder.mobileLogic.mobileData.ibeacons,this.wayfinder.nodes),this.locationManager.isStarted()||(this.locationManager.start(ClassCallback(this,this.locationAcquired)),this.wayfinder.events.trigger("location-start")))},stopLocating:function(){console.log("stopLocating"),this.locationManager&&(this.wayfinder.events.trigger("location-stop"),this.locationManager.stop(ClassCallback(this,this.locationAcquired)))},onLocationChange:function(location,count){this.wayfinder.logic.onLocationChange(location),console.log("onLocationChange",count),0===count&&this.wayfinder.events.trigger("location-success")},setStatusBarColor:function(color){},addGeofencing:function(fence,success,error){},createEvent:function(calendarName,title,location,notes,startDate,endDate,success,error){console.log("Device.createEvent")},getSystemLanguage:function(){var userLang=this.wayfinder.device.getSystemLanguage();"string"==typeof userLang&&0<userLang.length&&(userLang=userLang.split("-"),this.wayfinder.languages[userLang[0]])&&this.wayfinder.setLanguage(userLang[0])},exit:function(){},initPushNotifications:function(deviceID,callback,notificationCallback){},getLocationFailCount:function(){return this.wayfinder.device.locationManager.getFailCount()},isPaused:function(){return this.wayfinder.device.paused},onEvent:function(){}}),WayfinderOptions=Class.extend({init:function(){this.application="wayfinder",this.map="map",this.project="demo",this.kiosk=!1,this.debugLog=!1,this.debugPOIs=!1,this.debugTranslations=!1,this.drawKioskIcon=!0,this.apiLocation="../../api/",this.language=!1,this.disablePathDrawing=!1,this.searchScroreLimiter=3,this.searchMinimumScrore=10,this.filterPOIs="",this.assetsLocation="/shared/",this.pathDisplayInstructions=!1,this.pathZoomPadding=100,this.pathColor="rgba(255,0,0,0.8)",this.pathPauseTime=2e3,this.pathSpotRadius=3,this.pathStride=30,this.pathSpeed=60,this.zoomPadding=1.05,this.poiColor="rgba(100,200,0,0.9)",this.poiRadius=9,this.textureLOD=0,this.shadowManualUpdate=!0,this.debugTransparency=!1,this.disableModelLoading=!1,this.disableCollisionTrees=!1,this.disableRendering=!1,this.mapSize=[1024,1024],this.forceFullMapUpdate=!1,this.enableLOD=!0,this.maxLOD=2,this.enableUserLocation=!0,this.overlayHighlightColor="#ff0000dd",this.mapPadding=.1,this.enableUserYAHSetting=!1,this.application="2D",this.pathZoomIn=!1,this.poi2DTitlePadding=12,this.path2DMessageSize=16,this.map2DRotation=0,this.disableMap2DMovement=!1,this.debug=!1,this.debugBeacons=!1,this.debugMouseLocation=!1,this.upscale=1,this.yahRotation=0,this.poi2DTitleWeight="normal",this.gps=!1,this.factory=new WayfinderFactory,this.directionalShadowResolution=2048,this.showDebug=!1,this.display=!1},_parseFromURL:function(){var overriddenOptions={};if(1<location.hash.length&&-1<location.hash.indexOf("{")){var args=decodeURIComponent(location.hash.substring(1)).split("#");0<args.length&&-1<args[0].indexOf("{")&&-1<args[0].indexOf("}")&&(overriddenOptions=JSON.parse(args[0]))}else if(1<location.search.length){var option,i,options=decodeURIComponent(location.search.substring(1)).split("&");if(0<options.length)for(i in options)1<(option=options[i].split("=")).length&&(overriddenOptions[option[0]]=option[1])}return overriddenOptions},_getAliases:function(){return{kiosk:"kiosk.default"}},loadFromURL:function(){var i,aliases=this._getAliases(),overriddenOptions=this._parseFromURL();for(i in overriddenOptions)console.log("Overriding option: "+i+"="+overriddenOptions[i]),this[i]=overriddenOptions[i],aliases[i]&&(this[aliases[i]]=overriddenOptions[i])}}),WF_DEBUG=!1,Wayfinder=Class.extend({init:function(options,factory){options&&options instanceof WayfinderOptions||(options=new WayfinderOptions),factory=factory||new WayfinderFactory(this),this.factory=factory,this.logicName="generic",this.setOptions(options),this.settings=new Settings,this.statistics=new WFStatistics(this),this.monitor=null,this.firstFinishedLoading=!1,this.debugLog=!1,this.kiosk=!1,this.screens=[],this.dataLoaded=!1,this.resizeObserver=null,options.debugLog&&DebugLog&&"DebugLog"==typeof DebugLog&&(this.debugLog=new DebugLog(options.debugLog)),Logistics.onStageProgress(ClassCallback(this,this.onStageProgress)),Logistics.onProgress(ClassCallback(this,this.onProgress)),this.languages={},this.pois={},this.poisArray=[],this.rooms={},this.poiGroups={},this.shortcuts=[],this.mainGroups=[],this.groupSlugs={},this.groupTree={},this.nodes={},this.edges={},this.attributes={},this.poisettings=new Settings,this.poiAdvertisements={},this.advertisements={},this.translator=new Translator(this.options.language,{}),this.building=null,this.firstLanguageChange=!0,this.search=new WayfinderSearch(this),this.events=new WayfinderEvents(this),this.device=DeviceFactory.getDevice(this),this.accessibility="",this.maps={},this.hasWatermark=!0,this.acquiringLocation=!1},cbOnPOIClick:function(poi){},cbOnDataLoaded:function(){},cbOnProgress:function(percentage){},cbOnStageProgress:function(stage,percentage){},cbOnLanguageChange:function(language){},cbOnBeforeFloorChange:function(floor){},cbOnFloorChange:function(floor){},cbOnZoomChange:function(percentage){},cbOnPathStep:function(steps,i){},cbOnPathStart:function(endNode,poi){},cbOnPathFinished:function(path){},cbOnTouch:function(action,value){},cbOnMapUpdate:function(){},cbOnMapReady:function(){},cbOnLocationChange:function(location){},cbOnWebGLContextFail:function(){console.warn("cbOnWebGLContextFail has to be overridden")},finishedLoading:function(argument){this.firstFinishedLoading||(this.firstFinishedLoading=!0,this.onDataLoaded())},setOptions:function(options){this.options=options,this.options.project=this.readProjectName(),this.options.loadFromURL()},setStyle:function(template_id){$("head").append('<link rel="stylesheet" type="text/css" href="{0}">'.format(WayfinderAPI.templates.css.url(template_id)))},open:function(project,canvas){void 0!==project&&(this.options.project=project),this.setupCanvas(canvas),WayfinderAPI.open(this.options.project),this.resize(),this.startLoading(),console.log("Open",this.options.project),"undefined"!=typeof document&&"function"==typeof this.onVisibilityChange&&document.addEventListener("visibilitychange",ClassCallback(this,this.onVisibilityChange))},setupCanvas:function(canvas){canvas||"undefined"==typeof document||(canvas=document.getElementById(this.options.map)),this.maps[this.logicName]={logic:this.logic,canvas:canvas,loaded:!1}},readProjectName:function(){if("undefined"!=typeof document)for(var folders=document.location.pathname.split("/"),i=0;i<folders.length;i++)if("projects"==folders[i]&&folders.length>i+1)return folders[i+1];return this.options.project},getLayout:function(){if("undefined"!=typeof document){var metas=document.getElementsByTagName("meta");for(i in metas)if("layout"==metas[i].name)return metas[i].content;for(var folders=document.location.pathname.split("/"),i=0;i<folders.length;i++)if("projects"==folders[i]&&folders.length>i+2)return folders[i+2]}return"default"},log:function(){this.debugLog&&this.debugLog.logArray(this.log.arguments)},getProject:function(){return this.options.project},getAPILocation:function(){return WayfinderAPI&&WayfinderAPI.LOCATION?WayfinderAPI.LOCATION:this.options.apiLocation},setKiosk:function(node_id){this.options.kiosk=node_id},getKiosk:function(){return this.options.kiosk},getKioskNode:function(){return!!(this.options.kiosk&&this.options.kiosk in this.nodes)&&this.nodes[this.options.kiosk]},showPath:function(endNode,poi,options){return this.logic.showPath(this.getKioskNode(),endNode,poi,options)},findPath:function(from,to,options){return this.logic.findPath(from,to,options)},showPathFromPOIToPOI:function(from,to){this.logic.showPathFromPOIToPOI(from,to)},showKiosk:function(){return this.logic.showKiosk()},showFloor:function(floor,callback,withoutPOIs,doNotSet){"object"!=typeof floor||doNotSet||this.building.setActiveFloors(floor),this.logic.showFloor(this.building.getCurrentFloor(),callback,withoutPOIs,doNotSet),this.events.trigger("floor-change",floor)},getLanguage:function(){return this.translator.getLanguage()},setLanguage:function(language){var lang=this.languages[language];lang&&this.translator.translate(language,lang.textDirection),this.translator.translate(language),this.events.trigger("language-change",language)},startLoading:function(){var add="",wfcache=new URL(document.location.toString()).searchParams.get("wfcache");wfcache&&0<wfcache.length&&(add="?wfcache="+wfcache),Logistics.getJSON(WayfinderAPI.building.pack.url()+add,null,ClassCallback(this,this.onBundleData),{stage:"settings"})},onBundleData:function(response){response=response.data;this.settings.data=response.settings,this.poisettings.data=response.poisettings,this.hasWatermark=response.hasWatermark,this.screens=response.screens,this.texts=response.texts,this.onSettings(),this.building.setLocation(response.location),response.guitranslations&&this.translator.setTranslations(response.guitranslations),this.factory.createLanguages(response.languages),this.onSettings(),this.factory.createFloors(response.levels),this.factory.createLocations(response),this.factory.createPOIAdvertisements(response.poi_ads)},onDataCreated:function(){this.finishedLoading()},loadSecondaryResources:function(){var scope=this;setTimeout(function(){scope.loadHiddenPOIIcons()},1e3)},loadHiddenPOIIcons:function(data){if(this.pois)for(var i in this.pois)this.pois[i].image_id&&0!==this.pois[i].image_id&&!this.pois[i].alwaysVisible&&Logistics.getImage(WayfinderAPI.getURL("images","thumbnail",[this.pois[i].image_id]),ClassCallback(this.pois[i],this.pois[i].setIcon))},onSettings:function(){if(this.building=this.factory.createBuilding(this.settings.data),0==this.options.language&&(this.options.language=this.settings.get("language.default","en")),!1===this.options.kiosk&&this.setKiosk(this.settings.getInt("kiosk.default",0)),this.options.screen&&this.screens&&0<this.screens.length&&!this.monitor)for(var s in this.screens)if(this.screens[s].id==this.options.screen){this.setKiosk(this.screens[s].node_id),this.monitor=new WayfinderMonitor(this,this.options.screen),this.monitor.start();break}},onFinishedLoading:function(){this.firstFinishedLoading||(this.firstFinishedLoading=!0,this.onDataLoaded())},onDataLoaded:function(){this.setKiosk(this.options.kiosk),this.dataLoaded=!0,this.events.setupDeprecated(this),this.loadSecondaryResources(),this.cbOnProgress(100),this.cbOnDataLoaded(),this.setLanguage(this.options.language);var scope=this;setTimeout(function(){scope.runDefaultActions()},1e3)},createTranslations:function(translations){this.translator&&translations&&this.translator.setTranslations(translations.data)},onProgress:function(progress){this.events.trigger("data-progress",progress)},onStageProgress:function(stage,progress){this.events.trigger("data-stage-progress",stage,progress)},resize:function(){this.logic&&this.logic.resize()},onPOIClick:function(poi,position,event,allPOIs){"function"==typeof this.cbOnPOIClick&&this.events.trigger("map-click",poi,position,event,allPOIs)},onZoomChange:function(zoom){this.events.trigger("zoom-change",zoom)},setZoom:function(percentage){this.logic.setZoom(percentage)},zoomIn:function(){this.logic.zoomIn()},zoomOut:function(){this.logic.zoomOut()},pathToText:function(path){return this.logic.pathToText(path)},getPOIWithExternalId:function(id){for(var i in this.pois)if(this.pois[i].room_id==id)return this.pois[i];return!1},getNearestPOI:function(source,pois){return this.logic?this.logic.getNearestPOI(source,pois):null},restoreDefaultState:function(){this.options.language&&this.setLanguage(this.options.language),this.clearHighlights(),this.clearDisplaying(),this.showKiosk()},showScreensaver:function(){},hideScreensaver:function(){},setHighlights:function(pois){this.logic.clearHighlights(),this.logic.setHighlights(pois)},clearHighlights:function(){this.logic.clearHighlights()},setDisplaying:function(pois){this.clearDisplaying(),this.logic.setDisplaying(pois)},clearDisplaying:function(){this.logic.clearDisplaying()},onSetLanguage:function(language){},getLanguages:function(){return this.languages},getPOIs:function(){return this.pois},getPOIsArray:function(){return this.poisArray},getPOIGroups:function(){return this.poiGroups},getMainGroups:function(){return this.mainGroups},getGroupTree:function(){return this.groupTree},getShortcuts:function(){return this.shortcuts},getNodes:function(){return this.nodes},getEdges:function(){return this.edges},getFilteredAdvertisements:function(){var t,kioskID=this.getKiosk(),floorID=this.getKioskNode().floor_id,results=[];for(t in this.advertisements)for(var a in results[t]={},this.advertisements[t])ads=this.advertisements[t][a],results[t][a]=ads.filter(function(ad){if(kioskID&&floorID){if(ad.kiosk&&0<(null!=ad.kiosk&&parseInt(ad.kiosk))&&parseInt(ad.kiosk)!=kioskID)return!1;if(ad.floor&&null!=ad.floor&&0!=ad.floor&&ad.kiosk!=floorID)return!1}return!0});return results},clearPath:function(){this.logic.clearPath()},zoomOnPathSegment:function(startNode,endNode){},getCurrentFloor:function(){return this.building.getCurrentFloor()},setCurrentFloor:function(floor){return this.building.setCurrentFloor(floor)},findNearestNodeOnFloor:function(floor,position){return this.logic.findNearestNodeOnFloor(floor,position)},getImageData:function(){return!1},createExtraMap:function(key,logic,canvas){if("function"!=typeof logic)throw console.log("Logic",logic),new Error("Given logic is not a function");logic=new logic(this,key),this.maps[key]={logic:logic,canvas:canvas,loaded:!1},logic.initData(),logic.loadMapData()},isMapInitialized:function(key){return!!this.maps[key]},parsePOIFromURLParam:function(param){if("string"==typeof param)if(0===(param=decodeURIComponent(param)).indexOf("poi-")){if(1<(ids=param.split("poi-")).length&&this.pois[ids[1]])return this.pois[ids[1]]}else if(0===param.indexOf("room-")){if(1<(ids=param.split("room-")).length&&this.getRoom(ids[1])){var ids=this.getRoom(ids[1]);if(0<ids.pois.length)return ids.pois[0]}}else{ids=this.search.search(param,"poi",{limitToHighestScore:!0,splitString:!1});if(ids){if(1==ids.length)return ids[0];if(1<ids.length){param=this.getNearestPOIs(this.getKioskNode(),ids);if(param&&0<param.length)return param[0]}}}return!1},runDefaultActions:function(){this.events.trigger("pre-ready"),console.log("runDefaultActions","Destination",this.options.destination,"Source",this.options.source,"GPS",this.options.gps);var c,scope=this,b=!1,a=!1,_alert=!1;this.events.on("location-start",function(){console.log("location-start"),scope.acquiringLocation=!0}),this.events.on("location-success",function(){b=scope.parsePOIFromURLParam(scope.options.destination),console.log("location-success",b),scope.acquiringLocation&&b&&scope.showPath(b.node,b),scope.acquiringLocation=!1}),this.events.on("location-failed",function(){setTimeout(function(){scope.acquiringLocation=!1,_alert||(alert("Location failed"),_alert=!0)},500)}),this.options.source&&(a=this.parsePOIFromURLParam(this.options.source))&&this.setKiosk(a.getNode().id),this.options.sourceNode&&(b=this.nodes[this.options.source],console.log("sourceNode",this.options.source,b,a),a)&&b&&(this.showFloor(a.node.floor),this.showPathFromPOIToPOI(a,b)),this.options.display&&(c=this.parsePOIFromURLParam(this.options.display),console.log("Display",this.options.display,c),c)&&(this.showFloor(c.node.floor),this.setHighlights([c]),this.setDisplaying([c])),this.options.destination&&(b=this.parsePOIFromURLParam(this.options.destination),console.log("b",b),this.options.gps&&b?(this.setHighlights([b]),this.setDisplaying([b])):b&&(a?(this.showFloor(a.node.floor),this.showPathFromPOIToPOI(a,b)):scope.showPath(b.node,b))),this.options.gps&&(console.log("Starting geolocation"),this.device.startGeoLocating()),this.statistics.start(),this.events.trigger("ready")},switchToMap:function(key){if(!this.maps[key])throw new Error("No such map inialized: "+key);for(var i in this.maps)"object"==typeof this.maps[i]&&this.maps[i].logic&&this.maps[i].logic.pause();this.logic=this.maps[key].logic,this.logic.run()},isDataLoaded:function(type){return!!this.loadedData[type]},run:function(){return this.logic.run()},pause:function(){return this.logic.pause()},isRunning:function(){return this.logic.isRunning()},update:function(fullUpdate){return this.logic.update(fullUpdate)},getScreenPosition:function(poi){return this.logic.getScreenPosition(poi)},switchCanvas:function(element){this.logic.switchCanvas(element)},getNearestPOIs:function(source,pois,radius){return this.logic.getNearestPOIs(source,pois,radius)},getRoom:function(room_id){return this.logic.getRoom(room_id)},getGroupWithSlug:function(slug){return!("string"!=typeof slug||!this.groupSlugs[slug.toLowerCase()])&&this.poiGroups[this.groupSlugs[slug.toLowerCase()]]}}),WayfinderLogic=Class.extend({init:function(wayfinder,name){this.wayfinder=wayfinder,this.name=name},resize:function(){var canvas,style;"undefined"!=typeof document&&((canvas=this.getCanvas())||(canvas=document.getElementById(this.wayfinder.options.map),this.wayfinder.setupCanvas(canvas)),canvas)&&"undefined"!=typeof window&&(style=window.getComputedStyle(canvas.parentNode,null),this.wayfinder.options.upscale,canvas.setAttribute("width",+parseInt(style.width)),canvas.setAttribute("height",+parseInt(style.height)))},getCanvas:function(){return!!(this.name&&this.wayfinder&&this.wayfinder.maps[this.name])&&this.wayfinder.maps[this.name].canvas},loadMapData:function(){},showFloor:function(){},onDataLoaded:function(){console.log("Logic.onDataLoaded"),this.wayfinder.setKiosk(this.wayfinder.options.kiosk),this.wayfinder.getKioskNode()?this.wayfinder.showFloor(this.wayfinder.getKioskNode().getFloor()):this.wayfinder.building.getSortedFloors()&&0<this.wayfinder.building.getSortedFloors().length&&this.wayfinder.showFloor(this.wayfinder.building.getSortedFloors()[0]),this.wayfinder.showKiosk(),this.wayfinder.events.trigger("data-loaded"),this.dataLoaded=!0,this.wayfinder.loadSecondaryResources(),this.wayfinder.onFinishedLoading()},loadPOIIcons:function(data){if(this.wayfinder.pois){var poi,i;for(i in this.wayfinder.pois)(poi=this.wayfinder.pois[i]).image_id&&0!==poi.image_id&&poi.alwaysVisible&&!this.wayfinder.settings.getBoolean("poi.map.only-text",!0,poi)&&Logistics.getImage(WayfinderAPI.getURL("images","getLarge",[poi.image_id]),null,ClassCallback(poi,poi.setIcon),{stage:"locations"})}},textPathSimplification:function(path){var angle,simplePath={},doNotUse="generic portal kiosk landmark";if(simplePath.distance=0,simplePath.steps=[],path&&0<path.length){for(var turn=!1,startNode=path[path.length-1].bNode,lastDistance=0,i=0;i<path.length;i++){if(simplePath.distance+=path[i].distance,lastDistance+=path[i].distance,turn=45<=(angle=path[i].angle)&&angle<135?"right":135<=angle&&angle<225?"around":225<=angle&&angle<315&&"left",path[i].type&&"landmark"==path[i].type&&(path[i].bNode&&path[i].bNode.pois&&0<path[i].bNode.pois.length?simplePath.steps.push({landmark:path[i].bNode.pois,endNode:path[i].bNode,startNode:startNode,in:lastDistance}):path[i].aNode&&path[i].aNode.pois&&0<path[i].aNode.pois.length&&simplePath.steps.push({landmark:path[i].aNode.pois,endNode:path[i].aNode,startNode:startNode,in:lastDistance})),path[i]&&path[i].aNode&&path[i].aNode.neighbours)for(var neighbours=path[i].aNode.neighbours,n=0;n<neighbours.length;n++)!neighbours[n]||"landmark"!=neighbours[n].type||path[i].bNode&&neighbours[n].id==path[i].bNode.id||path[i].aNode&&neighbours[n].id==path[i].aNode.id||"landmark"==startNode.type||simplePath.steps.push({"landmark-nearby":neighbours[n],startNode:path[i].bNode,endNode:path[i].aNode,startNode:startNode});turn&&("string"==typeof path[i].type&&-1==doNotUse.indexOf(path[i].type)||(0<lastDistance&&simplePath.steps.push({walk:lastDistance/100,endNode:path[i].bNode,startNode:startNode}),simplePath.steps.push({turn:turn,endNode:path[i].bNode,startNode:startNode,in:lastDistance})),startNode=path[i].bNode,lastDistance=0),path[i].type&&-1==doNotUse.indexOf(path[i].type)&&(0<i&&i<path.length-1&&path[i].type!==path[i+1].type&&(0<lastDistance&&simplePath.steps.push({walk:lastDistance/100,endNode:path[i].bNode,startNode:startNode}),simplePath.steps.push({use:path[i].type,endNode:path[i].bNode,startNode:startNode,in:lastDistance}),startNode=path[i].bNode),lastDistance=0),path[i].go_to_floor&&(0<lastDistance&&simplePath.steps.push({walk:lastDistance/100,endNode:path[i].bNode,startNode:startNode}),lastDistance=0,simplePath.steps.push({go_to_floor:path[i].go_to_floor,endNode:path[i].bNode,startNode:startNode}),startNode=path[i].bNode)}0<lastDistance&&simplePath.steps.push({walk:lastDistance/100,endNode:path[path.length-1].bNode,startNode:startNode})}return simplePath},run:function(){},pause:function(){},isRunning:function(){},getNearestPOI:function(){},getRoom:function(room_id){return this.wayfinder.rooms[room_id]}}),WayfinderFactory=Class.extend({init:function(wayfinder){this.wayfinder=wayfinder},createFloors:function(floors){if(floors&&this.wayfinder.building)for(var i in floors)"object"==typeof floors[i]&&this.wayfinder.building.addFloor(this.createFloor(floors[i],this.wayfinder.languages))},createNodes:function(nodes){if(nodes)for(var defaultKiosk=this.wayfinder.settings.getInt("kiosk.default",0),floors=this.wayfinder.building.getFloors(),i=0;i<nodes.length;i++){var node=this.createNode(nodes[i]);node&&((this.wayfinder.nodes[nodes[i].id]=node).floor_id in floors&&floors[node.floor_id].addNode(node),nodes[i].id==defaultKiosk)&&(this.wayfinder.kiosk=node)}},createAttributes:function(attributes){attributes&&(this.wayfinder.attributes=attributes)},createPOIs:function(pois){for(var i=0;i<pois.length;i++){var poi=this.createPOI(pois[i],this.wayfinder.languages);this.wayfinder.pois[pois[i].id]=poi,this.wayfinder.poisArray.push(poi),poi.node_id in this.wayfinder.nodes&&this.wayfinder.nodes[poi.node_id].addPOI(poi),this.wayfinder.poisettings&&this.wayfinder.poisettings.data&&this.wayfinder.poisettings.data[poi.id]&&(poi.settings=this.wayfinder.poisettings.data[poi.id]),poi.room_id&&""!=poi.room_id&&(this.wayfinder.rooms[poi.room_id]||(this.wayfinder.rooms[poi.room_id]=new Room(poi,this.wayfinder.languages)),this.wayfinder.rooms[poi.room_id].addPOI(poi))}},createTags:function(tags){if(tags)for(var t in tags){var t=tags[t],poi=this.wayfinder.pois[t.poi_id];poi&&poi.setTags(t.tags)}},filterPOIs:function(tags){if(tags&&0<tags.length){var tag,j;for(j in tags)if((tag=tags[j].trim())&&""!==tag)for(var i in this.wayfinder.pois)(i=this.wayfinder.pois[i]).setShowInMenu(!1),-1<i.getTags().indexOf(tag)&&i.setShowInMenu(!0)}},createGroups:function(poiGroupsData,poisInGroupsData){if(poisInGroupsData&&poiGroupsData){var poiGroupData,childGroups={};for(poiGroupData in poiGroupsData)(poiGroup=this.createPOIGroup(poiGroupsData[poiGroupData],this.wayfinder.languages)).parent_id&&(childGroups[poiGroup.parent_id]||(childGroups[poiGroup.parent_id]=[]),childGroups[poiGroup.parent_id].push(poiGroup.getID())),"string"==typeof poiGroup.slug&&0<poiGroup.slug.length&&(this.wayfinder.groupSlugs[poiGroup.slug.toLowerCase()]=poiGroup.id),this.wayfinder.poiGroups[poiGroup.getID()]=poiGroup;var c,poiGroupID,scope=this;for(c in childGroups)this.wayfinder.poiGroups[c]&&(this.wayfinder.poiGroups[c].setChildren(childGroups[c]),childGroups[c].map(function(child_id){scope.wayfinder.poiGroups[child_id].setParent(scope.wayfinder.poiGroups[c])}));for(poiGroupID in poisInGroupsData)for(var poiIndex in poiGroupData=poisInGroupsData[poiGroupID]){var poiIndex=this.wayfinder.pois[poiGroupData[poiIndex]],poiGroup=this.wayfinder.poiGroups[poiGroupID];poiIndex&&poiGroup&&(poiGroup.addPOI(poiIndex),poiIndex.addGroup(poiGroup))}Object&&Object.values&&Array&&Array.prototype.filter&&(this.wayfinder.shortcuts=Object.values(this.wayfinder.poiGroups).filter(function(group){return group&&group.getShowInTopMenu()}),this.wayfinder.shortcuts.sort(function(a,b){return a.order-b.order}),this.wayfinder.mainGroups=Object.values(this.wayfinder.poiGroups).filter(function(group){return group&&group.getShowInMenu()&&null==group.parent_id}),this.wayfinder.mainGroups.sort(function(a,b){return a.order-b.order}));var _group,tree={};for(group in this.wayfinder.poiGroups)tree[(_group=this.wayfinder.poiGroups[group]).getID()]=[],tree[_group.getID()]=this.findTree(tree[_group.getID()],_group);this.wayfinder.groupTree=tree}},findTree:function(arr,group){return"object"==typeof group&&group.getParent()&&group.getParent().getID()!==group.getID()?(arr.push(group.getParent().getID()),this.findTree(arr,group.getParent())):arr},createPOIAdvertisements:function(poiAdsData){if(poiAdsData){for(var ads=[],a=0;a<poiAdsData.length;a++){var poiAdData=poiAdsData[a],poi=this.wayfinder.pois[poiAdData.poi_id];poi&&(poiAdData=new POIAdvertisement(poiAdData),ads.push(poiAdData),poi.addAdvertisement(poiAdData))}this.wayfinder.poiAdvertisements=ads}},createPOIAdvertisement:function(data){return new POIAdvertisement(data.id,data.poi_id,data.advertisement_id)},addPOIsToFloor:function(floorPOIs){for(var floor_id in floorPOIs){var floors=this.wayfinder.building.getFloors();if(floor_id in floors){var i,floor=floors[floor_id];for(i in floorPOIs[floor_id])floorPOIs[floor_id][i]in this.wayfinder.pois&&floor.addPOI(this.wayfinder.pois[floorPOIs[floor_id][i]])}}},createEdges:function(edges){if(edges){for(var node_id in edges)if(node_id in this.wayfinder.nodes)for(var i in edges[node_id])edges[node_id][i]in this.wayfinder.nodes&&this.wayfinder.nodes[node_id].addNeighbour(this.wayfinder.nodes[edges[node_id][i]]);this.wayfinder.edges=edges}},createBuilding:function(data){return new Building(data)},createFloor:function(floorData,languages){return new Floor(floorData,languages)},createNode:function(data){return new NavigationNode(data)},createPOI:function(data,languages){return new POI(data,languages)},createPOIGroup:function(data,languages){return new POIGroup(data,languages)},createLanguages:function(languages){for(var name in languages)this.wayfinder.languages[name]=new Language(languages[name]),name.toLowerCase()==this.wayfinder.options.language.toLowerCase()&&this.wayfinder.translator.setLanguage(name,this.wayfinder.languages[name].textDirection);this.wayfinder.translator.translate()},createLocations:function(data){this.createNodes(data.navigation.nodes),this.createEdges(data.navigation.edges),this.createPOIs(data.locations.all),this.addPOIsToFloor(data.locations.byfloor),this.createGroups(data.locations.groups,data.locations.bygroup),this.createTags(data.locations.tags),this.wayfinder.options.filterPOIs&&this.filterPOIs(this.wayfinder.options.filterPOIs.trim().split(",")),this.wayfinder.advertisements=this.createAdvertisements(data.a),this.createAttributes(data.locations.attributes)},createAdvertisements:function(ads){var template,banner,frame,enabled,i,banners={},_template={},now=Date.now(),frames=[];for(i in ads)if(template=ads[i]){for(var b in _template={},template){for(var f in frames=[],banner=template[b]){if((enabled=(enabled=(frame=banner[f]).enabled)&&frame.from_date?enabled&&new Date(frame.from_date).getTime()<=now:enabled)&&frame.to_date&&(enabled=enabled&&new Date(frame.to_date).getTime()>=now),"string"==typeof frame.kiosk&&0<frame.kiosk.length&&parseInt(this.wayfinder.options.kiosk)!==parseInt(frame.kiosk)&&(enabled=!1),0<frame.keywords.length)for(var keywords=frame.keywords.join(";")+";",k=0;k<frame.keywords.length;k++)if(-1<frame.keywords[k].indexOf("kiosk-")&&-1==keywords.indexOf("kiosk-"+this.wayfinder.getKiosk()+";")){enabled=!0;break}enabled&&frames.push(frame)}0<frames.length&&(_template[b]=frames)}banners[i]=_template}return banners}}),WayfinderSearch=Class.extend({init:function(wayfinder){this.wayfinder=wayfinder,this.searchParams=[],this.limit=0,this.options={maxSearchParams:15,stringSearch:"relative",minimumScore:1,splitKeywords:!0,splitString:!0,limit:1/0,scoreLimit:1.5,limitToHighestScore:!1,searchStringLength:2,scoreAccuracy:10,poi:{name:1,description:.5,tags:1,room_id:.5}},this.results={},this.highScore=0,this.scores=[],this.providers={},this.setupProviders()},overrideOptions:function(options){for(var i in options)this.options[i]=options[i]},setupProviders:function(){this.providers.poi=ClassCallback(this,this.POIsProvider)},clearResults:function(){this.results={},this.highScore=0,this.scores=[]},search:function(searchstring,_type,_options){var type="poi";return this.clearResults(),"string"==typeof _type&&(type=_type),this.overrideOptions(_options),void 0!==searchstring&&searchstring.length>=this.options.searchStringLength&&(searchstring=searchstring.trim().toLowerCase(),this.options.splitKeywords?this.searchParams=searchstring.split(" "):this.searchParams=[searchstring],this.searchParams.length>this.options.maxSearchParams&&this.searchParams.splice(this.options.maxSearchParams,this.searchParams.length-this.options.maxSearchParams),this.providers[type])&&"function"==typeof this.providers[type]&&this.providers[type](this.searchParams,this.wayfinder),this.order(this.results,this.highScore,this.scores)},pushResult:function(score,key,obj){score>=this.options.minimumScore&&(score=parseFloat(parseFloat(score).toFixed(2)),this.results[score]||(this.results[score]={}),-1==this.scores.indexOf(score)&&this.scores.push(score),this.results[score][key]=obj,this.highScore=Math.max(this.highScore,score))},POIsProvider:function(keywords,wayfinder){var language=this.wayfinder.getLanguage(),scope=this;var i,poi,param,_score,pois=wayfinder.pois,score=-1;for(i in pois)if(pois[i].getShowInMenu()){for(var k in score=0,keywords)score+=(poi=pois[i],param=keywords[k],k=k,void 0,_score=0,scope.options.poi.name&&poi.getName(language)&&(_score=scope.searchString(poi.getName(language),param,scope.options.poi.name,k)),scope.options.poi.description&&poi.getDescription(language)&&(_score=Math.max(_score,scope.searchString(poi.getDescription(language),param,scope.options.poi.description,k))),scope.options.poi.tags&&poi.getTags()&&(_score=Math.max(_score,scope.searchString(poi.getTags(),param,scope.options.poi.tags,k))),_score=scope.options.poi.room_id&&poi.getRoomId()?Math.max(_score,scope.searchString(poi.getRoomId(),param,scope.options.poi.room_id,k)):_score);this.pushResult(score,pois[i].getID(),pois[i])}},findWithChar:function(character){var i,foundPOIs=[],language=this.wayfinder.getLanguage(),pois=this.wayfinder.pois;for(i in pois)pois[i].getShowInMenu()&&pois[i].hasName(language)&&pois[i].getFirstChar(language)==character&&foundPOIs.push(pois[i]);return foundPOIs.sort(function(a,b){if(a.getName(language)&&b.getName(language))return a.getName(language).toLowerCase().trim().localeCompare(b.getName(language).toLowerCase().trim())}),foundPOIs},searchString:function(string,keyword,scoreDown,index){if("string"==typeof string&&"string"==typeof keyword)switch(string=string.toLowerCase().trim(),keyword=keyword.toLowerCase().trim(),this.options.stringSearch){case"strict":return this.searchStringStrict(string,keyword,scoreDown,index);case"relative":return this.searchStringRelatively(string,keyword,scoreDown,index);default:return this.searchStringStrict(string,keyword,scoreDown,index)}return 0},searchStringStrict:function(string,keyword,scoreDown,index){var pos;return string&&keyword&&-1<(pos=string.indexOf(keyword))&&pos<100?((pos=100-pos)+keyword.length/string.length)*scoreDown:0},searchStringRelatively:function(string,keyword,scoreDown,index){if(!string||!keyword)return 0;var _string,__score,tokens=keyword.split(""),strings=[string],tokenIndex=(this.options.splitString&&(strings=string.split(/,\s*|\s/)),0),stringIndex=0,matchedPositions=[],score=-1,lastFoundIndex=0;scoreDown=scoreDown||1;for(var i=0;i<strings.length;i++)if(1<(_string=strings[i]).length){for(;stringIndex<_string.length&&(_string[stringIndex]===tokens[tokenIndex]?(lastFoundIndex=stringIndex,matchedPositions.push(stringIndex),tokenIndex++):(this.options.splitString||" "!=_string[stringIndex])&&stringIndex==_string.length-1&&tokenIndex<tokens.length&&(stringIndex=lastFoundIndex,tokenIndex++),!(tokenIndex>=tokens.length));)stringIndex++;0<matchedPositions.length?(__score=function(matchedTokens,tokens,string){for(var maxSubArrayLength=0,currentLength=0,holesTotalLength=0,lastToken=-1,i=0;i<matchedTokens.length;i++)lastToken==matchedTokens[i]-1?(currentLength++,maxSubArrayLength=Math.max(maxSubArrayLength,currentLength)):(holesTotalLength=Math.max(holesTotalLength,matchedTokens[i]-lastToken-1),currentLength=1),lastToken=matchedTokens[i];return holesTotalLength=Math.max(holesTotalLength,tokens-matchedTokens[matchedTokens.length-1]-1),tokens=maxSubArrayLength<=tokens?maxSubArrayLength/tokens*4:0,10*((tokens+=matchedTokens.length==string.length?2:0)+(0===matchedTokens[0]?1:0)+(1-matchedTokens[0]/string.length)-holesTotalLength)}(matchedPositions,tokens.length,_string),i==index&&0<__score?score+=__score:score=Math.max(__score-.3*i,score)):score=Math.max(score,-1),matchedPositions.length=stringIndex=tokenIndex=0}return score=Math.round(score*scoreDown)},order:function(searchResult,highScore,scores){var sorted=[];if(searchResult&&0!=searchResult.length){var s,obj,i,count=0,keys=scores.sort(function(a,b){return a-b}).reverse();for(i in keys)if(searchResult[s=keys[i]]){for(i in searchResult[s]){if(obj=searchResult[s][parseInt(i)],highScore/s>this.options.scoreLimit&&0<count)return sorted;if(sorted.push(obj),count++,0<this.options.limit&&count>this.options.limit)return sorted}if(this.options.limitToHighestScore)return sorted}}return sorted}}),WayfinderEvents=Class.extend({init:function(){this.events={"map-click":[],"map-pause":[],"map-run":[],"map-ready":[],"language-change":[],"data-loaded":[],"device-pause":[],"device-resume":[],"location-start":[],"location-change":[],"location-success":[],"location-failed":[],"pre-ready":[],ready:[]},this.onceEvents={}},setupDeprecated:function(wayfinder){this.on("data-loaded",wayfinder.cbOnDataLoaded),this.on("map-click",wayfinder.cbOnPOIClick),this.on("language-change",wayfinder.cbOnLanguageChange),this.on("data-progress",wayfinder.cbOnProgress),this.on("data-stage-progress",wayfinder.cbOnStageProgress),this.on("floor-change-before",wayfinder.cbOnBeforeFloorChange),this.on("floor-change",wayfinder.cbOnFloorChange),this.on("zoom-change",wayfinder.cbOnZoomChange),this.on("map-update",wayfinder.cbOnMapUpdate),this.on("map-ready",wayfinder.cbOnMapReady),this.on("map-touch",wayfinder.cbOnTouch),this.on("path-start",wayfinder.cbOnPathStart),this.on("path-step",wayfinder.cbOnPathStep),this.on("path-finished",wayfinder.cbOnPathFinished),this.on("data-assets-progress",wayfinder.onAssetsProgress),this.on("location-change",wayfinder.cbOnLocationChange)},on:function(type,callback){this.listen(type,callback)},once:function(type,callback){"object"!=typeof this.onceEvents[type]&&(this.onceEvents[type]=[]),this.onceEvents[type].push(callback)},listen:function(type,callback){"object"!=typeof this.events[type]&&(this.events[type]=[]),this.events[type].push(callback)},trigger:function(){var args=Array.prototype.slice.call(arguments);if(0<args.length){var type=args[0];if(args.shift(),this.events[type])for(var i=0,len=this.events[type].length;i<len;i++)"function"==typeof(fun=this.events[type][i])&&fun.apply(this,args);if(this.onceEvents[type])for(i=0,len=this.onceEvents[type].length;i<len;i++)"function"==typeof(fun=this.onceEvents[type][i])&&fun.apply(this,args),delete this.onceEvents[type];if(this.events.any)for(var fun,i=0,len=this.events.any.length;i<len;i++)"function"==typeof(fun=this.events.any[i])&&(args.unshift(type),fun.apply(this,args))}}}),Building=Class.extend({init:function(settings,languages){this.name=settings["building.name"],this.address=settings["building.address"],this.link=new Translations(settings["building.link"]),this.description=new Translations(settings["building.description"]),this.logoID=settings["building.logo"],this.backgroundID=settings["building.background"],this.floors={},this.sortedFloors=null,this.currentFloor=!1,this.location={latitude:0,longitude:0,direction:0,scale:0}},addFloor:function(floor){this.floors[floor.id]=floor},removeFloor:function(floor){delete this.floors[floor.id]},getFloors:function(){return this.floors},getSortedFloors:function(){var sortedFloors=new ArrayUtility(this.floors);return this.sortedFloors=sortedFloors.sort(function(a,b){return a.index<b.index}),this.sortedFloors},setActiveFloors:function(floor){if("object"==typeof floor){var _floor,activeFloor,i;for(i in this.floors)"object"==typeof(_floor=this.floors[i])&&_floor.setActive&&_floor.setActive(!1),_floor.id==floor.id&&(activeFloor=_floor);activeFloor.setActive(!0),this.currentFloor=activeFloor}},getCurrentFloor:function(){return this.currentFloor},setCurrentFloor:function(floor){"object"==typeof floor&&(this.currentFloor=floor)},setLocation:function(location){location&&(this.location.latitude=parseFloat(location.latitude),this.location.longitude=parseFloat(location.longitude),this.location.scale=parseFloat(location.scale),this.location.direction=parseFloat(location.direction))}}),Settings=Class.extend({init:function(){this.data={}},has:function(key){return key in this.data},hasItem:function(key,item){return item&&item.settings&&item.settings[key]},get:function(key,defaultValue,item){return item&&item.settings&&item.settings[key]?item.settings[key].value:key in this.data?this.data[key]:defaultValue},getInt:function(key,defaultValue,item){return parseInt(this.get(key,defaultValue,item))},getFloat:function(key,defaultValue,item){return parseFloat(this.get(key,defaultValue,item))},getColor:function(key,defaultValue,item){return(new Color).fromHex(this.get(key,defaultValue,item))},getBoolean:function(key,defaultValue,item){return!0===this.get(key,defaultValue,item)},getModel:function(key,defaultValue,item){key=this.getInt(key,0,item);return 0===key?defaultValue:key},set:function(key,value){this.data[key]=value},override:function(local){for(var i in local)this.data[i]=local[i]}}),NavigationNode=Class.extend({init:function(nodeData){this.id=nodeData.id,this.floor_id=nodeData.level_id,this.type=nodeData.type,this.position=vec3.fromValues(-parseFloat(nodeData.x),parseFloat(nodeData.y),parseFloat(nodeData.z)),this.rotation=vec3.fromValues(parseFloat(nodeData.rotation_x),parseFloat(nodeData.rotation_y),parseFloat(nodeData.rotation_z)),this.floor=!1,this.pois=[],this.weight=0,nodeData.weight&&(this.weight=parseFloat(nodeData.weight)),this.zoom=0,nodeData.zoom&&(this.zoom=parseFloat(nodeData.zoom)),this.position2d=vec2.create(),this.neighbours=[],nodeData.weight&&(this.weight=parseFloat(nodeData.weight)),nodeData.zoom&&(this.zoom=parseFloat(nodeData.zoom))},setFloor:function(floor){floor instanceof Floor&&floor.id==this.floor_id&&(this.floor=floor)},addPOI:function(poi){poi instanceof POI&&poi.node_id==this.id&&(poi.setNode(this),this.pois.push(poi))},getID:function(){return this.id},getFloor:function(){return this.floor},getPOIs:function(){return this.pois},setPosition2D:function(x,y){this.position2d=vec2.fromValues(parseFloat(x),parseFloat(y))},setWeight:function(weight){this.weight=parseFloat(weight)},addNeighbour:function(node){node instanceof NavigationNode&&this.neighbours.push(node)}}),Floor=Class.extend({init:function(floorData,languages){for(var language in this.id=parseInt(floorData.id,10),this.name_id=parseInt(floorData.name_id,10),this.model_id=parseInt(floorData.model_id,10),this.format=floorData.format,this.index=parseInt(floorData.index,10),this.y=parseFloat(floorData.y,10),this.lightmap_id=parseInt(floorData.lightmap_id,10),this.showInMenu=0!==parseInt(floorData.show_in_menu,10),this.names=new Translations,this.active=!1,this.svg=floorData.svg,languages)this.names.set(language,floorData[language]);this.pois=[],this.nodes=[],this.node3D=!1,this.mapMeshPathToID={},this.mapIDToMeshPath={}},toString:function(){return JSON.stringify({class:"Floor",id:this.id,index:this.index})},getID:function(){return this.id},getName:function(language){return this.names.get(language)},getNames:function(){return this.names},addPOI:function(poi){poi instanceof POI&&(poi.setFloor(this),this.pois.push(poi))},addNode:function(node){"object"==typeof node&&node.floor_id==this.id&&(node.setFloor(this),this.nodes.push(node))},getPOIs:function(){return this.pois},getNodes:function(){return this.nodes},getShowInMenu:function(){return this.showInMenu},setActive:function(_active){this.active=_active},getActive:function(){return this.active},setMeshNames:function(idNameMap){for(var meshID in idNameMap)this.mapMeshPathToID[idNameMap[meshID]]=parseInt(meshID),this.mapIDToMeshPath[parseInt(meshID)]=idNameMap[meshID]},getMeshIDByPath:function(path){return path in this.mapMeshPathToID?this.mapMeshPathToID[path]:0},getMeshPathByID:function(mesh_id){return mesh_id in this.mapIDToMeshPath&&this.mapIDToMeshPath[mesh_id]},showYAH:function(){var yah;this.node3D&&(yah=this.node3D.find("YAHLocation/YAH"))&&yah.onEachChild(function(subnode){var renderer=subnode.getComponent(RendererComponent),renderer=(renderer&&renderer.enable(),subnode.getComponent(Billboard));renderer&&renderer.enable()})},hideYAH:function(){var yah;this.node3D&&(yah=this.node3D.find("YAHLocation/YAH"))&&yah.onEachChild(function(subnode){var renderer=subnode.getComponent(RendererComponent),renderer=(renderer&&renderer.disable(),subnode.getComponent(Billboard));renderer&&renderer.disable()})}}),POI=Class.extend({init:function(poiData,languages){for(var language in this.id=parseInt(poiData.id),this.type=poiData.type,this.node_id=parseInt(poiData.node_id),this.mesh_id=parseInt(poiData.mesh_id),this.room_id=poiData.room_id,this.image_id=parseInt(poiData.image_id),this.icon=null,this.iconTinted=null,this.iconUrl=null,this.background_id=parseInt(poiData.background_id),this.backgroundUrl=null,this.background=null,this.showInMenu=0!=parseInt(poiData.show_in_menu),this.alwaysVisible=0!=parseInt(poiData.always_visible),this.mesh_name=poiData.mesh_name,this.externalLogo=poiData.external_logo,this.settings={},this.names=new Translations,this.descriptions=new Translations,this.open=new Translations,languages)this.names.set(language,poiData["names_"+language]),this.descriptions.set(language,poiData["descriptions_"+language]),this.open.set(language,poiData["opening_hours_"+language]);this.floor=!1,this.node=!1,this.groups=[],this.advertisements=[],this.groupNames={},this.tags="",this.email=poiData.email,this.web=poiData.web,this.phone=poiData.phone,this.opening_hours=0<languages.length?poiData["opening_hours_"+languages[0]]:poiData.opening_hours,this.object=!1,this.visible=!1,this.meshNode=!1,this.submesh=!1,this.canvasBoard=!1,this.geometryCreated=!1,this.engine,this.wayfinder},toString:function(){return JSON.stringify({class:"POI",id:this.id,room_id:this.room_id,showInMenu:this.showInMenu,email:this.email,phone:this.phone,web:this.web})},getID:function(){return this.id},getSetting:function(key,_default){return this.wayfinder.settings.get(key,_default,this)},getSettingBoolean:function(key,_default){return this.wayfinder.settings.getBoolean(key,_default,this)},getSettingFloat:function(key,_default){return this.wayfinder.settings.getFloat(key,_default,this)},hasSetting:function(key){return this.wayfinder.settings.hasItem(key,this)},getName:function(language){return this.names.get(language)},getNames:function(){return this.names},getDescription:function(language){return this.descriptions.get(language)},getOpeningHours:function(language){return this.open.get(language)},getDescriptions:function(){return this.descriptions},getShowInMenu:function(){return this.showInMenu},hasName:function(language){return this.names.hasTranslation(language)},getFirstChar:function(language){language=this.getName(language);return language?language.charAt(0).toLowerCase():""},setShowInMenu:function(value){this.showInMenu=value},setFloor:function(floor){floor instanceof Floor&&(this.floor=floor)},getFloor:function(){return this.floor},setNode:function(node){"object"==typeof node&&(this.node=node),this.object&&this.node&&mat4.fromTranslation(this.object.transform.relative,this.node.position)},getNode:function(){return this.node},addGroup:function(group){this.groups.push(group)},getGroups:function(){return this.groups},getGroupNames:function(language){if(void 0===this.groupNames[language]){var groupID,result={};for(groupID in this.groups)if("object"==typeof this.groups[groupID]){var translations=this.groups[groupID].getNames();for(language in translations.getAll())result[language]||(result[language]=[]),result[language].push(translations.get(language))}this.groupNames=result,void 0===this.groupNames[language]&&(this.groupNames[language]=[])}return this.groupNames[language]},addAdvertisement:function(advertisement){this.advertisements.push(advertisement)},getAdvertisements:function(){return this.advertisements},hasAdvertisements:function(){return"object"==typeof this.advertisements&&0<this.advertisements.length},getTags:function(){return this.tags},setTags:function(tag){this.tags=tag},setIcon:function(image){this.icon=image},getIcon:function(){return this.icon},setBackground:function(image){this.background=image},getBackground:function(){return this.background},getRoomId:function(){return this.room_id},isAlwaysVisible:function(){return this.alwaysVisible},getIconUrl:function(){return!this.iconUrl&&0<this.image_id?this.iconUrl=WayfinderAPI.getURL("images","getLarge",this.image_id):this.iconUrl},getBackgroundUrl:function(){return!this.backgroundUrl&&0<this.background_id?this.backgroundUrl=WayfinderAPI.getURL("images","getLarge",this.background_id):this.backgroundUrl},getLines(language,linesCount){var language=this.getName(language),words=language.replace(/\&shy;/g," &shy; ").split(" "),textLength=language.replace("&shy;","-").length,lines=[],currentLine=words[0];if(linesCount<=0)return words;if(words.length<=linesCount)return words;for(var i=1;i<words.length;i++)"&shy;"!==words[i].toLowerCase()?currentLine.length>textLength/linesCount?(lines.push(currentLine),currentLine=words[i]):currentLine+=" "+words[i]:currentLine.length+1>textLength/linesCount?(lines.push(currentLine+"-"),currentLine=""):i+1<words.length&&(lines.push(currentLine+words[++i]),currentLine="");return""!==currentLine&&lines.push(currentLine),lines}}),POIAdvertisement=Class.extend({init:function(data){"object"==typeof data&&(this.id=parseInt(data.id),this.poi_id=parseInt(data.poi_id),this.advertisement_id=parseInt(data.advertisement_id),this.content_type=data.contentType,this.thumb=data.thumb,this.priority=parseInt(data.priority),this.video_length=parseInt(data.video_length),this.from_date=Date.parse(data.from_date),this.to_date=Date.parse(data.to_date))},getID:function(){return this.id},getPOIId:function(){return this.poi_id},getAdvertisementId:function(){return this.advertisement_id}}),POIGroup=Class.extend({init:function(poiGroupData,languages){for(var language in this.id=parseInt(poiGroupData.group_id),this.names=new Translations,this.desciptions=new Translations,this.imageID=poiGroupData.image_id,languages)this.names.set(language,poiGroupData[language]);for(var language in languages)this.desciptions.set(language,poiGroupData["description_"+language]);this.pois=[],this.showInMenu=poiGroupData.show_main,this.showInTopMenu=poiGroupData.show_top,this.color=(new Color).fromHex(poiGroupData.color),this.parent_id=poiGroupData.parent_id,this.order=parseInt(poiGroupData.order),this.iconUrl=!1,this.childGroups=[],this.parent=null,this.slug=poiGroupData.slug},toString:function(){return JSON.stringify({class:"POIGroup",id:this.id,showInMenu:this.showInMenu,showInTopMenu:this.showInTopMenu,parent_id:this.parent_id,slug:this.slug})},getID:function(){return this.id},getName:function(language){return this.names.get(language)},getNames:function(){return this.names},getDescription:function(language){return this.desciptions.get(language)},getDescriptions:function(){return this.desciptions},getShowInMenu:function(){return 0!=this.showInMenu},getShowInTopMenu:function(){return 0!=this.showInTopMenu},getImageID:function(){return this.imageID},addPOI:function(poi){this.pois.push(poi)},getPOIs:function(){return this.pois},getColor:function(){return this.color},getIconUrl:function(){return!this.iconUrl&&0<this.imageID?this.iconUrl=WayfinderAPI.getURL("images","getLarge",this.imageID):this.iconUrl},getChildren:function(){return this.childGroups},setChildren:function(_children){this.childGroups=_children},setParent:function(parent){this.parent=parent},getParent:function(){return this.parent}}),Room=Class.extend({init:function(_room,languages){for(var language in this.id=parseInt(_room.id),this.room_id=_room.room_id,this.names=new Translations,this.pois=[],languages)this.names.set(language,_room["names_"+language])},toString:function(){return JSON.stringify({class:"Room",id:this.id,room_id:this.room_id})},getName:function(language){return this.names.get(language)},getNames:function(){return this.names},getPOIs:function(){return this.pois},addPOI:function(_poi){this.pois.push(_poi)}}),Logistics=function(){function DataTransporter(_url,_params,_success,_type,_requestType,_options){this.url=_url,this.params=_params,this.success=_success,this.dataType=_type,this.loaded=!1,this.data=!1,this.requestType=_requestType,this.useCORS=!1,this.options=_options||{},this.successCallback=_success,this.errorCallback=!1,this.alwaysCallback=!1,this.progressCallback=!1,this.setOption=function(key,value){this.options[key]=value},this.getOption=function(key){return this.options[key]},this.ready=function(){this.loaded=!0,loadedCount++,callSuccess(this),callProgress(this)},this.failed=function(){loadedCount++,callProgress(this),callError(this)},this.done=function(callback){this.successCallback=callback},this.fail=function(callback){this.errorCallback=callback},this.error=function(callback){this.errorCallback=callback},this.always=function(callback){this.alwaysCallback=callback},this.progress=function(callback){this.progressCallback=callback},this.toString=function(){return this.data}}function MultiTransporter(urlList,_success,_options){this.urls=urlList,this.results={},this.loadedCount=0,this.count=0,this.successCallback=_success,_options=_options||{},this.load=function(){var url,key,i,dt=null;for(key in this.urls)this.urls.hasOwnProperty(key)&&this.count++;for(i in this.urls)if((url=this.urls[i])&&url.url&&url.type)try{(dt=get(url.url,void 0,callback(this,this.ready,i),url.type,JSON.parse(JSON.stringify(_options)))).setOption("logistics.multi.key",i),dt.fail(callback(this,this.fail))}catch(e){this.fail()}},this.ready=function(data,status,dt){dt=dt.getOption("logistics.multi.key");this.results[dt]=data,this.loadedCount++,this.checkIfAllReady()},this.fail=function(dt){this.loadedCount++,this.checkIfAllReady()},this.getKeyForURL=function(url){},this.checkIfAllReady=function(){this.loadedCount>=this.count&&"function"==typeof this.successCallback&&this.successCallback(this.results)}}function inLocalStorage(dt){return!(!storageSupport||null===localStorage.getItem(dt.url))}function restore(dt){dt.data=getTypeFunction(dt.dataType,"restore")(dt,loadFromLocalStorage(dt)),dt.ready()}function storeToLocalStorage(dt){if(storageSupport)try{localStorage[dt.url]=getTypeFunction(dt.dataType,"store")(dt)}catch(err){console.warn("localStorage limit exceeded")}else console.warn("localStorage isn't supported")}function callIfFinished(){null===loadedCheckTimer&&(loadedCheckTimer=setTimeout(finishedChecker,5))}var storageSupport=!1,queue=("undefined"!=typeof window&&(storageSupport="localStorage"in window&&null!==window.localStorage),[]),multiQueue=[],stages={},loadedCount=0,afterLoadCallback=null,progressCallback=null,stageCallback=null,loadedCheckTimer=null,options={loadFromLocalStorage:!1,storeToLocalStorage:!1,loadFromFile:!1,enableCORS:!0,useCookies:!1,fallbackFromStorage:!0,urlParseFunction:null},typefunctions={text:{load:function(dt){makeHTTPRequest(dt)},parse:function(dt,http){dt.data=http.responseText},store:function(dt){return dt.data},restore:function(dt,data){return data}},json:{load:function(dt){makeHTTPRequest(dt)},parse:function(dt,http){try{dt.data=JSON.parse(http.responseText)}catch(e){"undefined"!=typeof console&&console.error&&console.error("JSON parsing failed for "+dt.url,e)}},store:function(dt){return JSON.stringify(dt.data)},restore:function(dt,data){return data?JSON.parse(data):{}}},xml:{load:function(dt){makeHTTPRequest(dt)},parse:function(dt,http){http.responseXML?dt.data=http.responseXML:dt.data=parseXML(http.responseText)},store:function(dt){return XMLSerializer?(new XMLSerializer).serializeToString(dt.data):""},restore:function(dt,data){return parseXML(data)}},image:{load:function(dt){dt&&(dt.data=new Image,dt.useCORS&&(dt.data.crossOrigin="Anonymous"),dt.data.onload=function(){dt.ready()},dt.data.onerror=function(){dt.failed()},dt.data.src=dt.url)},parse:function(dt){},store:function(dt){(canvas=document.createElement("canvas")).width=dt.data.width,canvas.height=dt.data.height;canvas.getContext("2d").drawImage(dt.data,0,0);var dt=canvas.toDataURL("image/png"),canvas=null;return dt},restore:function(dt,data){var img=new Image;return img.src=data,img}},binary:{load:function(dt){makeHTTPRequest(dt)},parse:function(dt,http){dt.data=http.response},store:function(dt){for(var str="",bytes=new Uint8Array(dt.data),len=bytes.byteLength,i=0;i<len;i++)str+=String.fromCharCode(bytes[i]);return window.btoa(str)},restore:function(dt,data){for(var buf=new ArrayBuffer(2*data.length),bufView=new Uint16Array(buf),i=0,strLen=data.length;i<strLen;i++)bufView[i]=data.charCodeAt(i);return buf}}},get=function(_url,_params,_success,_type,_options){var _requestType="GET",_params=("function"==typeof _params?(_options=_success,_success=_params,_params=void 0):_params&&"object"==typeof _params&&(_requestType="POST"),"function"==typeof options.urlParseFunction&&(_url=options.urlParseFunction(_url)),new DataTransporter(_url,_params,_success,_type,_requestType,_options));return options.enableCORS&&(_params.useCORS=function(_url){var url;return"undefined"==typeof document||void 0===_url?!1:!(!(url=_url.match(/(https?:)?\/\/([^\/]+)\/(.*)/))||document&&url[1]===document.location.origin)}(_url)),_params&&(queue.push(_params),function(dt){load(dt)}(_params)),_params},load=function(dt){!function(dt){var stage;dt&&(stage=dt.getOption("stage"))&&("object"!=typeof stages[stage]&&(stages[stage]=[]),stages[stage].push(dt))}(dt),(options.loadFromLocalStorage&&inLocalStorage(dt)?restore:getTypeFunction(dt.dataType,"load"))(dt)},getTypeFunction=function(type,method){return typefunctions&&typefunctions[type]&&typefunctions[type][method]?typefunctions[type][method]:typefunctions&&typefunctions[type]?typefunctions[type]:function(){"undefined"!=typeof console&&console.warn&&console.warn("Method "+method+" for "+type+" not found")}},makeHTTPRequest=function(dt){var xhr=getHTTPObject(dt);if(!xhr||!dt)throw"http failed";var url=dt.url,params=null;if(xhr.open(dt.requestType,url,!0),xhr.overrideMimeType&&xhr.overrideMimeType("text/plain"),"binary"==dt.dataType&&(xhr.responseType="arraybuffer",dt.useCORS)&&xhr.setRequestHeader("Content-Type","application/x-3dtechdata"),"default"==dt.dataType&&(xhr.responseType="arraybuffer",dt.useCORS)&&xhr.setRequestHeader("Content-Type","application/octet-stream"),dt.options.headers)for(var h in console.log("dt.headers",dt),dt.options.headers)console.log("h",h,dt.options.headers[h]),xhr.setRequestHeader(h,dt.options.headers[h]);if(dt.params)for(var i in params=new FormData,dt.params)params.append(i,dt.params[i]);dt.useCORS&&options.useCookies&&(xhr.withCredentials=!0),xhr.onreadystatechange=function(){var status;4==xhr.readyState?200==(status=xhr.status)||0==status||300==status?(getTypeFunction(dt.dataType,"parse")(dt,xhr),dt.ready()):dt.failed():"function"==typeof dt.progressCallback&&dt.progressCallback(xhr)},xhr.ontimeout=function(){dt.failed()},xhr.onerror=function(){dt.failed()},callProgress(dt),xhr.send(params)},parseXML=function(data){var xml=null;if(data&&"string"==typeof data&&(window&&window.DOMParser?xml=(new DOMParser).parseFromString(data,"text/xml"):((xml=new ActiveXObject("Microsoft.XMLDOM")).async=!1,xml.loadXML(data)),!xml||xml.getElementsByTagName("parsererror").length))throw"XML parsing failed";return xml},getHTTPObject=function(dt){var http=!1;if(dt.useCORS&&window&&window.XDomainRequest)try{http=new XDomainRequest}catch(E){http=!1}else if(XMLHttpRequest)try{http=new XMLHttpRequest}catch(e){http=!1}else if("undefined"!=typeof ActiveXObject)try{http=new ActiveXObject("Msxml2.XMLHTTP"),alert(2)}catch(e){try{http=new ActiveXObject("Microsoft.XMLHTTP"),alert(3)}catch(E){http=!1}}return http},loadFromLocalStorage=function(dt){return localStorage[dt.url]},callSuccess=function(dt){dt&&"function"==typeof dt.successCallback&&(dt.successCallback(dt.data,"success",dt),callIfFinished()),dt&&options.storeToLocalStorage&&storeToLocalStorage(dt)},callError=function(dt){if(dt&&options.fallbackFromStorage&&inLocalStorage(dt))restore(dt);else{if(!dt||"function"!=typeof dt.errorCallback)throw"Resource "+dt.url+" not loaded";dt.errorCallback(dt,"error",""),callIfFinished()}},callProgress=function(dt){progressCallback&&"function"==typeof progressCallback&&queue.length&&loadedCount&&progressCallback(loadedCount/queue.length),dt&&dt.getOption("stage")&&callStageCallback(dt)},callStageCallback=function(dt){if(stageCallback&&"function"==typeof stageCallback){for(var stage=stages[dt.getOption("stage")],length=stage.length,loadedCount=0,i=0;i<length;i++)stage[i]&&stage[i].loaded&&loadedCount++;0<length&&stageCallback(dt.getOption("stage"),loadedCount/length)}},finishedChecker=function(){loadedCheckTimer=null,queue.length==loadedCount&&afterLoadCallback&&"function"==typeof afterLoadCallback&&afterLoadCallback()},callback=function(classScope,fnCallback){return function(){return fnCallback.apply(classScope,arguments)}};return{count:function(){return queue.length},loadedCount:function(){return loadedCount},clear:function(){queue=[],multiQueue=[],loadedCount=0},get:function(url,params,success,type,options){return get(url,params,success,toLowerCase(type),options)},getJSON:function(url,params,success,options){return get(url,params,success,"json",options)},getImage:function(url,params,success,options){return get(url,params,success,"image",options)},getBinary:function(url,params,success,options){return get(url,params,success,"binary",options)},getXML:function(url,params,success,options){return get(url,params,success,"xml",options)},getText:function(url,params,success,options){return get(url,params,success,"text",options)},getMultiple:function(urlList,success,options){!function(urlList,success,options){urlList=new MultiTransporter(urlList,success,options);multiQueue.push(urlList),urlList.load()}(urlList,success,options)},store:function(){if(storageSupport)for(var i in queue)storeToLocalStorage(queue[i]);else console.warn("localStorage isn't supported")},clearStorage:function(){localStorage.clear()},types:function(){return typefunctions},onFinishedLoading:function(callback){afterLoadCallback=callback},onProgress:function(callback){progressCallback=callback},onStageProgress:function(callback){stageCallback=callback},getQueue:function(){return queue},getTypeFunction:function(type,method){return getTypeFunction(type,method)},setTypeFunction:function(type,method){type&&method&&(typefunctions[type]=method)},getOption:function(key){return options[key]},setOption:function(key,value){!function(key,value){options[key]=value}(key,value)},start:function(){return start()}}}(),Language=Class.extend({init:function(languageData){this.name=languageData.name,this.id=languageData.id,this.nativeName=languageData.native,this.textDirection=languageData.text_direction?languageData.text_direction.toLowerCase():"ltr",this.flagImage=languageData.flag,this.order=parseInt(languageData.order)},getName:function(){return this.name},getID:function(){return this.id},getNativeName:function(){return this.nativeName},getTextDirection:function(){return this.textDirection}}),Translator=Class.extend({init:function(language,translationMap){this.language=language,this.direction="ltr",this.translations=translationMap},setTranslations:function(translationMap){this.translations=translationMap},setLanguage:function(language,direction){this.language=language,direction&&(this.direction=direction)},getLanguage:function(){return this.language},_isJQueryObject:function(obj){return"undefined"!=typeof jQuery&&obj instanceof jQuery},get:function(key,params){var str;return this.translations&&key&&this.translations[key]&&this.translations[key][this.language]?(str=this.translations[key][this.language],params&&"string"==typeof str?this.replaceValues(str,params):str):key},translate:function(language,direction){if(language&&(this.language=language),direction&&(this.direction=direction),"undefined"!=typeof document&&document.querySelectorAll){for(var elements=document.querySelectorAll("[data-translation-element]"),i=0;i<elements.length;i++)this.translateElement(elements[i],elements[i].getAttribute("data-translation-element"));for(elements=document.querySelectorAll("[data-translation-attributes]"),i=0;i<elements.length;i++)for(var key,attributes=elements[i].getAttribute("data-translation-attributes").split(","),j=0;j<attributes.length;j++)key=elements[i].getAttribute("data-translation-attribute-"+attributes[j]),elements[i]&&key&&elements[i].setAttribute(attributes[j],this.get(key))}},setElement:function(element,key){element&&key&&(element=this._isJQueryObject(element)?element[0]:element).setAttribute("data-translation-element",key)},setAttribute:function(element,attribute,key){var attr;element&&key&&attribute&&(attr=[],(attr=(element=this._isJQueryObject(element)?element[0]:element).getAttribute("data-translation-attributes")?element.getAttribute("data-translation-attributes").split(","):attr).push(attribute),element.setAttribute("data-translation-attributes",attr.join(",")),element.setAttribute("data-translation-attribute-"+attribute,key))},translateElement:function(parent,key,params){"object"==typeof parent&&null!==parent&&("string"==typeof(parent=this._isJQueryObject(parent)?parent[0]:parent)&&(parent=document.getElementById(parent)),key&&this.exists(key)?(params=this.get(key,params),this.setElement(parent,key),parent.innerHTML=params,parent.classList.remove("wf-translated-rtl"),parent.classList.remove("wf-translated-ltr"),parent.classList.remove("no-translation"),parent.classList.add("wf-translated-"+this.direction)):parent.classList.add("no-translation"))},translateAttribute:function(parent,attribute,key,params){parent&&attribute&&key&&(this._isJQueryObject(parent)&&(parent=parent[0]),params=this.get(key,params),this.setAttribute(parent,attribute,key),parent.setAttribute(attribute,params),!this.exists(key))&&parent.classList&&parent.classList.add("no-translation")},replaceValues:function(str,params){if(str&&params){var i,count=0;for(i in params)str=str.replace(new RegExp("%"+count++,"g"),params[i])}return str},exists:function(key){return!!(this.translations&&key&&this.translations[key]&&this.translations[key][this.language])}}),Translations=Class.extend({init:function(translations){this.translations=translations||{}},set:function(language,translation){this.translations[language]=translation},get:function(language){return this.translations[language]||!1},setAll:function(translations){this.translations=translations},getAll:function(){return this.translations},hasTranslation:function(language){return"string"==typeof this.translations[language]&&""!=this.translations[language]},setTranslations:function(element,language){if(element&&language){for(var l in this.translations)element.attr("data-lang-"+l,this.translations[l]);this.translations[language]?element.html(this.translations[language]):element.html("no translation"),element.attr("data-translated",!0)}}}),TranslationsMap=Class.extend({init:function(){this.translations={}},add:function(id,translations){if(!(translations instanceof Translations))throw"Only Translation instances can be added to translations map";this.translations[id]=translations},get:function(id){return this.translations[id]||new Translations({english:"--missing--"})}}),WFStatistics=Class.extend({init:function(wayfinder){this.wayfinder=wayfinder,this.session_id=0,this.storageSupport="undefined"!=typeof window&&"localStorage"in window&&null!==window.localStorage,this.storagePrefix="wfstats_",this.device_id=0,this.searchPhrase="",this.checkStorage()},start:function(callback){var me=this;"undefined"==typeof screen||this.device_id?"function"==typeof callback&&callback(me.device_id):WayfinderAPI.statistics.device(screen.width,screen.height,this.wayfinder.getKiosk(),function(data){data&&(me.device_id=data.data.id,me.store("deviceId",data.data.id),console.log("Device created",data),"function"==typeof callback)&&callback(me.device_id)},!0)},onSessionStart:function(callback){var me=this,language=this.wayfinder.languages[this.wayfinder.getLanguage()];language&&language.getID()&&this.wayfinder.getKiosk()&&WayfinderAPI.statistics.startSession(language.getID(),this.wayfinder.getKiosk(),this.wayfinder.options.application,this.wayfinder.getLayout(),this.device_id,function(data){try{data&&(me.session_id=data.data),"function"==typeof callback&&callback()}catch(e){console.log("Something went wrong sending startSession")}},!0)},onSessionEnd:function(){var language,scope=this;this.session_id&&(language=this.wayfinder.languages[this.wayfinder.getLanguage()],WayfinderAPI.statistics.endSession(this.session_id,language.getID(),function(){scope.session_id=0,console.log("Session ended!")},!0))},onClick:function(location,type){var scope;this.session_id?WayfinderAPI.statistics.click(location,this.session_id,type,null,!0):(scope=this).onSessionStart(function(){WayfinderAPI.statistics.click(location,scope.session_id,type,null,!0)},!0)},onLanguageChange:function(language){},onSearch:function(searchstring,type){this.session_id?WayfinderAPI.statistics.search(searchstring,this.session_id,type,null,!0):this.onSessionStart(function(){WayfinderAPI.statistics.search(searchstring,this.session_id,type,null,!0)})},checkStorage:function(){this.storageSupport&&(this.deviceId=localStorage.getItem(this.storagePrefix+"deviceId"))},getTime:function(){},store:function(key,value){this.storageSupport&&(localStorage[this.storagePrefix+key]=JSON.stringify(value))},isOnline:function(){}}),WayfinderMonitor=Class.extend({init:function(wayfinder,deviceId){this.wayfinder=wayfinder,this.device_id=deviceId,this.socket=null},start:function(){var scope=this,protocol="https:"===location.protocol?"wss://":"ws://";this.socket=new WebSocket(protocol+WayfinderAPI.LIVE_LOCATION+"monitor/"+this.wayfinder.options.project+"/"+this.device_id),this.socket.addEventListener("open",event=>{console.log("connected")}),this.socket.addEventListener("message",event=>{console.log("Message from server ",event.data);event=JSON.parse(event.data);scope.actOnMessage(event)}),this.socket.addEventListener("ping",()=>{console.log("ping"),this.socket.send("pong")}),this.socket.onclose=function(e){console.log(e,new Date),console.log("Socket is closed. Reconnect will be attempted in 10 second.",e.reason),setTimeout(function(){scope.start()},1e4)},this.socket.onerror=function(err){console.log(err),console.error("Socket encountered error: ",err.message,"Closing socket"),scope.socket.close()},WayfinderAPI.kiosks.start(this.device_id,function(data){})},reload:function(){var url;this.socket.send("refreshing"),URL&&URLSearchParams?((url=new URL(window.location.href)).searchParams.set("wfcache",Date.now()),window.location.replace(url)):window.location.reload()},actOnMessage:function(msg){var scope=this;msg&&"refresh"===msg.type&&(msg.delay&&"now"===msg.delay?this.reload():this.wayfinder.isRunning()?(console.log("WFM: Waiting for map pause to refresh"),this.wayfinder.events.once("map-pause",function(){console.log("WFM: Map paused. Refreshing in 3s"),setTimeout(function(){scope.reload()},3e3)})):setTimeout(function(){console.log("WFM: refreshing now"),scope.reload()},1e3))}}),WayfinderFactory2D=WayfinderFactory.extend({createOverlays:function(overlays){var poi_id,i;if(overlays)for(poi_id in overlays)if(poi_id in this.wayfinder.pois)for(i in this.wayfinder.overlays[poi_id]||(this.wayfinder.overlays[poi_id]=[]),overlays[poi_id])this.wayfinder.overlays[poi_id].push(new Overlay(this.wayfinder.pois[poi_id],overlays[poi_id][i],this.wayfinder.options.map2DRotation))},addNode2DData:function(coordinates){if(this.wayfinder.nodes)for(var i in this.wayfinder.nodes){var coordinate,i=this.wayfinder.nodes[i];coordinates[i.floor_id]&&(coordinate=coordinates[i.floor_id][i.id])&&(i.setPosition2D(coordinate.x,coordinate.y),i.setWeight(coordinate.weight))}},createEdges:function(edges){if(edges)for(var node_id in edges)if(node_id in this.wayfinder.nodes)for(var i in edges[node_id])edges[node_id][i]in this.wayfinder.nodes&&this.wayfinder.nodes[node_id].addNeighbour(this.wayfinder.nodes[edges[node_id][i]])},createNode:function(data){return new NavigationNode2D(data)}}),Wayfinder2D=Wayfinder.extend({init:function(options){options&&options instanceof Wayfinder2DOptions||(options=new Wayfinder2DOptions),this._super(options,new WayfinderFactory2D(this)),this.logicName="2d",this.logic=new WayfinderLogic2D(this,this.logicName),this.overlays={},this.adImage=!1,this.yahImage=!1,this.paused=!1,this.path=!1,this.dehighlightOverlay=!1},onBundleData:function(result){console.log("2D.onBundleData"),this._super(result),this.logic.loadMapData()},isCanvasSupported:function(){var elem=document.createElement("canvas");return!(!elem.getContext||!elem.getContext("2d"))},onPOIsLoaded:function(data){this._super(data),Logistics.getMultiple({nodes_2d:{url:WayfinderAPI.getURL("2d","nodes",[]),type:"json"},overlays:{url:WayfinderAPI.getURL("2d","overlays",[]),type:"json"},location:{url:WayfinderAPI.getURL("building","location",[]),type:"json"},lodcount:{url:WayfinderAPI.getURL("2d","lodcount",[]),type:"json"},"ad-image":{url:"images/ad.png",type:"image"},"yah-image":{url:"images/yah.png",type:"image"}},ClassCallback(this,this.on2DDataLoaded),{stage:"settings"}),this.loadMapImages()},on2DDataLoaded:function(data){console.log("on2DDataLoaded");var nodes=data.nodes_2d.data,overlays=data.overlays.data;this.adImage=data["ad-image"],this.yahImage=this.settings.getInt("kiosk.you-are-here-image",0)?this.settings.getInt("kiosk.you-are-here-image",0):data["yah-image"],this.options.maxLOD=parseInt(data.lodcount.data||1),this.factory.addNode2DData(nodes),this.factory.createOverlays(overlays),this.map.update(!0),this.onDataLoaded(),"function"==typeof cbOnMapReady&&this.cbOnMapReady()},onDataLoaded:function(){this._super()},overrideOptions:function(){this.options.disableMap2DMovement=this.settings.getBoolean("camera.2d.disableMap2DMovement",!1)},setupFloor:function(){var floor=!1;if(this.getKioskNode()&&this.getKioskNode().floor)floor=this.getKioskNode().floor;else{var j,maxIndex=0;for(j in this.building.getFloors())(floor=this.building.getFloors()[j]).index>=maxIndex&&(maxIndex=floor.index)}floor&&this.showFloor(floor)},setDehighlightOverlay:function(val){this.dehighlightOverlay=!!val},fitMultiplePOIsInView:function(pois,maxZoom){this.logic.fitMultiplePOIsInView(pois,maxZoom)}}),WayfinderLogic2D=WayfinderLogic.extend({init:function(wayfinder,name){this._super(wayfinder,name),this.map=wayfinder.map,this.currentFloor=!1,this.factory=new WayfinderFactory2D(this.wayfinder)},cbOnZoomChange:function(){this.events.trigger("zoom-change")},loadMapData:function(){Logistics.getJSON(WayfinderAPI["2d"].pack.url(),null,ClassCallback(this,this.onMapData),{stage:"map"})},onMapData:function(result){var scope=this,result=result.data,yahSetting=(this.factory.addNode2DData(result.nodes),this.factory.createOverlays(result.overlays),this.wayfinder.settings.getInt("kiosk.you-are-here-image",0)),yahSetting=0!==yahSetting?WayfinderAPI.getURL("images","getLarge",[yahSetting]):"images/yah.png",progressTimer=(Logistics.getImage(yahSetting,function(img,b){scope.wayfinder.yahImage=img}),this.wayfinder.options.pathZoomPadding=this.wayfinder.settings.getInt("path.2d.padding",this.wayfinder.options.pathZoomPadding),this.wayfinder.options.maxLOD=Math.max(this.wayfinder.options.maxLOD,parseInt(result.lodcount||1)),this.setup(),this.loadMapImages(),this.wayfinder.resize(),this.wayfinder.events.trigger("map-ready"),this.loadPOIIcons(),this.onDataLoaded(),this.wayfinder.map.start(),this.wayfinder.map.update(!0),this.showKiosk(),null);this.wayfinder.events.on("data-stage-progress",function(stage,progress){clearTimeout(progressTimer),progressTimer=setTimeout(function(){scope.wayfinder.map.update(!0)},500)}),"function"==typeof this.wayfinder.cbOnMapReady&&this.wayfinder.cbOnMapReady()},onDataLoaded:function(){var floor;this._super(),this.wayfinder.getCurrentFloor()&&(this.wayfinder.settings.getBoolean("camera.2d.disablezooming",!1)?this.showKiosk():"object"==typeof(floor=this.wayfinder.building.getFloors()[this.wayfinder.getCurrentFloor().id])&&this.map.fitMultiplePOIsInView(floor.pois))},setup:function(){this.map=new Map2D(this.wayfinder),this.wayfinder.map=this.map,this.map.setup(),this.map.onPOIClick=ClassCallback(this.wayfinder,this.wayfinder.onPOIClick);var scope=this;this.map.getTransformer().cbOnZoomChange=function(){scope.wayfinder.events.trigger("zoom-change")}},loadMapImages:function(){function setImage(image,status,dt){scope.wayfinder.map.addLODImage(dt.params.floor_id,0,0,0,image)}var floor,i,scope=this;for(i in this.wayfinder.building.getFloors())floor=this.wayfinder.building.getFloors()[i],Logistics.getImage(WayfinderAPI.getURL("2d","image",[floor.id]),{floor_id:floor.id},setImage,{stage:"floors"})},setDefaultView:function(zoom){this.wayfinder.pathComponent&&this.wayfinder.pathComponent.clearPath(),this.setKioskView(zoom)},setKioskView:function(zoom){},setNodeView:function(node,zoom,rotate){},showPath:function(sourceNode,endNode,poi,_options,callback){if(sourceNode&&endNode){var scope,pathFinder=new PathFinder2D(this.wayfinder.nodes),_options={displayDestinationOnStart:!(!_options||!_options.displayDestinationOnStart),ignoreTypes:_options&&_options.ignoreTypes?_options.ignoreTypes:[]};if(this.path=pathFinder.find(sourceNode.id,endNode.id,_options),!1!==this.path)return(scope=this).wayfinder.settings.getBoolean("camera.2d.disableMap2DMovement",!1)||this.wayfinder.settings.getBoolean("camera.2d.disableZooming",!1)||this.wayfinder.map.fitPathInView(this.path),this.wayfinder.map.pathRenderer.reset(),this.wayfinder.showFloor(sourceNode.floor),this.wayfinder.map.redraw(),this.wayfinder.map.pathRenderer.setPath(this.path,function(){poi&&(scope.clearHighlights(),scope.clearDisplaying(),scope.setHighlights([poi]),scope.setDisplaying([poi])),scope.wayfinder.map.redraw(),scope.wayfinder.events.trigger("path-finished",scope.path,endNode,poi),"function"==typeof callback&&callback(scope.path,endNode,poi)}),this.path}},findPath:function(fromNode,toNode){if(fromNode&&toNode)return new PathFinder2D(this.wayfinder.nodes).find(fromNode.id,toNode.id)},updatePath:function(startNode,endNode,poi){if(!1!==this.wayfinder.getKiosk()&&!1!==endNode){var scope,pathFinder=new PathFinder2D(this.wayfinder.nodes);if(this.path=pathFinder.find(startNode.id,endNode.id),!1!==this.path)return(scope=this).map.pathRenderer.reset(),this.map.redraw(),this.map.pathRenderer.updatePath(this.path,function(){poi&&(scope.clearHighlights(),scope.setHighlights([poi])),scope.map.redraw(),scope.wayfinder.events.trigger("path-finished",scope.path,endNode,poi)}),this.path;console.log("updatePath","No path found",startNode,endNode)}},getNearestPOI:function(source,pois){source=this.getNearestPOIs(this.wayfinder.nodes[source],pois);return Array.isArray(source)&&0<source.length?source[0]:null},getNearestPOIs:function(source,pois,radius){for(var poi,path,pathFinder=new PathFinder2D(this.wayfinder.nodes),_pois=[],_radius=radius||1/0,i=0,len=pois.length;i<len;i++)(poi=pois[i])&&poi.node&&poi.node.position2d&&(radius&&vec2.dist(source.position2d,poi.node.position2d)>=_radius||((path=pathFinder.find(source.id,poi.node.id))?(path=path.getDistance())<=_radius&&_pois.push({dist:path,poi:poi}):console.log("No path for",poi)));return _pois=(_pois=_pois.sort(function(a,b){return a.dist-b.dist})).map(function(item){return item.poi})},resize:function(){var scale,devicePixelRatio,context;this.map&&(scale=1,this.wayfinder.paused&&this.wayfinder.run(),0<this.wayfinder.options.upscale&&(context=this.map.renderer.context,devicePixelRatio=window.devicePixelRatio||1,context=this.webkitBackingStorePixelRatio||context.mozBackingStorePixelRatio||context.msBackingStorePixelRatio||context.oBackingStorePixelRatio||context.backingStorePixelRatio||1,scale=Math.max(this.wayfinder.options.upscale,Math.round(devicePixelRatio/context*100)/100)),devicePixelRatio=this.getCanvas(),context=window.getComputedStyle(devicePixelRatio.parentNode,null),this.map.resize(devicePixelRatio,parseInt(context.width),parseInt(context.height),scale),this.map.update(!0))},setZoom:function(percentage){this.map.setZoom(percentage),this.map.update(!0)},zoomIn:function(){this.map.zoomIn(),this.map.update(!0)},zoomOut:function(){this.map.zoomOut(),this.map.update(!0)},setHighlights:function(pois){this.map.setHighlights(pois),this.map.update(!0)},clearHighlights:function(){this.map.clearHighlights(),this.map.update(!0)},clearDisplaying:function(){this.map.clearDisplaying(),this.map.update(!0)},setDisplaying:function(pois){this.map.setDisplaying(pois),this.map.update(!0)},showFloor:function(){this.wayfinder.map&&this.wayfinder.map.update(!0)},showKiosk:function(){var floor;!1!==this.wayfinder.getKiosk()&&(this.wayfinder.map.pathRenderer.reset(),this.wayfinder.showFloor(this.wayfinder.getKioskNode().floor),(floor=this.wayfinder.getCurrentFloor())&&(this.wayfinder.settings.getBoolean("kiosk.view.fit-floor-pois",!1)?this.wayfinder.map.fitMultiplePOIsInView(this.wayfinder.building.getFloors()[floor.id].pois):(floor=this.wayfinder.settings.getFloat("kiosk.2d.default-zoom",0),this.setZoom(floor),this.wayfinder.map.center())),this.wayfinder.map.redraw())},clearPath:function(){this.map.pathRenderer.clearPath(),this.map.pathRenderer.reset(),this.map.update(!0)},setLanguage:function(language){this._super(language),this.map.update(!0)},findNearestNodeOnFloor:function(floor,position,hasNeighbours){return this.map.findNearestNodeOnFloor(floor,position,hasNeighbours)},pause:function(){this.wayfinder.paused=!0,this.wayfinder.events.trigger("map-pause")},run:function(){this.wayfinder.paused=!1,this.wayfinder.events.trigger("map-run")},isRunning:function(){return!this.paused},onVisibilityChange:function(){"undefined"!=typeof document&&document.hidden?this.pause():this.run()},getScreenPosition:function(poi){return this.map.getPOIOverlayLocationOnMap(poi)},update:function(full){this.map&&this.map.update(full)},switchCanvas:function(element){this.wayfinder.maps[this.name].canvas=element,this.map.updateCanvas(element),this.resize(),this.map.update(!0)},showPathFromPOIToPOI:function(from,to){if("object"==typeof from&&"object"==typeof to){var scope,pathFinder=new PathFinder2D(this.wayfinder.nodes);if(this.wayfinder.path=pathFinder.find(from.node.id,to.node.id),!1!==this.wayfinder.path)return(scope=this).wayfinder.settings.getBoolean("camera.2d.disableMap2DMovement",!1)||this.wayfinder.settings.getBoolean("camera.2d.disableZooming",!1)||this.map.fitPathInView(this.wayfinder.path),this.wayfinder.map.pathRenderer.reset(),this.wayfinder.setCurrentFloor(from.node.floor),this.wayfinder.map.redraw(),this.wayfinder.map.pathRenderer.setPath(this.wayfinder.path,function(){to&&(scope.clearHighlights(),scope.clearDisplaying(),scope.setHighlights([to]),scope.setDisplaying([to])),scope.wayfinder.map.redraw(),scope.wayfinder.events.trigger("path-finished",scope.path,to.node,to)}),this.wayfinder.path}},onLocationChange:function(location){var node=this.wayfinder.findNearestNodeOnFloor(location.floor,location.location,!0),path=this.path;if(console.log("cbOnLocationChange",location,node,path),node){if(this.wayfinder.setKiosk(node.id),path&&0<path.nodes.length&&!this.map.pathRenderer.animating){this.updatePath(this.wayfinder.getKioskNode(),path.nodes[path.nodes.length-1]);var _nearest=this.getNearestPOIs(node,this.wayfinder.getCurrentFloor().pois,125);if(_nearest&&0<_nearest.length)for(var p,j=0,len=_nearest.length;j<len;j++)p=_nearest[j],-1<"stairs, elevator, elevator".indexOf(p.node.type)&&(p=path.nodes.indexOf(p.node),path.nodes.length>p)&&path.nodes[p+1]}this.map.update(!0),this.wayfinder.events.trigger("location-change",location)}},pathToText:function(path){path=new Pathfinder2D(this.wayfinder.nodes).pathToText(path);return this.textPathSimplification(path)},fitMultiplePOIsInView:function(pois,maxZoom){this.wayfinder.map.fitMultiplePOIsInView(pois,maxZoom)}}),Wayfinder2DOptions=WayfinderOptions.extend({init:function(){this._super(),this.pathDisplayInstructions=!1,this.pathZoomPadding=50,this.pathColor="rgba(255,0,0,0.8)",this.pathPauseTime=2e3,this.pathSpotRadius=3,this.pathStride=10,this.pathSpeed=60,this.poiColor="rgba(100,100,100,0.5)",this.poiRadius=5,this.mapSize=[1024,1024],this.forceFullMapUpdate=!1,this.enableLOD=!0,this.maxLOD=2,this.enableUserLocation=!0,this.overlayHighlightColor="#ff0000dd",this.mapPadding=.1,this.enableUserYAHSetting=!1,this.application="2D",this.pathZoomIn=!1,this.poi2DTitlePadding=12,this.path2DMessageSize=16,this.map2DRotation=0,this.disableMap2DMovement=!1,this.debug=!1,this.debugBeacons=!1,this.debugMouseLocation=!1,this.upscale=1,this.yahRotation=0,this.poi2DTitleWeight="normal"}}),NavigationNode2D=NavigationNode.extend({init:function(nodeData){this._super(nodeData),this.position2d=!1,this.weight=!1,this.neighbours=[]},setPosition2D:function(x,y){this.position2d=vec2.fromValues(parseFloat(x),parseFloat(y))},setWeight:function(weight){this.weight=parseFloat(weight)},addNeighbour:function(node){node instanceof NavigationNode2D&&this.neighbours.push(node)}}),Overlay=Class.extend({init:function(poi,overlayData,rotate){this.visible="1"==overlayData.visible,this.polygon=this.createPolygon(overlayData.polygon),this.poi=poi,this.rotate=rotate||0,this.bounds=this.calculateBounds(this.polygon,0),this.longestEdge=this.findLongestEdge(this.polygon)},createPolygon:function(data){var polygon=[];if(data)for(var i=0;i<data.length;i++)data[i]&&data[i].x&&data[i].y&&polygon.push(vec2.fromValues(data[i].x,data[i].y));return polygon},contains:function(pt){var i,j,c=!1;if(this.bounds[0]<=pt[0]&&pt[0]<=this.bounds[0]+this.bounds[2]&&pt[1]>=this.bounds[1]&&pt[1]<=this.bounds[1]+this.bounds[3])for(i=0,j=this.polygon.length-1;i<this.polygon.length;j=i++)this.polygon[i][1]>pt[1]!=this.polygon[j][1]>pt[1]&&pt[0]<(this.polygon[j][0]-this.polygon[i][0])*(pt[1]-this.polygon[i][1])/(this.polygon[j][1]-this.polygon[i][1])+this.polygon[i][0]&&(c=!c);return c},calculateBounds:function(polygon,rotation){if(!polygon)return!1;for(var point,minX=1/0,minY=1/0,maxX=-1/0,maxY=-1/0,i=0;i<polygon.length;i++)point=polygon[i],rotation&&(point=this.rotatePoint(point,rotation)),minX=Math.min(minX,point[0]),minY=Math.min(minY,point[1]),maxX=Math.max(maxX,point[0]),maxY=Math.max(maxY,point[1]);return[(point=this.rotatePoint(vec2.fromValues(minX,minY),-rotation))[0],point[1],maxX-minX,maxY-minY,maxX,maxY]},calculateArea:function(points){for(var point1,point2,area=0,i=0,j=points.length-1;i<points.length;j=i,i++)point1=points[i],point2=points[j],area=(area+=point1[0]*point2[1])-point1[1]*point2[0];return area/=2},calculateCenter:function(points){for(var total=vec2.create(),i=0;i<points.length;i++)vec2.add(total,total,points[i]);return vec2.divide(total,total,vec2.fromValues(points.length,points.length))},findLongestEdge:function(poly,options){var tempLen,longest=null,longestObj=null,longestLength=-1/0;poly.push(poly[0]),simplPoly=this.simplifyPoly(poly,.1);for(var dir,horizontal,left,deltaY,cw,j=0;j<simplPoly.length-1;j++)longestLength<(tempLen=Math.abs(vec2.distance(simplPoly[j],simplPoly[j+1])))&&(longest=[simplPoly[j],simplPoly[j+1]],longestLength=tempLen);return longest&&1<longestLength?(poly=longest[0][0]<longest[1][0]?longest[1][0]-longest[0][0]:longest[0][0]-longest[1][0],deltaY=longest[0][0]<longest[1][0]?longest[1][1]-longest[0][1]:longest[0][1]-longest[1][1],angle=Math.atan2(deltaY,poly)*(180/Math.PI),deltaY=[(this.bounds[0]+this.bounds[4])/2,(this.bounds[1]+this.bounds[5])/2],poly=vec2.add(vec2.create(),longest[0],longest[1]),vec2.scale(poly,poly,.5),deltaY=vec2.sub(vec2.create(),deltaY,poly),vec2.normalize(deltaY,deltaY),dir=0,cw=angle<45||225<angle,horizontal=135<Math.abs(angle)&&Math.abs(angle)<225||Math.abs(angle)<45,left=deltaY[0]<0,deltaY=deltaY[1]<0,(cw&&deltaY&&horizontal||cw&&left&&!horizontal||!(cw||left||horizontal))&&(dir=180),deltaY=this.findInnerBounds(simplPoly,longest,dir-angle,Math.min(this.bounds[2],this.bounds[3]),poly),cw=vec2.create(),vec2.add(cw,deltaY[1],deltaY[0]),vec2.scale(cw,cw,.5),angle,(angle=Math.abs(angle)<10&&0<Math.abs(angle)?0:angle)<180&&170<angle&&(angle=0),80<Math.abs(angle)&&Math.abs(angle)<100&&(angle=-90),{width:Math.abs(deltaY[0][0]-deltaY[1][0]),height:Math.abs(deltaY[0][1]-deltaY[1][1]),rotateWidth:deltaY[2],rotateHeight:deltaY[3],edge:deltaY,center:cw,angle:-angle%180*(Math.PI/180),bounds:this.bounds,longest:longest}):longestObj},simplifyPoly:function(points,angle){for(var point,_angle,prevPoint=points[0],newPoints=[prevPoint],a=vec2.create(),b=vec2.create(),i=1,len=points.length;i<len-1;i++)point=points[i],a=vec2.sub(a,prevPoint,point),b=vec2.sub(b,point,points[i+1]),angle<(_angle=(_angle=Math.abs(Math.atan2(a[0]*b[1]-a[1]*b[0],a[0]*b[0]+a[1]*b[1])))>=Math.PI?Math.abs(_angle/(Math.PI/2)-parseInt(_angle/(Math.PI/2)))*(Math.PI/2):_angle)&&(newPoints.push(point),prevPoint=point);return newPoints.push(points[points.length-1]),newPoints},findInnerBounds:function(_poly,edge,angle,maxDist,_midpoint){var _p,_p2,rx,rx2,ydiff,debug="KEI"==this.poi.getName("en"),first=(angle*=Math.PI/180,(edge[0][0]<edge[1][0]?edge[0]:edge[1]).slice()),edge=(edge[0][0]<edge[1][0]?edge[1]:edge[0]).slice(),origin=first.slice(),poly=((edge=this.rotatePoint(edge,angle,origin))[1]+=maxDist,this.rotatePoly(_poly.slice(),angle,origin)),minX=Math.min(first[0],edge[0]),minY=Math.min(first[1],edge[1]),maxX=Math.max(first[0],edge[0]),maxY=0,heightGram=(debug&&console.log(this.poi.getName("en"),"newPoly",this.polyToString(poly),"minmax",this.polyToString([[minX,minY],[maxX,maxY]])),{});function setHeight(rx,y){minY<y&&(heightGram[rx]||(heightGram[rx]=1/0),heightGram[rx]=Math.min(heightGram[rx],y-minY))}if(4<poly.length){for(var DECI=Math.ceil(100/(maxX-minX)),p=0;p<poly.length-1;p++)if(_p=poly[p],_p2=poly[p+1],_p[1]<=minY&&(minX=Math.min(minX,_p[0]),maxX=Math.max(maxX,_p[0])),_p[1]>=minY)if(maxY=Math.max(maxY,_p[1]),rx=Math.floor(_p[0]*DECI),rx2=Math.floor(_p2[0]*DECI),setHeight(rx,_p[1]),1<Math.abs(rx2-rx)){ydiff=_p2[1]-_p[1],debug&&console.log(this.poi.getName("en"),"gap",rx,rx2,ydiff,rx2-rx);for(var i=0,y=(rx<rx2?_p:_p2)[1],nk=Math.min(rx,rx2)+1;nk<Math.max(rx,rx2);nk++)setHeight(nk,y+ ++i*(ydiff/(rx2-rx)))}else debug&&console.log(this.poi.getName("en"),"no gap?",rx,rx2,rx2-rx);for(var maxXX,maxYY,lastVal=0,maxLen=0,curLen=0,lastX=-1/0,last=!1,maxAreaX=-1/0,minXX=minX,maxArea=0,i=Math.floor(minX*DECI);i<=Math.floor(maxX*DECI);i++)if(heightGram[i]){for(var maxLen=0,curLen=0,lastVal=0,last=!1,j=Math.floor(minX*DECI);j<=Math.floor(maxX*DECI);j++)(lastVal=heightGram[j]?heightGram[j]:lastVal)>=heightGram[i]?(last||(lastX=j),curLen++,last=!0):(maxLen<=curLen&&(maxLen=curLen/DECI,maxAreaX=lastX/DECI),last=!1,curLen=0);0==maxLen&&0<curLen&&lastX!=-1/0&&(maxLen=curLen/DECI,maxAreaX=lastX/DECI),0<maxLen&&maxLen*heightGram[i]>maxArea&&(maxArea=maxLen*heightGram[i],maxXX=(minXX=maxAreaX)+maxLen,maxYY=heightGram[i])}0<maxArea?(minX=minXX,maxX=maxXX,maxY=minY+maxYY):console.log(this.poi.getName("en"),"no max area",maxArea,minXX,maxXX,maxYY),debug&&(console.log(this.poi.getName("en"),"heightGram",this.polyToString(Object.entries(heightGram).map((i,v)=>[parseInt(i[0])/DECI,minY+i[1]]))),console.log(this.poi.getName("en"),"area",maxArea,minXX,maxXX,maxYY))}return[this.rotatePoint([minX,minY],-angle,origin),this.rotatePoint([maxX,maxY],-angle,origin),Math.abs(maxX-minX),Math.abs(maxY-minY)]},polyToString:function(poly){var str="";for(p in poly)str+="("+poly[p][0]+", "+poly[p][1]+"),";return str},isPointBetween:function(p,a,b){return(a.x<=p.x&&p.x<=b.x||a.x>=p.x&&p.x>=b.x)&&(a.y<=p.y&&p.y<=b.y||a.y>=p.y&&p.y>=b.y)},rotatePoint:function(p,alpha,origin){xshifted=p[0]-(origin=null==origin?[0,0]:origin)[0],p=p[1]-origin[1];var cosAlpha,xshifted,x=(cosAlpha=Math.cos(alpha))*xshifted-(alpha=Math.sin(alpha))*p+origin[0],alpha=alpha*xshifted+cosAlpha*p+origin[1];return vec2.fromValues(x,Math.floor(1e7*alpha)/1e7)},rotatePoly:function(poly,alpha,origin){for(var results=[],j=0,len=poly.length;j<len;j++)results.push(this.rotatePoint(poly[j],alpha,origin));return results},rotateVector:function(vec,ang){ang=-ang*(Math.PI/180);var cos=Math.cos(ang),ang=Math.sin(ang);return vec2.fromValues(Math.round(1e4*(vec[0]*cos-vec[1]*ang))/1e4,Math.round(1e4*(vec[0]*ang+vec[1]*cos))/1e4)},getOrientation:function(p1,p2,p){p=(p2[0]-p1[0])*(p[1]-p1[1])-(p[0]-p1[0])*(p2[1]-p1[1]);return 0<p?-1:p<0?1:0},getBounds:function(){return this.bounds},getRotatedAreaBounds:function(){return this.rotatedAreaBounds}}),Renderer2D=Class.extend({init:function(renderQueue){this.wayfinder=!1,this.context=!1,this.enabled=!0,this.damaged=!0,this.renderQueue=renderQueue,this.parent=!1},onAdd:function(){},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},damage:function(){this.parent&&this.parent.damage(this)},undamage:function(){this.damaged=!1},setContext:function(context){this.context=context},setWayfinder:function(wayfinder){this.wayfinder=wayfinder},setParent:function(parent){this.parent=parent},render:function(rect){}}),FloorRenderer2D=Renderer2D.extend({init:function(){this._super(1),this.lod=0,this.debugPoint=vec2.create(),this.mapImages=[]},setLOD:function(lod){this.lod=lod},getLOD:function(){return lod},getRequiredTiles:function(rect){for(var tiles=[],splitTo=Math.pow(2,this.lod),width=this.wayfinder.options.mapSize[0]/splitTo,height=this.wayfinder.options.mapSize[1]/splitTo,x=0;x<splitTo;x++)for(var y=0;y<splitTo;y++){var r=new Rectangle(x*width,y*height,width,height);rect.intersects(r)&&tiles.push(vec2.fromValues(x,y))}return tiles},clear:function(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height)},renderDefault:function(){this.clear();var T=this.wayfinder.map.getTransformer(),image=this.wayfinder.map.getCurrentLOD(0,0,0);image&&(this.context.save(),this.context.translate(T.getViewWidth()/2,T.getViewHeight()/2),this.context.rotate(this.wayfinder.options.map2DRotation*Math.PI/180),this.context.translate(-T.getViewWidth()/2,-T.getViewHeight()/2),this.context.translate(T.getZoomedMapPosition()[0],T.getZoomedMapPosition()[1]),this.context.scale(T.getZoom(),T.getZoom()),this.context.drawImage(image,0,0),this.context.restore())},renderTile:function(tile){var T,width,splitTo;!1!==tile.image&&(T=this.wayfinder.map.getTransformer(),splitTo=Math.pow(2,this.lod),width=this.wayfinder.options.mapSize[0]/splitTo,splitTo=this.wayfinder.options.mapSize[1]/splitTo,this.context.save(),this.context.translate(T.getViewWidth()/2,T.getViewHeight()/2),this.context.rotate(this.wayfinder.options.map2DRotation*Math.PI/180),this.context.translate(-T.getViewWidth()/2,-T.getViewHeight()/2),this.context.translate(T.getZoomedMapPosition()[0],T.getZoomedMapPosition()[1]),this.context.drawImage(tile.image,tile.x*width*T.getZoom(),tile.y*splitTo*T.getZoom(),width*T.getZoom(),splitTo*T.getZoom()),this.context.restore())},render:function(rect){if(this.wayfinder.getCurrentFloor()){var T=this.wayfinder.map.getTransformer();if(0!==this.lod&&this.wayfinder.options.enableLOD){for(var tiles=[],requiredTiles=this.getRequiredTiles(rect),fallbackNeeded=!1,i=0;i<requiredTiles.length;i++){var tile=this.wayfinder.map.getCurrentLOD(this.lod,requiredTiles[i][0],requiredTiles[i][1]);tiles.push({x:requiredTiles[i][0],y:requiredTiles[i][1],image:tile}),!1===tile&&(fallbackNeeded=!0)}if(fallbackNeeded)return this.renderDefault();for(this.clear(),i=0;i<requiredTiles.length;i++)this.renderTile(tiles[i])}else this.renderDefault();this.wayfinder.options.debugMouseLocation&&(this.context.save(),rect=T.transformPoint(this.debugPoint),this.context.beginPath(),this.context.fillStyle="rgba(255,0,0,0.7)",this.context.arc(rect[0],rect[1],5,0,2*Math.PI,!0),this.context.closePath(),this.context.fill(),this.context.restore())}}}),POIsRenderer2D=Renderer2D.extend({init:function(){this._super(4)},onAdd:function(){this.overlayColor=this.wayfinder.settings.getColor("poi.2d.overlay.color",this.wayfinder.options.overlayHighlightColor),this.drawAlwaysNames=this.wayfinder.settings.getBoolean("poi.2d.display-names-always",!1),this.overlayColorFromGroup=this.wayfinder.settings.getBoolean("poi.2d.overlay-group-color",!1),this.nameBackgroundColor=this.wayfinder.settings.getColor("poi.2d.name.background-color","#ffffff"),this.nameFontSize=this.wayfinder.settings.getInt("poi.2d.name.font-size",12),this.nameFontFamily=this.wayfinder.settings.get("poi.text.font-family","Arial"),this.displayRoomID=this.wayfinder.settings.get("poi.2d.name.display-room-id",!0),this.fontPadding=this.wayfinder.settings.getInt("poi.2d.name.padding",this.wayfinder.options.poi2DTitlePadding),this.drawSpot=this.wayfinder.settings.getBoolean("poi.2d.display-node-dot",!1),this.dehighlightOverlayColor=this.wayfinder.settings.getColor("poi.dehighlight.overlay_color","#000000CC")},render:function(rect){var floor=this.wayfinder.map.getCurrentFloor(),scope=this,showOnlyName=this.wayfinder.settings.getBoolean("poi.map.only-text",!1);if(floor&&floor.nodes){var T=this.wayfinder.map.getTransformer(),later=[];this.context.save();for(var i=0;i<floor.nodes.length;i++)if(0!==floor.nodes[i].pois.length){var hasAd=!1,pt=T.transformPoint(floor.nodes[i].position2d),poi=!1;if(0<=pt[0]&&pt[0]<=T.getViewWidth()&&0<=pt[1]&&pt[1]<=T.getViewHeight()){for(var j=0;j<floor.nodes[i].pois.length;j++)poi=floor.nodes[i].pois[j],this.isPOIinDisplaying(poi)||this.isPOIinHighlights(poi)?later.push({poi:poi,pt:pt}):renderPOI(poi,pt);!poi.showInMenu&&this.drawSpot&&(this.context.beginPath(),this.context.fillStyle=this.wayfinder.options.poiColor,this.context.arc(pt[0],pt[1],this.wayfinder.options.poiRadius,0,2*Math.PI,!0),this.context.closePath(),this.context.fill()),this.wayfinder.adImage&&hasAd&&this.context.drawImage(this.wayfinder.adImage,pt[0]-1.5*this.wayfinder.options.poiRadius,pt[1]-1.5*this.wayfinder.options.poiRadius,3*this.wayfinder.options.poiRadius,3*this.wayfinder.options.poiRadius)}}this.wayfinder.dehighlightOverlay&&(this.context.fillStyle=this.dehighlightOverlayColor,this.context.fillRect(0,0,T.getViewWidth(),T.getViewHeight()));for(var l=0;l<later.length;l++)renderPOI(later[l].poi,later[l].pt);this.context.restore()}function renderPOI(poi,pt){if("object"==typeof poi){var hideAlways=!1;if(poi.alwaysVisible&&poi.id in scope.wayfinder.overlays&&!scope.isPOIinHighlights(poi)){var overlay=scope.wayfinder.overlays[poi.id];if(overlay&&0<overlay.length)for(var o in overlay)if(scope.sameOverlay(overlay[o],poi)){hideAlways=!0;break}}0<poi.getAdvertisements().length?hasAd=!0:(showOnlyName=scope.wayfinder.settings.getBoolean("poi.map.only-text",!1,poi),(poi.alwaysVisible&&!hideAlways||scope.isPOIinDisplaying(poi))&&(showOnlyName&&poi.showInMenu?scope.renderPOIName(poi,pt):0===poi.image_id||showOnlyName?poi.hasName(scope.wayfinder.getLanguage())&&scope.renderPOIName(poi,pt):scope.renderPOIIcon(poi,pt)))}}},isPOIinHighlights:function(poi){if(poi)for(var i in this.wayfinder.map.highlights)if(this.wayfinder.map.highlights[i].id==poi.id)return!0;return!1},isPOIinDisplaying:function(poi){for(var i in this.wayfinder.map.displaying)if(this.wayfinder.map.displaying[i].id===poi.id)return!0;return!1},sameOverlay:function(overlay,poi){var _other,i;for(i in this.wayfinder.map.displaying)if((_other=this.wayfinder.map.displaying[i])!==poi&&_other.getNode()&&_other.getNode().floor==poi.getNode().floor&&this.wayfinder.overlays[_other.id])for(var o in this.wayfinder.overlays[_other.id])if(JSON.stringify(this.wayfinder.overlays[_other.id][o].bounds)==JSON.stringify(overlay.bounds))return!0;return!1},renderPOIIcon:function(poi,pt){var T,iconWidth,iconHeight,ratio,width,height,offsetX,offsetY,offsetRotation,poiScale,poiHighlightScale,flip,alignLongest,tintedIcon,highlightTint,highlightInvert,poiInHighlights,rotation,fitToOverlay,overlayHeight,newAngle,squarish,bigEnough,canvas,ctx,overlay;poi&&poi.getIcon()&&(T=this.wayfinder.map.getTransformer(),overlay=this.wayfinder.overlays[poi.id],iconWidth=poi.getIcon().width,ratio=(iconHeight=poi.getIcon().height)/iconWidth,height=(width=Math.floor(this.wayfinder.settings.getInt("poi.2d.icon-size",this.wayfinder.options.poiRadius,poi)))*ratio,offsetX=this.wayfinder.settings.getInt("poi.map.offset-x",0,poi),offsetY=this.wayfinder.settings.getInt("poi.map.offset-y",0,poi),offsetRotation=this.wayfinder.settings.getInt("poi.map.rotation",0,poi),poiScale=this.wayfinder.settings.getFloat("poi.map.scale",1,poi),poiHighlightScale=this.wayfinder.settings.getFloat("poi.2d.icon-highlight-scale",1.1,poi),flip=180<=this.wayfinder.options.map2DRotation?-1:1,alignLongest=this.wayfinder.settings.get("poi.map.align-longest-edge",!1,poi),fitToOverlay=this.wayfinder.settings.getBoolean("poi.2d.fit-to-overlay",!1,poi),tintedIcon=this.wayfinder.settings.getBoolean("poi.2d.tint_logo",!1,poi),highlightTint=this.wayfinder.settings.getBoolean("poi.2d.tint-highlighted",!1,poi),highlightInvert=this.wayfinder.settings.getBoolean("poi.2d.invert-highlighted",!0,poi),this.wayfinder.settings.getColor("poi.2d.name.highlight-color","#000000",poi),poiInHighlights=this.isPOIinHighlights(poi),rotation=0,overlay&&0<overlay.length&&(overlay=overlay[0].longestEdge)&&fitToOverlay&&(fitToOverlay=Math.floor(.9*(alignLongest?overlay.rotateWidth:overlay.width)),overlayHeight=Math.floor(.9*(alignLongest?overlay.rotateHeight:overlay.height)),newAngle=overlay.angle,0!==this.wayfinder.options.map2DRotation&&this.wayfinder.options.map2DRotation<180?rotation=this.wayfinder.options.map2DRotation*(Math.PI/180):180<=this.wayfinder.options.map2DRotation&&(rotation=this.wayfinder.options.map2DRotation*(Math.PI/180)-Math.PI),squarish=0==Math.round(100*(Math.round(Math.abs(newAngle)/(Math.PI/2))-Math.abs(newAngle)/(Math.PI/2))),(bigEnough=width<Math.min(fitToOverlay,overlayHeight)&&squarish)&&(newAngle=0),pt=T.transformPoint(overlay.center),iconHeight<=iconWidth?overlayHeight<=fitToOverlay?height=(width*=Math.min(1,overlayHeight/height,fitToOverlay/width))*ratio:(width=(height*=Math.min(1,overlayHeight/height,fitToOverlay/width))/ratio,bigEnough&&squarish||!alignLongest||(rotation+=(newAngle<0?-1:1)*(Math.PI/2))):overlayHeight<=fitToOverlay?width=(height=Math.min(height,overlayHeight))/ratio:(height=(width=Math.min(width,fitToOverlay))*ratio,bigEnough&&squarish||!alignLongest||(rotation+=(newAngle<0?-1:1)*(Math.PI/2))),alignLongest)&&(rotation-=newAngle),rotation+=offsetRotation*(Math.PI/180),poiInHighlights&&(width*=poiHighlightScale,height*=poiHighlightScale,tintedIcon=highlightTint),width*=poiScale*T.getZoom(),height*=poiScale*T.getZoom(),overlay=vec2.fromValues(offsetX,offsetY),overlay=T.rotatePoint(overlay,-rotation),this.context.save(),(pt=alignLongest?(this.context.rotate(rotation),T.rotatePoint(pt,-rotation)):T.rotatePointAroundCenter(pt,T.transformPoint([512,512]),-rotation))[0]+=overlay[0]*T.getZoom()*flip,pt[1]-=overlay[1]*T.getZoom()*flip,tintedIcon&&poiInHighlights?(null==poi.iconTinted&&((canvas=document.createElement("canvas")).width=iconWidth,canvas.height=iconHeight,(ctx=canvas.getContext("2d")).drawImage(poi.getIcon(),0,0),ctx.globalCompositeOperation="multiply",ctx.fillStyle=this.wayfinder.settings.getColor("poi.2d.tint_logo_color","#fff",poi),ctx.fillRect(0,0,canvas.width,canvas.height),ctx.globalCompositeOperation="destination-in",ctx.drawImage(poi.getIcon(),0,0),poi.iconTinted=canvas),this.context.drawImage(poi.iconTinted,Math.round(pt[0]-width/2),Math.round(pt[1]-height/2),Math.round(width),Math.round(height))):highlightInvert&&poiInHighlights?(null==poi.iconInverted&&((canvas=document.createElement("canvas")).width=iconWidth,canvas.height=iconHeight,(ctx=canvas.getContext("2d")).filter?ctx.filter="invert(1)":console.warn("no filter"),ctx.drawImage(poi.getIcon(),0,0),poi.iconInverted=canvas),this.context.drawImage(poi.iconInverted,Math.round(pt[0]-width/2),Math.round(pt[1]-height/2),Math.round(width),Math.round(height))):this.context.drawImage(poi.getIcon(),Math.round(pt[0]-width/2),Math.round(pt[1]-height/2),Math.round(width),Math.round(height)),this.context.restore())},renderPOIName:function(poi,pt){var name=poi.getName(this.wayfinder.getLanguage());if("string"==typeof name){var alignLongest,newAngle,squarish,fontWeight=this.wayfinder.settings.get("poi.2d.name.weight",this.wayfinder.options.poi2DTitleWeight,poi),offsetRotation=this.wayfinder.settings.getInt("poi.map.rotation",0,poi),offsetX=this.wayfinder.settings.getInt("poi.map.offset-x",0,poi),offsetY=this.wayfinder.settings.getInt("poi.map.offset-y",0,poi),poiScale=this.wayfinder.settings.getFloat("poi.map.scale",1,poi),roundness=this.wayfinder.settings.getFloat("poi.2d.name.padding",5,poi),fitToOverlay=this.wayfinder.settings.getBoolean("poi.2d.fit-to-overlay",!1),T=this.wayfinder.map.getTransformer(),fontSize=Math.floor(this.nameFontSize),mapRotate=this.wayfinder.options.map2DRotation,flip=180<=mapRotate?-1:1,overlay=(this.context.font=fontWeight+" "+fontSize+"px "+this.nameFontFamily,this.context.textAlign="center",this.wayfinder.overlays[poi.id]),textWidth=this.context.measureText(name).width+2*roundness,textHeight=fontSize+2*roundness,lineSpacing=0*fontSize,wrap=this.wayfinder.settings.getInt("poi.text.wrap",-1,poi),lines=[name.replace("&shy;","")],rotation=0;if(-1<wrap){for(var lines=poi.getLines(this.wayfinder.getLanguage(),wrap),textWidth=0,textHeight=2*roundness,i=0;i<lines.length;i++)textWidth=Math.max(textWidth,this.context.measureText(lines[i]).width),textHeight+=fontSize+lineSpacing;textWidth+=2*roundness}overlay&&0<overlay.length&&(wrap=overlay[0].longestEdge)&&fitToOverlay&&(overlay=.9*((alignLongest=this.wayfinder.settings.get("poi.map.align-longest-edge",!1,poi))?wrap.rotateWidth:wrap.width),fitToOverlay=.9*(alignLongest?wrap.rotateHeight:wrap.height),newAngle=wrap.angle,pt=T.transformPoint(wrap.center),squarish=0==Math.round(100*(Math.round(Math.abs(newAngle)/(Math.PI/2))-Math.abs(newAngle)/(Math.PI/2))),(wrap=textWidth<wrap.width)&&squarish&&(newAngle=0),textHeight<=textWidth?fitToOverlay<=overlay?fontSize=Math.floor(this.nameFontSize*(Math.min(textWidth,overlay)/textWidth)):(fontSize=Math.floor(this.nameFontSize*(Math.min(fitToOverlay,textWidth)/textWidth)),wrap&&squarish||!alignLongest||(rotation+=(newAngle<0?-1:1)*(Math.PI/2))):fitToOverlay<=overlay?fontSize=Math.floor(this.nameFontSize*(overlay/textHeight)):(fontSize=Math.floor(this.nameFontSize*(Math.min(fitToOverlay,textWidth)/textWidth)),wrap&&squarish||!alignLongest||(rotation+=(newAngle<0?-1:1)*(Math.PI/2))),alignLongest&&(rotation-=newAngle),0!==mapRotate&&mapRotate<180?rotation+=mapRotate*(Math.PI/180):180<=mapRotate&&(rotation+=mapRotate*(Math.PI/180)-Math.PI)),rotation+=offsetRotation*(Math.PI/180),textHeight=textWidth=0;var offset=vec2.fromValues(offsetX,offsetY);offset=T.rotatePoint(offset,-rotation),this.context.save(),(pt=alignLongest?(this.context.rotate(rotation),T.rotatePoint(pt,-rotation)):T.rotatePointAroundCenter(pt,T.transformPoint([512,512]),-rotation))[0]+=offset[0]*T.getZoom()*flip,pt[1]-=offset[1]*T.getZoom()*flip,fontSize*=T.getZoom()*poiScale,this.context.textBaseline="middle",this.context.font=fontWeight+" "+fontSize+"px "+this.nameFontFamily;for(i=0;i<lines.length;i++)textWidth=Math.max(textWidth,this.context.measureText(lines[i]).width),textHeight+=fontSize+lineSpacing;metrics=this.context.measureText(name);overlay=textWidth+2*roundness,fitToOverlay=textHeight+2*roundness,offset=1==lines.length?0:textHeight/2-fontSize/2;if(5<fontSize){0<this.nameBackgroundColor.a&&this.roundedRect(this.context,pt[0]-overlay/2,pt[1]-fitToOverlay/2,overlay,fitToOverlay,roundness,this.nameBackgroundColor.toString());wrap=this.wayfinder.settings.getColor("poi.2d.name.color","#000000",poi);this.isPOIinHighlights(poi)&&(wrap=this.wayfinder.settings.getColor("poi.2d.name.highlight-color","#000000",poi)),this.context.fillStyle=wrap;for(var j=0;j<lines.length;j++)this.context.fillText(lines[j],pt[0],pt[1]-offset),offset-=fontSize+lineSpacing}this.context.restore()}},measureText:function(){},roundedRect:function(ctx,x,y,width,height,radius,color){ctx.beginPath(),ctx.moveTo(x,y+radius),ctx.lineTo(x,y+height-radius),ctx.quadraticCurveTo(x,y+height,x+radius,y+height),ctx.lineTo(x+width-radius,y+height),ctx.quadraticCurveTo(x+width,y+height,x+width,y+height-radius),ctx.lineTo(x+width,y+radius),ctx.quadraticCurveTo(x+width,y,x+width-radius,y),ctx.lineTo(x+radius,y),ctx.quadraticCurveTo(x,y,x,y+radius),ctx.fillStyle=color,ctx.fill()},renderRotatedAreaBounds:function(ctx,bounds,color,name){var T=this.wayfinder.map.getTransformer(),a=T.transformPoint(bounds[0]),b=vec2.add(vec2.create(),a,bounds[1]),c=(vec2.scale(b,b,T.getZoom()),T.transformPoint(bounds[1]));T.transformPoint(bounds[0]),T.transformPoint(bounds[1]);this.context.beginPath(),this.context.fillStyle="rgba(255, 0, 0, 1.0)",this.context.arc(a[0],a[1],5*T.getZoom(),0,2*Math.PI,!0),this.context.closePath(),this.context.fill(),this.context.beginPath(),this.context.fillStyle="rgba(0, 255, 0, 1.0)",this.context.arc(b[0],b[1],3*T.getZoom(),0,2*Math.PI,!0),this.context.closePath(),this.context.fill(),this.context.beginPath(),this.context.fillStyle="rgba(0, 0, 255, 1.0)",this.context.arc(c[0],c[1],3*T.getZoom(),0,2*Math.PI,!0),this.context.closePath(),this.context.fill()},calcNiceAngle:function(angle,name){var pis=(angle=angle>Math.PI/2?Math.PI-angle:angle)/(Math.PI/2),nearAng=Math.round(pis)-pis;return angle=Math.abs(nearAng)<.27?Math.round(pis)*(Math.PI/2):angle},nearPI:function(angle){angle/=Math.PI/2,angle=Math.round(angle)-angle;return Math.abs(angle)<.27},getBoundsMidPoint:function(bounds){var vec=vec2.sub(vec2.create(),bounds[1],bounds[0]),cross=(vec2.scale(vec,vec,.5),vec2.fromValues(-vec[1],vec[0])),bounds=(vec2.normalize(cross,cross),vec2.scale(cross,cross,bounds[2]/2),vec2.add(vec2.create(),bounds[0],vec));return vec2.sub(bounds,bounds,cross),bounds},getPOILocationOnMap:function(poi){var T=this.wayfinder.map.getTransformer(),poi=T.transformPoint(poi.getNode().position2d);return 0<=poi[0]&&poi[0]<=T.getViewWidth()&&0<=poi[1]&&poi[1]<=T.getViewHeight()&&T.inverseScale(poi)},getPOIOverlayLocationOnMap:function(poi){var T,overlay=this.wayfinder.overlays[poi.id];return overlay&&0<overlay.length&&(overlay=overlay[0],0<=(overlay=(T=this.wayfinder.map.getTransformer()).transformPoint(vec2.fromValues(overlay.bounds[0]+overlay.bounds[2]/2,overlay.bounds[1]+overlay.bounds[3]/2)))[0])&&overlay[0]<=T.getViewWidth()&&0<=overlay[1]&&overlay[1]<=T.getViewHeight()?T.inverseScale(overlay):this.getPOILocationOnMap(poi)},renderPolygon:function(polygon,color,angle){var T=this.wayfinder.map.getTransformer(),pt=T.transformPoint(vec2.fromValues(polygon[0][0],polygon[0][1]));this.context.fillStyle=color,this.context.beginPath(),angle&&(pt=T.rotatePoint(pt,angle)),this.context.moveTo(pt[0],pt[1]);for(var i=0;i<polygon.length;i++)pt=T.transformPoint(vec2.set(pt,polygon[i][0],polygon[i][1])),angle&&(pt=T.rotatePoint(pt,angle)),this.context.lineTo(pt[0],pt[1]);this.context.closePath(),this.context.fill()},drawRectangle:function(ctx,point,width,height,rotation,color){var T=this.wayfinder.map.getTransformer();point=T.transformPoint(point),rotation=rotation||0,width*=T.getZoom(),height*=T.getZoom(),ctx.save(),ctx.strokeStyle=color,ctx.translate(point[0],point[1]),ctx.rotate(rotation),ctx.rect(0,0,width,height),ctx.stroke(),ctx.restore()},drawPoint:function(point,radius,color){var T=this.wayfinder.map.getTransformer();this.context.beginPath(),this.context.fillStyle=color,this.context.arc(point[0],point[1],radius*T.getZoom(),0,2*Math.PI,!0),this.context.closePath(),this.context.fill()}}),PathRenderer2D=Renderer2D.extend({init:function(){this._super(3),this.spots=[],this.position=0,this.timer=!1,this.animating=!1,this.paused=!1,this.msgOffset=vec2.fromValues(0,10),this.message="",this.messagePosition=vec2.fromValues(0,0)},onAdd:function(){this.spotColor=this.wayfinder.settings.getColor("path.2d.color","rgba(255,0,0,0.8)"),this.pathPauseTime=this.wayfinder.settings.getInt("path.2d.pause-time",this.wayfinder.options.pathPauseTime),this.messageSize=this.wayfinder.settings.getInt("path.2d.message-size",this.wayfinder.options.path2DMessageSize),this.spotSize=this.wayfinder.settings.getFloat("path.2d.size",this.wayfinder.options.pathSpotRadius),this.pathSpeed=this.wayfinder.settings.getFloat("path.2d.speed",this.wayfinder.options.pathSpeed),this.pathStride=this.wayfinder.settings.getFloat("path.2d.stride",this.wayfinder.options.pathStride),this.spotSize<.1&&(this.spotSize=.1),this.pathSpeed<.05&&(this.pathSpeed=.05),this.pathStride<.05&&(this.pathStride=.05)},reset:function(){this.position=0},generatePath:function(path){this.spots=[];for(var spot,a,b,dir,length,offset=0,step=this.pathStride,i=1,len=path.nodes.length;i<len;i++)if(a=path.nodes[i-1],b=path.nodes[i],dir=vec2.normalize(vec2.create(),vec2.subtract(vec2.create(),b.position2d,a.position2d)),length=vec2.distance(a.position2d,b.position2d),"portal"===a.type&&"portal"===b.type)this.spots.push({floor:a.floor,position:a.position2d,node:a});else for(var pos=offset;pos<length;pos+=step)spot={floor:a.floor,position:vec2.add(vec2.create(),a.position2d,vec2.scale(vec2.create(),dir,pos))},length<pos+step&&(offset=step-(length-pos),spot.node=b),this.spots.push(spot)},setPath:function(path,callback){var getActualNextFloor,scope,animate;path instanceof Path2D&&!path.isEmpty()&&(this.clearPath(),this.position=0,this.generatePath(path),vec2.set(this.messagePosition,0,0),getActualNextFloor=function(spots,position){for(var count=0,i=position+1,len=spots.length;i<len;i++)if(spots[i].floor.id==spots[i-1].floor.id){if(2==++count)return spots[i].floor}else count=0;return!1},(scope=this).animating=!0,animate=function(){scope.paused=!1;var targetFloor,pause,currentSpot=scope.spots[scope.position],nextSpot=(scope.renderSpot(scope.position),scope.position++,scope.spots[scope.position]);currentSpot&&currentSpot.node&&scope.wayfinder.events.trigger("path-step",currentSpot),scope.position===scope.spots.length?(scope.animating=!1,scope.wayfinder.map.getCurrentFloor()!==scope.spots[scope.spots.length-1].floor&&(scope.wayfinder.showFloor(currentSpot.floor),scope.wayfinder.map.renderer.damageAll(),scope.wayfinder.map.renderer.render()),callback&&"function"==typeof callback&&(scope.wayfinder.events.trigger("path-finished",path),callback())):(pause=0,nextSpot&&currentSpot.floor.id!==nextSpot.floor.id?(targetFloor=getActualNextFloor(scope.spots,scope.position+1),pause=scope.pathPauseTime,targetFloor&&(scope.wayfinder.events.trigger("floor-change-before",nextSpot.floor,targetFloor,currentSpot.floor,scope.spots[scope.position]),scope.wayfinder.options.pathDisplayInstructions&&(scope.messagePosition=scope.wayfinder.map.getTransformer().transformPoint(vec2.add(scope.messagePosition,currentSpot.position,scope.msgOffset)),nextSpot=scope.wayfinder.getLanguage(),scope.message=scope.wayfinder.translator.get("go_to_floor",[scope.wayfinder.map.getCurrentFloor().getName(nextSpot),targetFloor.getName(nextSpot)]),scope.renderMessage(scope.messagePosition,scope.message)),scope.paused=!0)):1<scope.position&&scope.spots[scope.position-2].floor.id!==currentSpot.floor.id&&(scope.wayfinder.showFloor(currentSpot.floor),scope.wayfinder.map.renderer.damageAll(),scope.wayfinder.map.renderer.render()),scope.timer=setTimeout(animate,scope.pathSpeed+pause))},this.paused||(this.timer=setTimeout(animate,this.wayfinder.options.pathSpeed)),path.isEmpty()||this.wayfinder.events.trigger("path-start",path.nodes[path.nodes.length-1]))},updatePath:function(path){this.animating||(this.generatePath(path),this.position=this.spots.length)},clearPath:function(){this.position=0,this.spots=[],this.paused=!1,this.animating=!1,clearTimeout(this.timer),this.wayfinder.map.update(!0)},renderMessage:function(position,msg){var T=this.wayfinder.map.getTransformer(),width=(this.context.save(),this.context.font="bold "+this.messageSize*T.getViewScale()+"px sans-serif",this.context.textBaseline="top",this.context.textAlign="center",this.context.fillStyle="rgba(40, 40, 40, 0.75)",this.context.measureText(msg).width);this.context.fillRect(position[0]-(width+20)/2,position[1],width+20,this.messageSize*T.getViewScale()+20),this.context.fillStyle="rgba(255,255,255,1.0)",this.context.fillText(msg,position[0],position[1]+10),this.context.restore()},renderSpot:function(position){var T;this.spots[position].position;this.spots[position]&&(position=(T=this.wayfinder.map.getTransformer()).transformPoint(this.spots[position].position),this.context.save(),this.context.beginPath(),this.context.fillStyle=this.spotColor.toString(),this.context.arc(position[0],position[1],this.spotSize*T.getZoom(),0,2*Math.PI,!0),this.context.closePath(),this.context.fill(),this.context.restore())},render:function(rect){if(0!==this.spots.length){var floor=this.wayfinder.map.getCurrentFloor();this.context.save();for(var i=0,len=this.position;i<len;i++)this.spots[i].floor.id===floor.id&&this.renderSpot(i);this.paused&&this.renderMessage(this.messagePosition,this.message),this.context.restore()}}}),NodesRenderer2D=Renderer2D.extend({init:function(){this._super(2)},render:function(rect){var T=this.wayfinder.map.getTransformer(),floor=this.wayfinder.map.getCurrentFloor();if(floor){for(var i in this.context.save(),floor.nodes){var pt=T.transformPoint(floor.nodes[i].position2d);this.context.beginPath(),this.context.fillStyle="rgba(60,120,0,0.7)",this.context.arc(pt[0],pt[1],2,0,2*Math.PI,!0),this.context.closePath(),this.context.fill(),this.context.fillText(floor.nodes[i].id,pt[0]+2,pt[1]+2)}this.context.restore()}}}),EdgesRenderer2D=Renderer2D.extend({init:function(){this._super(2)},render:function(rect){var T=this.wayfinder.map.getTransformer(),floor=this.wayfinder.map.getCurrentFloor();if(floor){for(var i in this.context.save(),floor.nodes){var j,origin=T.transformPoint(floor.nodes[i].position2d);for(j in floor.nodes[i].neighbours){var pt=T.transformPoint(floor.nodes[i].neighbours[j].position2d);this.context.lineWidth=1,this.context.strokeStyle="rgba(10,10,10,0.1)",this.context.beginPath(),this.context.moveTo(origin[0],origin[1]),this.context.lineTo(pt[0],pt[1]),this.context.closePath(),this.context.stroke()}}this.context.restore()}}}),ExtrasRenderer2D=Renderer2D.extend({init:function(){this._super(5),this.yahSize=30,this.locationAnimationProgress=0,this.pulseAnimationProgress=0,this.pulseAnimationDirection=1,this.yahColor=new Color(255,0,0,1)},onAdd:function(){this.yahSize=this.wayfinder.settings.getInt("kiosk.2d.yah-size",this.wayfinder.settings.getInt("poi.2d.icon-size",this.wayfinder.options.poiRadius)),this.yahYOffset=this.wayfinder.settings.getFloat("kiosk.2d.yah-y-offset",1),this.yahXOffset=this.wayfinder.settings.getFloat("kiosk.2d.yah-x-offset",1),this.yahColor=this.wayfinder.settings.getColor("kiosk.yah-color",this.wayfinder.settings.get("path.2d.color","#FF0000")),this.otherFloorSpot=this.wayfinder.settings.getBoolean("poi.2d.yah-other-floors",!1),this.yahPulseAnimation=this.wayfinder.settings.getBoolean("kiosk.2d.yah.pulse",!1),this.yahPulseColor=this.wayfinder.settings.getColor("kiosk.2d.yah.pulse-color","rgba(255,0,0,0.8)")},render:function(rect){var pulsePos,height,T=this.wayfinder.map.getTransformer(),locationManager=(this.context.save(),this.yahImage="",this.wayfinder.device.locationManager);locationManager&&this.wayfinder.options.enableUserLocation&&"function"==typeof locationManager.getCurrentPosition&&locationManager.getCurrentPosition()&&(locationManager=locationManager.getCurrentPosition(),locationManager=T.transformPoint(locationManager.location),this.context.beginPath(),this.context.fillStyle="rgba(0, 0, 200, 0.3)",this.context.arc(locationManager[0],locationManager[1],5*T.getZoom(),0,2*Math.PI,!0),this.context.closePath(),this.context.fill(),this.context.fill()),this.wayfinder.getKioskNode()&&this.wayfinder.getKioskNode().position2d&&(locationManager=T.transformPoint(this.wayfinder.getKioskNode().position2d),T=this.yahSize*T.getZoom(),this.wayfinder.acquiringLocation?(this.drawLocationAnimation(locationManager,T/4),this.damage()):(this.yahPulseAnimation&&(pulsePos=[locationManager[0],locationManager[1]-T/2],this.drawPulseAnimation(pulsePos,T/4),this.damage()),this.wayfinder.options.drawKioskIcon&&!1!==this.wayfinder.getKioskNode()&&(this.wayfinder.yahImage&&this.wayfinder.getKioskNode().floor.id==this.wayfinder.getCurrentFloor().id?(height=T/(pulsePos=this.wayfinder.yahImage).width*pulsePos.height,0===this.wayfinder.options.yahRotation?this.context.drawImage(pulsePos,locationManager[0]-T/2,locationManager[1]-height,T,height):(this.context.save(),this.context.translate(locationManager[0],locationManager[1]),this.context.rotate(this.wayfinder.options.yahRotation*Math.PI/180),this.context.drawImage(pulsePos,-T/2,-height/2,T,height),this.context.restore())):this.otherFloorSpot&&(this.context.beginPath(),this.context.fillStyle=this.yahColor.toString(),this.context.arc(locationManager[0]+T/4,locationManager[1]+T/4,T/4,0,2*Math.PI,!0),this.context.closePath(),this.context.fill())))),this.context.restore()},accelerateInterpolator:function(x){return x*x},decelerateInterpolator:function(x){return 1-(1-x)*(1-x)},drawCircle:function(loc,radius,speed,progress){var ctx=this.context,start=(ctx.beginPath(),this.accelerateInterpolator(progress)*speed),progress=this.decelerateInterpolator(progress)*speed;ctx.arc(loc[0],loc[1],radius,(start-.5)*Math.PI,(progress-.5)*Math.PI),ctx.lineWidth=radius/4,ctx.strokeStyle=this.yahColor.toString(),ctx.stroke()},drawPulseCircle:function(loc,radius,speed,progress){var ctx=this.context,radius=radius*this.accelerateInterpolator(progress)*speed;ctx.fillStyle=this.yahPulseColor.toString(),ctx.beginPath(),ctx.arc(loc[0],loc[1],radius,0,2*Math.PI),ctx.fill()},drawPulseAnimation:function(loc,radius){this.pulseAnimationProgress+=.01*this.pulseAnimationDirection,(1<this.pulseAnimationProgress||this.pulseAnimationProgress<0)&&(this.pulseAnimationDirection=-1*this.pulseAnimationDirection),this.drawPulseCircle(loc,radius,5,this.pulseAnimationProgress)},drawLocationAnimation:function(loc,radius){this.locationAnimationProgress+=.01,1<this.locationAnimationProgress&&(this.locationAnimationProgress=0),this.drawCircle(loc,radius,4,this.locationAnimationProgress),this.drawCircle(loc,radius/2,2,this.locationAnimationProgress)}}),DebugRenderer2D=Renderer2D.extend({init:function(){this._super(5),this.yahSize=30,this.foundBeacons={}},render:function(rect){var T=this.wayfinder.map.getTransformer(),debugBeacons=this.wayfinder.options.debugBeacons;if(this.context.save(),debugBeacons&&this.wayfinder.mobileLogic){var i,beacons=this.wayfinder.mobileLogic.mobileData.ibeacons,debugBeacons=this.wayfinder.device.locationManager?this.wayfinder.device.locationManager.locator.foundBeacons:{},found=Object.assign(debugBeacons,this.foundBeacons);for(i in this.foundBeacons=found,beacons){var loc,spot,beacon=beacons[i];(spot=this.wayfinder.nodes[parseInt(beacon.node_id)])&&this.wayfinder.map.getCurrentFloor().id===spot.floor.id&&(loc=T.transformPoint(spot.position2d),spot.position2d)&&(this.context.beginPath(),found[parseInt(spot.id)]?this.context.fillStyle="rgba(0, 200, 0, 0.9)":this.context.fillStyle="rgba(0, 0, 200, 0.9)",this.context.arc(loc[0],loc[1],8*T.getZoom(),0,2*Math.PI,!0),this.context.closePath(),this.context.fill(),this.context.font=7*T.getZoom()+"px Arial",spot.id.split("."),this.context.fillStyle="white",this.context.fillText(beacon.major+"."+beacon.minor,loc[0]-7*T.getZoom(),loc[1]+2*T.getZoom()))}}this.context.restore()}}),POIsOverlayRenderer2D=Renderer2D.extend({init:function(){this._super(4)},render:function(rect){var deHighlightPOIs=this.wayfinder.settings.getBoolean("poi.dehighlight.enabled",!1)&&0<this.wayfinder.map.highlights.length,dehighlightColor=this.wayfinder.settings.getColor("poi.dehighlight.color","#888"),floor=this.wayfinder.map.getCurrentFloor();if(floor){this.wayfinder.map.getTransformer();if(this.context.save(),floor.nodes)for(var i=0;i<floor.nodes.length;i++)if(0!==floor.nodes[i].pois.length)for(var overlays,overlayHighlightColor,overlayColor,overlayColorBorder,overlayBorderWith,overlayColorFromGroup,overlayRenderAll,poi=!1,j=0;j<floor.nodes[i].pois.length;j++)if(poi=floor.nodes[i].pois[j],highlighted=this.isPOIinHighlights(poi),overlayRenderAll=this.wayfinder.settings.getBoolean("poi.2d.overlay-render-all",!1,poi),(highlighted||overlayRenderAll)&&poi.id in this.wayfinder.overlays&&(overlays=this.wayfinder.overlays[poi.id])&&0<overlays.length)for(var o in overlayHighlightColor=this.wayfinder.settings.getColor("poi.2d.overlay.color",this.wayfinder.options.overlayHighlightColor,poi),overlayColor=this.wayfinder.settings.getColor("poi.2d.overlay.color-background","#cccccc",poi),overlayColorFromGroup=this.wayfinder.settings.getBoolean("poi.2d.overlay-group-color",!1,poi),overlayColorBorder=this.wayfinder.settings.getColor("poi.2d.overlay.color-border","#cccccc",poi),overlayBorderWith=this.wayfinder.settings.getInt("poi.2d.overlay-border-with",0,poi),color=overlayColor,overlays){var group,o=overlays[o];!highlighted&&deHighlightPOIs?color=dehighlightColor:!highlighted&&overlayColorFromGroup&&poi&&poi.getGroups()||deHighlightPOIs&&highlighted&&overlayColorFromGroup?(group=poi.getGroups()[0])&&group.getColor()&&(color=group.getColor().toString()):color=highlighted?overlayHighlightColor:overlayColor,this.renderPOIOverlay(o,color,overlayBorderWith,overlayColorBorder,!1)}this.context.restore()}},isPOIinHighlights:function(poi){for(var i in this.wayfinder.map.highlights)if(this.wayfinder.map.highlights[i].id==poi.id)return!0;return!1},renderPOIOverlay:function(overlay,color,borderWidth,borderColor,debug){if(overlay&&overlay.polygon&&3<overlay.polygon.length&&color){var T=this.wayfinder.map.getTransformer(),pt=T.transformPoint(overlay.polygon[0]);this.context.strokeStyle=borderColor,this.context.lineWidth=borderWidth,this.context.fillStyle=color,this.context.beginPath(),this.context.moveTo(pt[0],pt[1]);for(var i=0;i<overlay.polygon.length;i++)pt=T.transformPoint(overlay.polygon[i]),this.context.lineTo(pt[0],pt[1]);this.context.fillStyle=color,this.context.stroke(),this.context.closePath(),this.context.fill()}},rotateVector:function(vec,ang){ang=-ang*(Math.PI/180);var cos=Math.cos(ang),ang=Math.sin(ang);return vec2.fromValues(Math.round(1e4*(vec[0]*cos-vec[1]*ang))/1e4,Math.round(1e4*(vec[0]*ang+vec[1]*cos))/1e4)},renderPolygon:function(polygon,color,angle){var T=this.wayfinder.map.getTransformer(),pt=T.transformPoint(vec2.fromValues(polygon[0][0],polygon[0][1]));this.context.fillStyle=color,this.context.beginPath(),angle&&(pt=T.rotatePoint(pt,angle)),this.context.moveTo(pt[0],pt[1]);for(var i=0;i<polygon.length;i++)pt=T.transformPoint(vec2.set(pt,polygon[i][0],polygon[i][1])),angle&&(pt=T.rotatePoint(pt,angle)),this.context.lineTo(pt[0],pt[1]);this.context.closePath(),this.context.fill()}}),Wayfinder2DRendering=Class.extend({init:function(wayfinder,canvas){this.wayfinder=wayfinder,this.context=null,this.damaged=!0,this.renderers=[],wayfinder&&wayfinder instanceof Wayfinder&&(this.wayfinder=wayfinder),canvas&&(this.context=canvas.getContext("2d"))},damage:function(renderer){this.damaged=!0},undamage:function(renderer){this.damaged=!1},damageAll:function(){for(var i=0;i<this.renderers.length;i++)this.renderers[i].damage()},render:function(){if(this.damaged){this.damaged=!1;for(var T=this.wayfinder.map.getTransformer(),rect=new Rectangle(T.getX(),T.getY(),T.getUnzoomedViewWidth(),T.getUnzoomedViewHeight()),i=0;i<this.renderers.length;i++)this.renderers[i]&&this.renderers[i].enabled&&this.renderers[i].render(rect)}},add:function(renderer){if(!(renderer instanceof Renderer2D))return!1;renderer.setContext(this.context),renderer.setWayfinder(this.wayfinder),renderer.setParent(this);for(var i=0;i<this.renderers.length;i++)if(renderer.renderQueue<this.renderers[i].renderQueue)return this.renderers.splice(i,0,renderer),renderer.onAdd(),!0;return this.renderers.push(renderer),renderer.onAdd(),!0},updateRenderers:function(){for(var i=0;i<this.renderers.length;i++)this.renderers[i].setContext(this.context)}}),Map2D=Class.extend({init:function(wayfinder){this.wayfinder=wayfinder,this.highlights=[],this.displaying=[],this.LODImages=[],this.onUpdateCallback=null,this.renderAll=!1,this.renderOnlyBase=!1,this.renderCycle=null,this.renderInterval=22,this.padding=this.wayfinder.options.zoomPadding,this.mapClickAll=this.wayfinder.settings.getBoolean("poi.2d.map-click-all",!1),this.onPOIClick=!1,this.renderer,this.wayfinder.cbOnPositionUpdate=ClassCallback(this,this.onPositionUpdate),this.emptyMap=new Image,this.emptyMap.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAQAAAAD+Fb1AAAAAmJLR0QAfPM+HiUAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfnCAwKIxQU11MpAAAAC0lEQVQI12NgIAwAACQAAS4ecaAAAAAASUVORK5CYII="},setup:function(){this.renderer=new Wayfinder2DRendering(this.wayfinder,this.wayfinder.logic.getCanvas()),this.mapMover=new Map2DMover(this.wayfinder.logic.getCanvas(),this.wayfinder.options,ClassCallback(this,this.update));var panX=this.wayfinder.settings.getFloat("kiosk.2d.default-pan-x",0),panY=this.wayfinder.settings.getFloat("kiosk.2d.default-pan-y",0);this.mapMover.cbOnClick=ClassCallback(this,this.onClick),this.mapMover.cbOnLongClick=ClassCallback(this,this.onLongClick),this.getTransformer().setOffset(panX,panY),this.pathRenderer=new PathRenderer2D,this.floorRenderer=new FloorRenderer2D,this.poisRenderer=new POIsRenderer2D,this.poisOverlayRenderer=new POIsOverlayRenderer2D,this.extrasRenderer=new ExtrasRenderer2D,this.debugRenderer=new DebugRenderer2D,this.addRenderers()},updateCanvas:function(canvas){this.renderer.context=canvas.getContext("2d"),this.renderer.updateRenderers(),this.mapMover.view=canvas,this.mapMover.bindEvents()},start:function(){function render(){me.renderer.render(),me.renderCycle=requestAnimFrame(render,this.renderInterval)}var me=this;this.renderAll=!0;this.renderCycle=requestAnimFrame(render,this.renderInterval)},addLODImage:function(floor_id,lod,x,y,image){this.LODImages&&(this.LODImages[floor_id]||(this.LODImages[floor_id]=[]),this.LODImages[floor_id][lod]||(this.LODImages[floor_id][lod]=[]),this.LODImages[floor_id][lod][x]||(this.LODImages[floor_id][lod][x]=[]),this.LODImages[floor_id][lod][x][y]||(this.LODImages[floor_id][lod][x][y]=[]),this.LODImages[floor_id][lod][x][y]=image)},getLODImage:function(floor_id,lod,x,y){return!!(this.LODImages[floor_id]&&this.LODImages[floor_id][lod]&&this.LODImages[floor_id][lod][x]&&this.LODImages[floor_id][lod][x][y])&&this.LODImages[floor_id][lod][x][y]},getContainerNeededLevel:function(){var size=Math.max(this.getTransformer().getZoomedMapWidth(),this.getTransformer().getZoomedMapHeight())*this.getTransformer().getViewScale(),size=Math.floor(size/this.wayfinder.options.mapSize[0]);return Math.min(size,this.wayfinder.options.maxLOD)},getMaxLODLevel:function(floor_id){var level=0;if(this.LODImages[floor_id]){for(var i=0;i<=this.wayfinder.options.maxLOD;i++)this.LODImages[floor_id][i]&&this.LODImages[floor_id][i].length==Math.pow(2,i)&&this.imagesInLevel(floor_id,i)==Math.pow(4,i)&&(level=i);level=Math.max(0,Math.min(level,this.wayfinder.options.maxLOD))}return level},imagesInLevel:function(floor_id,lod){var count=0;if(this.LODImages[floor_id]&&this.LODImages[floor_id][lod])for(var x in this.LODImages[floor_id][lod])this.LODImages[floor_id][lod][x]&&(count+=this.LODImages[floor_id][lod][x].length);return count},addRenderers:function(){this.renderer.add(this.floorRenderer),this.renderer.add(this.poisOverlayRenderer),this.renderer.add(this.poisRenderer),this.renderer.add(this.pathRenderer),this.renderer.add(this.extrasRenderer),this.renderer.add(this.debugRenderer)},onPositionUpdate:function(){var currentPosition=this.wayfinder.geolocation.currentPosition,currentGeoPosition=this.wayfinder.geolocation.currentGeoPosition;console.log("=== Position Update ==="),console.log("Geo.pos: ("+currentGeoPosition[0]+", "+currentGeoPosition[1]+")",currentGeoPosition),console.log("Map.pos: ("+currentPosition[0]+", "+currentPosition[1]+")",currentPosition),!1!==(currentGeoPosition=void 0===currentPosition[0]?this.findNearestNodeOnFloor(this.getCurrentFloor(),vec2.fromValues(currentPosition.x,currentPosition.y)):this.findNearestNodeOnFloor(this.getCurrentFloor(),currentPosition))&&(this.wayfinder.kiosk=currentGeoPosition),this.update(!0)},onClick:function(position){var floor=this.getCurrentFloor();if(floor){var poi,node,i,pos,pt=position,maxDist=this.wayfinder.settings.getFloat("poi.activation.radius",this.wayfinder.options.poiRadius),foundPOIs=[],lastDist=1/0,curDist=1/0;for(i in this.wayfinder.options.debugMouseLocation&&(this.floorRenderer.debugPoint=pt),floor.nodes)if("object"==typeof(node=floor.nodes[i])&&0!==node.pois.length)for(var j=0;j<node.pois.length;j++)if((poi=node.pois[j]).getShowInMenu()){if(curDist=vec2.distance(pt,node.position2d),this.wayfinder.overlays[poi.id])for(var o in this.wayfinder.overlays[poi.id])"object"==typeof this.wayfinder.overlays[poi.id][o]&&this.wayfinder.overlays[poi.id][o].contains(pt)&&(foundPOIs.push(poi),curDist=0,this.mapClickAll);curDist<(poi.isAlwaysVisible()?this.wayfinder.settings.getFloat("poi.2d.icon-size",maxDist,poi):maxDist)&&(curDist<lastDist?(foundPOIs.unshift(poi),lastDist=curDist):foundPOIs.push(poi),this.mapClickAll)}0<foundPOIs.length?(pos=vec2.scale(vec2.create(),position,1/this.getTransformer().getViewScale()),this.openPOI(foundPOIs[0],pos),this.wayfinder.events.trigger("map-click",foundPOIs[0],pos,foundPOIs)):this.wayfinder.events.trigger("map-touch",pos)}},openPOI:function(poi,position){this.clearHighlights(),this.clearDisplaying(),this.wayfinder.settings.getBoolean("poi.highlight",!0,poi)&&this.highlights.push(poi),this.wayfinder.settings.getBoolean("poi.2d.display-names-always",!0,poi)&&this.displaying.push(poi),this.pathRenderer.clearPath(),this.update(!0),this.onPOIClick&&"function"==typeof this.onPOIClick&&this.onPOIClick(poi,position)},onLongClick:function(position){this.wayfinder.options.enableUserYAHSetting&&(position=this.getTransformer().inverseTransformPoint(position),!1!==(position=this.findNearestNodeOnFloor(this.getCurrentFloor(),position)))&&(this.wayfinder.kiosk=position,this.update(!0))},update:function(redrawAll){this.wayfinder.paused||(this.wayfinder.options.enableLOD&&this.checkLODLevels(),this.redraw(),this.wayfinder.events.trigger("map-update",redrawAll))},resize:function(canvas,width,height,scale){canvas.setAttribute("width",width*scale+"px"),canvas.setAttribute("height",height*scale+"px"),canvas.style.width=width+"px",canvas.style.height=height+"px",this.getTransformer()&&((canvas=this.getTransformer()).setViewSize(vec2.fromValues(width*scale,height*scale)),canvas.setViewScale(scale),canvas.setZoom(canvas.getZoom()),this.update(!0))},getTransformer:function(){return!!this.mapMover&&this.mapMover.mapTransformer},getCurrentFloor:function(){return this.wayfinder.getCurrentFloor()},fitPathInView:function(path){var T,padding,newZoom;!1!==path&&(path=path.getBounds(),T=this.getTransformer(),padding=vec2.fromValues(this.padding,this.padding),padding=vec2.add(vec2.create(),path.size,padding),newZoom=-1,path.size[0]>path.size[1]?((newZoom=T.getViewWidth()/padding[0])<T.getZoom()||this.wayfinder.options.pathZoomIn)&&T.setZoom(newZoom):((newZoom=T.getViewHeight()/padding[1])<T.getZoom()||this.wayfinder.options.pathZoomIn)&&T.setZoom(newZoom),T.setPosition(path.min[0]-(T.getUnzoomedViewWidth()/2-path.size[0]/2),path.min[1]-(T.getUnzoomedViewHeight()/2-path.size[1]/2)))},fitPOIInView:function(poi){var overlay,bounds,deltaX,deltaY;!1!==poi&&(bounds=[0,0,0,0],bounds=(overlay=this.wayfinder.overlays[poi.id])&&0<overlay.length?overlay[0].getBounds():[poi.getNode().position2d[0],poi.getNode().position2d[1],1,1],overlay=this.getTransformer(),poi=[Math.max(bounds[0]-this.padding,0),Math.max(bounds[1]-this.padding,0),Math.min(bounds[2]+2*this.padding,overlay.getMapWidth()),Math.min(bounds[3]+2*this.padding,overlay.getMapHeight())],bounds[2]>bounds[3]?overlay.setZoom(Math.min(overlay.getZoom(),overlay.getViewWidth()/poi[2])):overlay.setZoom(Math.min(overlay.getZoom(),overlay.getViewHeight()/poi[3])),bounds=overlay.getPosition(),deltaY=deltaX=0,deltaX=Math.min(0,poi[0]-bounds[0]),deltaY=Math.min(0,poi[1]-bounds[1]),deltaX=Math.max(deltaX,poi[0]+poi[2]-bounds[0]-overlay.getViewWidth()),deltaY=Math.max(deltaY,poi[1]+poi[3]-bounds[1]-overlay.getViewHeight()),overlay.setPosition(bounds[0]+deltaX,bounds[1]+deltaY))},fitMultiplePOIsInView:function(pois,_maxZoom){if(!1!==pois){for(var T=this.getTransformer(),poi=!1,minX=1024,minY=1024,maxX=0,maxY=0,_maxZoom=void 0!==_maxZoom?_maxZoom:T.zoomRange[1],overlay=(this.wayfinder.kiosk&&(maxX=this.wayfinder.kiosk.position2d[0],maxY=this.wayfinder.kiosk.position2d[1]),!1),i=0;i<pois.length;i++)(poi=pois[i])&&poi.getNode()&&((overlay=this.wayfinder.overlays[poi.id])&&0<overlay.length&&overlay[0].getBounds()&&overlay[0].getBounds()[0]<1024&&overlay[0].getBounds()[1]<1024?(minX=Math.min(minX,overlay[0].getBounds()[0]),minY=Math.min(minY,overlay[0].getBounds()[1]),maxX=Math.max(maxX,overlay[0].getBounds()[0]+overlay[0].getBounds()[2]),maxY=Math.max(maxY,overlay[0].getBounds()[1]+overlay[0].getBounds()[3])):poi.getNode().position2d&&(minX=Math.min(minX,poi.getNode().position2d[0]),minY=Math.min(minY,poi.getNode().position2d[1]),maxX=Math.max(maxX,poi.getNode().position2d[0]),maxY=Math.max(maxY,poi.getNode().position2d[1])));var bounds=[minX,minY,maxX-minX,maxY-minY],zoom=(bounds[0]=Math.max(1,bounds[0]-this.padding),bounds[1]=Math.max(1,bounds[1]-this.padding),bounds[2]=Math.min(T.mapSize[0],bounds[2]+2*this.padding),bounds[3]=Math.min(T.mapSize[1],bounds[3]+2*this.padding),T.getViewWidth()/bounds[2]),zoom=Math.min(zoom,T.getViewHeight()/bounds[3]);zoom=Math.min(_maxZoom,zoom),T.setZoom(zoom),T.setPosition(bounds[0]-(T.getUnzoomedViewWidth()/2-bounds[2]/2),bounds[1]-(T.getUnzoomedViewHeight()/2-bounds[3]/2))}},center:function(offsetX,offsetY){var T=this.getTransformer();T&&T.center()},checkLODLevels:function(){var floorID,currentMaxLOD,neededLODLevel,isLODLoading;this.getCurrentFloor()&&(floorID=this.getCurrentFloor().id,currentMaxLOD=this.getMaxLODLevel(floorID),neededLODLevel=this.getContainerNeededLevel(),isLODLoading=this.isLODLoading(floorID,neededLODLevel),this.isLODLoaded(floorID,neededLODLevel)?this.floorRenderer.setLOD(neededLODLevel):this.floorRenderer.setLOD(currentMaxLOD),isLODLoading||this.preloadNextLODLevel(floorID,neededLODLevel))},isLODLoading:function(level,lod){return!(!this.LODImages[level]||!this.LODImages[level][lod])},isLODLoaded:function(level,lod){return!!(this.LODImages[level]&&this.LODImages[level][lod]&&this.LODImages[level][lod]&&this.LODImages[level][lod].length==Math.pow(2,lod)&&this.imagesInLevel(level,lod)==Math.pow(4,lod))},getCurrentLOD:function(level,x,y){if(-1<level){level=this.getLODImage(this.getCurrentFloor().id,level,x,y);if(level)return level}return!1},preloadNextLODLevel:function(floor,level){if(floor&&level<=this.wayfinder.options.maxLOD){for(var scope=this,tiles=Math.pow(2,level),urls=(this.LODImages[floor]||(this.LODImages[floor]=[]),this.LODImages[floor][level]||(this.LODImages[floor][level]=[]),{}),x=0;x<tiles;x++)for(var y=0;y<tiles;y++)urls[floor+"_"+level+"_"+x+"_"+y]={url:WayfinderAPI.getURL("2d","lod",[floor,level,x,y]),type:"image"};Logistics.getMultiple(urls,function(data){var params,i;for(i in data)params=i.split("_"),scope.addLODImage(params[0],params[1],params[2],params[3],data[i]);scope.afterPreload(floor,level)})}},afterPreload:function(floor,level){this.update(!0)},setHighlights:function(_highlights){for(var i in _highlights)this.highlights.push(_highlights[i])},clearHighlights:function(){this.highlights=[]},setDisplaying:function(_displaying){for(var i in _displaying)this.displaying.push(_displaying[i])},clearDisplaying:function(){this.displaying=[]},findNearestNodeOnFloor:function(floor,position,hasNeighbours){if(!(floor instanceof Floor))return!1;var i,d,_node,min=1/0,node=!1;for(i in floor.nodes)(!(_node=floor.nodes[i]).neighbours||0<_node.neighbours.length)&&(d=vec2.distance(position,_node.position2d))<min&&(node=_node,min=d);return node},setZoom:function(percentage){this.getTransformer().setZoomPercentage(percentage)},zoomIn:function(){this.mapMover.mapTransformer.zoomIn()},zoomOut:function(){this.mapMover.mapTransformer.zoomOut()},redraw:function(){this.renderer&&this.renderer.damage()},getPOILocationOnMap:function(poi){return this.poisRenderer.getPOILocationOnMap(poi)},getPOIOverlayLocationOnMap:function(poi){return this.poisRenderer.getPOIOverlayLocationOnMap(poi)},onMapUpdate:function(){this.wayfinder.events.trigger("map-update",redrawAll)}}),Map2DFallback=Map2D.extend({init:function(wayfinder){this.wayfinder=!1,wayfinder instanceof Wayfinder&&(this.wayfinder=wayfinder),this.currentFloorID=0,this.highlights=new Array,this.LODImages=new Array,this.onPOIClick=!1,this.wayfinder.cbOnPositionUpdate=ClassCallback(this,this.onPositionUpdate),this.map=$("<div id='"+this.wayfinder.options.map+"_fallback''></div>"),$("#"+this.wayfinder.options.map).parent().append(this.map),this.map.text("Your browser does not support this application. Please upgrade your browser.")},update:function(){var img;0<this.currentFloorID&&(img=this.getCurrentLOD(this.currentFloorID,0,0),log(this.currentFloorID,img),img)&&this.map.append(img)},fitPathInView:function(){},fitMultiplePOIsInView:function(){},resize:function(width,height){},zoomIn:function(){},zoomOut:function(){},addRenderers:function(){},redraw:function(){}}),Map2DMover=Class.extend({init:function(view,options,cbUpdate){this.view=view,this.options=options,this.cbUpdate=cbUpdate,this.cbOnClick=!1,this.cbOnLongClick=!1,this.mouseDelta=vec2.create(),this.mouseDown=!1,this.mouseDelta=vec2.create(),this.smoothPanning=!0,this.dragTimeout=null,this.panInterval=10,this.panSensitivity=.3,this.lastPinch=0,this.rendering=!1,this.lastDraw=-1,this.waitForFullRedraw=300,this.fullRedrawTimer=null,this._dragVec=vec2.create(),this.zeroVec=vec2.create(),this.hammer=null,this.setup()},setup:function(){this.mapTransformer=new Map2DTransformer(vec2.fromValues(this.options.mapSize[0],this.options.mapSize[1]),vec2.fromValues(this.view.offsetWidth,this.view.offsetHeight),!0,this.options),this.options.disableMap2DMovement||this.bindEvents()},bindEvents:function(){this.hammer=new Hammer(this.view),this.hammer.get("pinch").set({enable:!0}),this.hammer.on("pinch",ClassCallback(this,this.onPinch)),this.hammer.on("hold",ClassCallback(this,this.onHold)),this.hammer.on("tap",ClassCallback(this,this.onTap)),this.hammer.on("release",ClassCallback(this,this.stop)),this.hammer.on("pan",ClassCallback(this,this.onDrag)),this.hammer.on("panend",ClassCallback(this,this.onEndDrag)),this.hammer.on("panstart",ClassCallback(this,this.onStartDrag)),this.bindMouseWheel(ClassCallback(this,this.onWheel))},stop:function(event){this.cbUpdate(!0),this.lastPinch=0,this.mouseDelta=vec2.create()},getRelativeMousePosition:function(v){var left=this.view.getBoundingClientRect().left+document.body.scrollLeft,top=this.view.getBoundingClientRect().top+document.body.scrollTop,v=vec2.sub(vec2.create(),v,vec2.fromValues(left,top));return this.mapTransformer.inverseTransformPoint(v)},bindMouseWheel:function(callback){this.view.addEventListener?(this.view.addEventListener("mousewheel",callback,!1),this.view.addEventListener("DOMMouseScroll",callback,!1)):this.view.attachEvent("onmousewheel",callback)},onStartDrag:function(event){this.stop(),this.mouseDelta=vec2.fromValues(event.deltaX,event.deltaY)},onDrag:function(event){var panVector;event.preventDefault(),this.rendering||"pan"!=event.type||(event=vec2.fromValues(event.deltaX,event.deltaY),vec2.scale(event,event,this.mapTransformer.getViewScale()),panVector=vec2.sub(this._dragVec,this.mouseDelta,event),this.pan(panVector,!1),this.mouseDelta=event)},pan:function(panVector,redrawAll){var len;this.rendering=!0,void 0===redrawAll&&(redrawAll=!0),0!==this.options.map2DRotation&&(len=vec2.len(panVector),panVector=this.mapTransformer.rotatePointAroundCenter(panVector,this.zeroVec,-this.options.map2DRotation),vec2.normalize(panVector,panVector),vec2.scale(panVector,panVector,len)),this.mapTransformer.move(panVector),this.cbUpdate&&"function"==typeof this.cbUpdate&&(this.cbUpdate(redrawAll),this.lastDraw=(new Date).getTime()),null===this.fullRedrawTimer&&(this.fullRedrawTimer=setTimeout(ClassCallback(this,this.checkFullDraw),this.waitForFullRedraw)),this.rendering=!1},checkFullDraw:function(){var time=(new Date).getTime();0<this.lastDraw&&time-this.lastDraw>this.waitForFullRedraw?("function"==typeof this.cbUpdate&&this.cbUpdate(!0),this.fullRedrawTimer=null,this.lastDraw=-1):-1!==this.lastDraw&&(this.fullRedrawTimer=setTimeout(ClassCallback(this,this.checkFullDraw),this.waitForFullRedraw))},onEndDrag:function(event){var velocity,smoothDistance,me,smoothScrollTimer;void 0!==event&&"panend"===event.type&&(event.preventDefault(),this.timeout&&clearTimeout(this.timeout),velocity=vec2.fromValues(event.velocityX,event.velocityY),this.smoothPanning&&.3<vec2.sqrLen(velocity)&&(event=vec2.fromValues(event.deltaX,event.deltaY),vec2.sub(event,this.mouseDelta,event),smoothDistance=vec2.create(),vec2.multiply(smoothDistance,event,velocity),smoothScrollTimer=function(){var distance=vec2.create();vec2.div(distance,smoothDistance,vec2.fromValues(13,13)),vec2.sub(smoothDistance,smoothDistance,distance),3<vec2.sqrLen(distance)?(me.timeout&&clearTimeout(me.timeout),me.timeout=setTimeout(smoothScrollTimer,me.panInterval),this.rendering||(distance=vec2.negate(vec2.create(),distance),me.pan(distance,!1))):(me.pan(vec2.create(),!0),me.lastDraw=-1)},(me=this).timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(smoothScrollTimer,this.panInterval)),this.mouseDelta=vec2.create(),this.pan(vec2.create(),!0),this.lastDraw=-1)},onHold:function(event){this.cbOnLongClick&&"function"==typeof this.cbOnLongClick&&this.cbOnLongClick(vec2.fromValues(event.center.x,event.center.y))},onTap:function(event){event.preventDefault(),this.timeout&&clearTimeout(this.timeout),this.cbOnClick&&"function"==typeof this.cbOnClick&&this.cbOnClick(this.getRelativeMousePosition(vec2.fromValues(event.center.x,event.center.y)))},onWheel:function(event){(event=window.event||event).preventDefault?event.preventDefault():event.returnValue=!1;function sign(a){return a<0?-1:0<a?1:0}var delta=Math.max(-1,Math.min(1,event.wheelDelta||-event.detail)),direction=0;if(void 0!==delta?direction=sign(delta):void 0!==event.detail&&(direction=-sign(event.detail)),0<direction)this.mapTransformer.zoomIn();else{if(!(direction<0))return;this.mapTransformer.zoomOut()}this.cbUpdate&&"function"==typeof this.cbUpdate&&this.cbUpdate(!0)},onPinch:function(event){event.preventDefault(),!this.rendering&&event&&(0===this.lastPinch&&(this.lastPinch=this.mapTransformer.getZoom()),event=this.lastPinch*event.scale,this.pinch(event))},pinch:function(scale){this.rendering=!0,0!==scale&&(this.mapTransformer.setZoom(scale),this.cbUpdate)&&"function"==typeof this.cbUpdate&&this.cbUpdate(!0),this.rendering=!1},onDoubleTap:function(event){var event=event.center,v=(this.mapTransformer.getZoom(),this.mapTransformer.getZoomStep(),vec2.create()),v=(vec2.sub(v,vec2.fromValues(event.pageX,event.pageY),vec2.fromValues(this.view.getBoundingClientRect().left,this.view.getBoundingClientRect().top)),this.mapTransformer.inverseTransformPoint(event.pageX,event.pageY));this.mapTransformer.setPosition(v.x,v.y),this.cbUpdate&&"function"==typeof this.cbUpdate&&this.cbUpdate(!0)},onZoomInPressed:function(event){this.mapTransformer.zoomIn(),this.cbUpdate&&"function"==typeof this.cbUpdate&&this.cbUpdate(!0),this.zoomTimer=setTimeout(ClassCallback(this,this.onZoomInPressed),this.zoomInterval)},onZoomOutPressed:function(event){this.mapTransformer.zoomOut(),this.cbUpdate&&"function"==typeof this.cbUpdate&&this.cbUpdate(!0),this.zoomTimer=setTimeout(ClassCallback(this,this.onZoomOutPressed),this.zoomInterval)},onZoomEnd:function(){!1!==this.zoomTimer&&(clearTimeout(this.zoomTimer),this.zoomTimer=!1),this.cbUpdate&&"function"==typeof this.cbUpdate&&this.cbUpdate(!0)},viewScale:function(){var view=vec2.fromValues(this.view.offsetWidth,this.view.offsetHeight),w=window,d=document,e=d.documentElement,d=d.getElementsByTagName("body")[0],x=w.innerWidth||e.clientWidth||d.clientWidth,w=w.innerHeight||e.clientHeight||d.clientHeight,e=vec2.fromValues(x,w);return vec2.sqrLen(view)/vec2.sqrLen(e)}}),Map2DTransformer=Class.extend({init:function(_mapSize,_viewSize,_centering,_options){this.position=vec2.create(),this.zoom=1,this.options=_options,this.maxRange=_options?_options.maxLOD+1:3,this.mapSize=_mapSize,this.viewSize=_viewSize,this.viewScale=1,this.zoomRange=vec2.fromValues(.1,3*this.viewScale),this.zoomSteps=10*this.maxRange,this.centering=void 0===_centering||_centering,this.offsetX=0,this.offsetY=0,this.padding=void 0!==this.options.pathZoomPadding?this.options.pathZoomPadding:0,this.centerIfZoomedOut(),this.cbOnZoomChange=null},getPosition:function(){return this.position},getViewSize:function(){return this.viewSize},getViewScale:function(){return this.viewScale},getMapPosition:function(){return vec2.negate(vec2.create(),this.position)},getZoomedMapPosition:function(){return vec2.negate(vec2.create(),this.getZoomedPosition())},getZoomedPosition:function(){return vec2.scale(vec2.create(),this.position,this.zoom)},getX:function(){return this.position[0]},getY:function(){return this.position[1]},getZoomedX:function(){return this.position[0]*this.zoom},getZoomedY:function(){return this.position[1]*this.zoom},getZoom:function(){return this.zoom},getZoomRange:function(){return(this.zoomRange[1]*this.viewScale-this.zoomRange[0])/this.zoomSteps},getZoomStep:function(){return(this.zoomRange[1]-this.zoomRange[0])/this.zoomSteps},setOffset:function(offsetX,offsetY){this.offsetX=offsetX,this.offsetY=offsetY},setPosition:function(_x,_y){this.position[0]=_x,this.position[1]=_y,this.position[0]=Math.min(this.position[0],this.getMapWidth()-this.getUnzoomedViewWidth()),this.position[1]=Math.min(this.position[1],this.getMapHeight()-this.getUnzoomedViewHeight()),this.position[0]=Math.max(this.position[0],0),this.position[1]=Math.max(this.position[1],0),this.centerIfZoomedOut()},setZoomedPosition:function(x,y){this.setPosition(x/this.getZoom(),y/this.getZoom())},move:function(delta){this.setPosition(this.position[0]+delta[0]/this.getZoom(),this.position[1]+delta[1]/this.getZoom())},setViewSize:function(_viewSize){this.viewSize=_viewSize;var _viewSize=Math.min(this.viewSize[0],this.viewSize[1]),maxLen=Math.max(this.viewSize[0],this.viewSize[1]);this.zoomRange[0]=_viewSize/this.mapSize[0],this.zoomRange[1]=Math.max(this.options.maxLOD,2*this.options.maxLOD*(this.mapSize[0]/maxLen))},setViewScale:function(_viewScale){this.viewScale=_viewScale},setZoom:function(_zoom){var oldZoomWidth,oldZoomHeight;isNaN(_zoom)?console.warn("setZoom: Is not a number",_zoom):(oldZoomWidth=this.getUnzoomedViewWidth(),oldZoomHeight=this.getUnzoomedViewHeight(),this.zoom=_zoom,this.zoom<this.zoomRange[0]&&(this.zoom=this.zoomRange[0]),this.zoom>this.zoomRange[1]*this.viewScale&&(this.zoom=this.zoomRange[1]*this.viewScale),_zoom=this.getUnzoomedViewWidth()-oldZoomWidth,oldZoomWidth=this.getUnzoomedViewHeight()-oldZoomHeight,this.setPosition(this.getX()-_zoom/2,this.getY()-oldZoomWidth/2),this.centerIfZoomedOut(),"function"==typeof this.cbOnZoomChange&&(oldZoomHeight=(this.zoomRange[1]-this.zoom)/(this.zoomRange[1]-this.zoomRange[0]),this.cbOnZoomChange(oldZoomHeight)))},setZoomPercentage:function(percentage){percentage=this.zoomRange[1]-(this.zoomRange[1]-this.zoomRange[0])*(1-percentage);this.setZoom(percentage)},center:function(){this.centering&&(this.position[0]=-(this.getUnzoomedViewWidth()-this.getMapWidth())/2-this.offsetX,this.position[1]=-(this.getUnzoomedViewHeight()-this.getMapHeight())/2+this.offsetY)},centerIfZoomedOut:function(){this.centering&&(this.getUnzoomedViewWidth()>=this.getMapWidth()&&(this.position[0]=-(this.getUnzoomedViewWidth()-this.getMapWidth())/2-this.offsetX),this.getUnzoomedViewHeight()>=this.getMapHeight())&&(this.position[1]=-(this.getUnzoomedViewHeight()-this.getMapHeight())/2+this.offsetY)},zoomIn:function(){this.setZoom(this.getZoom()+this.getZoomStep())},zoomOut:function(){this.setZoom(this.getZoom()-this.getZoomStep())},zoomToFit:function(){this.mapSize[0]>this.mapSize[1]?this.zoom=this.viewSize[0]/this.mapSize[0]:this.zoom=this.viewSize[1]/this.mapSize[1],this.getZoomedMapHeight()>this.getViewHeight()&&(this.zoom=Math.min(this.viewSize[0],this.viewSize[1])/Math.min(this.mapSize[0],this.mapSize[1])),this.setZoom(this.zoom)},getMapWidth:function(){return this.mapSize[0]},getMapHeight:function(){return this.mapSize[1]},getZoomedMapWidth:function(){return this.mapSize[0]*this.zoom},getZoomedMapHeight:function(){return this.mapSize[1]*this.zoom},getViewWidth:function(){return this.viewSize[0]},getViewHeight:function(){return this.viewSize[1]},getUnzoomedViewWidth:function(){return this.viewSize[0]/this.zoom},getUnzoomedViewHeight:function(){return this.viewSize[1]/this.zoom},transformPoint:function(point){point=vec2.add(vec2.create(),this.getZoomedMapPosition(),vec2.scale(vec2.create(),point,this.zoom));return 0!==this.options.map2DRotation?this.rotatePointAroundCenter(point,vec2.fromValues(this.getViewWidth()/2,this.getViewHeight()/2),this.options.map2DRotation):point},inverseTransformPoint:function(point){var center;return 0!==this.options.map2DRotation&&(center=vec2.fromValues(this.getViewWidth()/(2*this.getViewScale()),this.getViewHeight()/(2*this.getViewScale())),point=this.rotatePointAroundCenter(point,center,-this.options.map2DRotation)),vec2.scale(point,point,this.getViewScale()),vec2.add(point,point,this.getZoomedPosition()),vec2.scale(point,point,1/this.zoom),point},inverseScale:function(point){return vec2.scale(vec2.create(),point,1/this.getViewScale())},getDrawingArea:function(){return vec2.add(vec2.create(),this.viewSize,this.getZoomedPosition())},rotatePoint:function(point,angle){var x=point[0]*Math.cos(angle)-point[1]*Math.sin(angle),point=point[1]*Math.cos(angle)+point[0]*Math.sin(angle);return vec2.fromValues(x,point)},rotatePointAroundCenter:function(point,center,angle){return angle=angle*Math.PI/180,vec2.fromValues(Math.cos(angle)*(point[0]-center[0])-Math.sin(angle)*(point[1]-center[1])+center[0],Math.sin(angle)*(point[0]-center[0])+Math.cos(angle)*(point[1]-center[1])+center[1])}}),Path2D=Class.extend({init:function(){this.nodes=[]},isEmpty:function(){return 0===this.nodes.length},getBounds:function(fnTransform){var bounds={min:vec2.create(),max:vec2.create(),center:vec2.create(),size:vec2.create()};if(0<this.nodes.length){bounds.min[0]=this.nodes[0].position2d[0],bounds.min[1]=this.nodes[0].position2d[1],bounds.max[0]=this.nodes[0].position2d[0],bounds.max[1]=this.nodes[0].position2d[1];for(var i=1;i<this.nodes.length;i++){var x=this.nodes[i].position2d[0],y=this.nodes[i].position2d[1];x<bounds.min[0]&&(bounds.min[0]=x),y<bounds.min[1]&&(bounds.min[1]=y),x>bounds.max[0]&&(bounds.max[0]=x),y>bounds.max[1]&&(bounds.max[1]=y)}}return fnTransform&&"function"==typeof fnTransform&&(bounds.min=fnTransform(bounds.min),bounds.max=fnTransform(bounds.max)),bounds.size[0]=bounds.max[0]-bounds.min[0],bounds.size[1]=bounds.max[1]-bounds.min[1],bounds.center[0]=bounds.min[0]+bounds.size[0]/2,bounds.center[1]=bounds.min[1]+bounds.size[1]/2,bounds},getDistance:function(){var length=0;if(0!=this.nodes.length)for(var last=this.nodes[0],i=1,len=this.nodes.length;i<len;i++)length=(length+=vec2.dist(last.position2d,this.nodes[i].position2d))+last.weight,last=this.nodes[i];return length}}),PathFinder2D=Class.extend({init:function(nodes){this.nodes=nodes,this.Infinity=1/0,this.reset()},reset:function(){this.dist={},this.previous={},this.Q=[],this.searched={}},getNodeWithSmallestDistance:function(){for(var min=1/0,index=0,i=0;i<this.Q.length;i++)this.dist[this.Q[i]]<min&&(min=this.dist[this.Q[i]],index=i);return index},isSearched:function(node_id){return node_id in this.searched},decreaseKey:function(node_id){for(var index=0;index<this.Q.length&&this.Q[index]!=node_id;index++);for(var i=index-1;0<i&&this.dist[this.Q[index]]<this.dist[this.Q[i]];i--){var tmp=this.Q[i];this.Q[i]=this.Q[index],this.Q[index]=tmp,index=i}},distanceBetween:function(a,b){var weight;return a&&a.position&&b&&b.position?(weight=0,a.floor_id!=b.floor_id&&(weight=.1),vec3.len(vec3.fromValues(b.position[0]-a.position[0],b.position[1]-a.position[1],b.position[2]-a.position[2]))+weight):1/0},find:function(source,dest,options){if(this.reset(),source in this.nodes&&dest in this.nodes){for(var i in this.nodes)options&&options.ignoreTypes&&-1<options.ignoreTypes.indexOf(this.nodes[i].type)||(this.dist[i]=this.Infinity,this.previous[i]=null,this.Q.push(i));for(this.dist[source]=0;0<this.Q.length;){var nodeIndex=this.getNodeWithSmallestDistance(),u=this.Q[nodeIndex];if(this.dist[u]==this.Infinity)break;if(this.Q.splice(nodeIndex,1),this.searched[u]=!0,u==dest){for(var path=new Path2D,u=dest;null!==this.previous[u];)path.nodes.push(this.nodes[u]),u=this.previous[u];return path.nodes.push(this.nodes[source]),path.nodes.reverse(),path}for(i=0;i<this.nodes[u].neighbours.length;i++){var alt,neighbour=this.nodes[u].neighbours[i];this.isSearched(neighbour.id)||(alt=this.dist[u]+this.distanceBetween(this.nodes[u],neighbour)+neighbour.weight)<this.dist[neighbour.id]&&(this.dist[neighbour.id]=alt,this.previous[neighbour.id]=u,this.decreaseKey(neighbour.id))}}}return!1},pathToText:function(path){var a,p2t=[],step=null,b=null,angle=0;if(2<path.length){var kioskAngle,step={};nodes[path[0]]&&nodes[path[0]].rotation&&(kioskAngle=nodes[path[0]].rotation[1],b=vec2.subtract(vec2.create(),vec2.fromValues(nodes[path[0]].position[0],nodes[path[0]].position[2]),vec2.fromValues(nodes[path[1]].position[0],nodes[path[1]].position[2])),b=vec2.normalize(b,b),angle=Math.round(Math.acos(vec2.dot(b,vec2.fromValues(0,1)))*(180/Math.PI)),p2t.push({angle:angle=(angle+=kioskAngle)<0?360+angle:angle,distance:0}),angle=0);for(var i=0;i<path.length;i++)i<path.length-1&&(step={},a=nodes[path[i]],b=nodes[path[i+1]],step.distance=Math.round(distanceBetween(path[i],path[i+1])),i<path.length-2?(angle=calc2Dangle(nodes[path[i]].position,nodes[path[i+1]].position,nodes[path[i+2]].position),step.angle=angle):step.angle=0,nodes[path[i]].floor&&nodes[path[i+1]].floor&&nodes[path[i]].floor.index!=nodes[path[i+1]].floor.index&&(step.go_to_floor=nodes[path[i+1]].floor.id),nodes[path[i]].type&&(step.type=nodes[path[i]].type),step.aNode=a,step.bNode=b,p2t.push(step))}return p2t}}),LocationProvider=Class.extend({init:function(device){this.device=device,this.locator},setLocator:function(locator){this.locator=locator},setDevice:function(device){this.device=device},start:function(){},stop:function(){},push:function(reading){}}),LocationManager=Class.extend({init:function(wayfinder){this.wayfinder=wayfinder,this.locator=new Locator(this),this.providers={},this.timer,this.time=1500,this.locateCount=0,this.currentLocation=!1,console.log("LocationManager")},cbOnLocationChange:function(location){},addProvider:function(){var type,args;0<arguments.length?(type=(args=Array.prototype.slice.call(arguments)).shift(),(args=function(constructor,args){function F(){return constructor.apply(this,args)}return F.prototype=constructor.prototype,new F}(args.shift(),args)).setLocator(this.locator),args.setDevice(this.wayfinder.device),this.providers[type]=args):console.warn("LocationManager","Provider not given")},hasProvider:function(type){return this.providers[type]},calculate:function(){this.locator.calculate(),0<this.locateCount&&(this.time=1e3),this.timer=setTimeout(ClassCallback(this,this.calculate),this.time)},start:function(callback){for(var i in console.log("start"),this.providers)this.providers[i].start();this.timer=setTimeout(ClassCallback(this,this.calculate),this.time)},isStarted:function(){return this.timer},stop:function(){try{for(var i in this.providers)this.providers[i].stop()}catch(err){console.log("Beacon provides failed to stop",err)}clearTimeout(this.timer)},locationChange:function(_location){this.currentLocation=_location,this.locateCount++,"function"==typeof this.cbOnLocationChange&&this.cbOnLocationChange(_location,this.locateCount),1==this.locateCount&&this.wayfinder.events.trigger("location-success")},getCurrentPosition:function(){return this.currentLocation},getFailCount:function(){return this.locator.failCount},pushReading:function(type,reading){type=this.providers[type];type&&type.push(reading)}}),GeolocationProvider=LocationProvider.extend({init:function(device){this._super(device),this.wayfinder=device.wayfinder,this.buildingLocation={latitude:0,longitude:0,direction:0,scale:1},this.cbOnPositionUpdate=!1,this.currentPosition=vec2.create(),this.currentGeoPosition=vec2.create(),this.positionWatch=!1,this.mapImageSize=2048,this.mapLODLevels=2,this.mapSize=Math.floor(this.mapImageSize/Math.pow(2,this.mapLODLevels-1)),this.timeoutCount=0,this.epsg="EPSG:2958"},getUTMZone:function(longitude){return Math.floor((longitude+180)/6)+1},getCurrentPosition:function(){return this.currentPosition},setBuildingLocation:function(location){this.buildingLocation.latitude=parseFloat(location.latitude),this.buildingLocation.longitude=parseFloat(location.longitude),this.buildingLocation.direction=parseFloat(location.direction),this.buildingLocation.scale=parseFloat(location.scale)},getBuildingPosition:function(loc){return vec2.fromValues(loc.latitude,loc.longitude)},getBuildingPositionUTM:function(pos){Proj4js.defs[this.epsg]="+proj=utm +zone="+this.getUTMZone(pos[1])+" +ellps=GRS80 +units=m +no_defs";var proj=new Proj4js.Proj(this.epsg);return Proj4jsToVector(Proj4js.transform(Proj4js.WGS84,proj,VectorToProj4js(pos)))},setPosition:function(position){var buildingLocation=this.getBuildingPosition(this.wayfinder.building.location),direction=this.wayfinder.building.location.direction,proj=(this.currentGeoPosition[0]=parseFloat(position.coords.latitude),this.currentGeoPosition[1]=parseFloat(position.coords.longitude),Proj4js.defs[this.epsg]="+proj=utm +zone="+this.getUTMZone(this.currentGeoPosition[1])+" +ellps=GRS80 +units=m +no_defs",new Proj4js.Proj(this.epsg)),size=this.wayfinder.building.location.scale*this.mapSize,p0=this.getBuildingPositionUTM(buildingLocation),origin=VectorToProj4js(p0),p1=Proj4js.transform(proj,Proj4js.WGS84,new Proj4js.Point(origin.x+size,origin.y)),p2=Proj4js.transform(proj,Proj4js.WGS84,new Proj4js.Point(origin.x+size,origin.y-size)),origin=Proj4js.transform(proj,Proj4js.WGS84,new Proj4js.Point(origin.x,origin.y-size)),p1=RotateGeo(buildingLocation,Proj4jsToVector(p1),direction),p2=RotateGeo(buildingLocation,Proj4jsToVector(p2),direction),origin=RotateGeo(buildingLocation,Proj4jsToVector(origin),direction),size=(p1=Proj4jsToVector(Proj4js.transform(Proj4js.WGS84,proj,VectorToProj4js(p1))),p2=Proj4jsToVector(Proj4js.transform(Proj4js.WGS84,proj,VectorToProj4js(p2))),origin=Proj4jsToVector(Proj4js.transform(Proj4js.WGS84,proj,VectorToProj4js(origin))),Proj4jsToVector(Proj4js.transform(Proj4js.WGS84,proj,VectorToProj4js(this.currentGeoPosition)))),buildingLocation=(this.currentPosition=vec2.create(),vec2.sub(vec2.create(),origin,p0)),direction=vec2.sub(vec2.create(),origin,p2),proj=vec2.sub(vec2.create(),p1,p2),v3=vec2.sub(vec2.create(),p1,p0),sp0=vec2.sub(vec2.create(),size,p0),p2=vec2.sub(vec2.create(),size,p2);0<=vec2.dot(buildingLocation,sp0)&&0<=vec2.dot(direction,p2)&&0<=vec2.dot(proj,p2)&&0<=vec2.dot(v3,sp0)?(buildingLocation=ProjectToLine(p0,p1,size),direction=ProjectToLine(p0,origin,size),proj=vec2.len(vec2.sub(vec2.create(),buildingLocation,p0))/vec2.len(vec2.sub(vec2.create(),p1,p0)),v3=vec2.len(vec2.sub(vec2.create(),direction,p0))/vec2.len(vec2.sub(vec2.create(),origin,p0)),this.currentPosition[0]=proj*this.mapSize,this.currentPosition[1]=v3*this.mapSize,this.locator.push(position.timestamp,"gps",[this.currentPosition[0],this.currentPosition[1]],position.coords.accuracy,10,wayfinder.getCurrentFloor(),0)):console.log("User position is outside the map rectangle",{coords:[sp0,p2]})},start:function(){var scope;navigator.geolocation&&(console.log("GeolocationProvider.start",this.wayfinder),this.setBuildingLocation(this.wayfinder.building.location),(scope=this).positionWatch=navigator.geolocation.watchPosition(ClassCallback(this,this.setPosition),function(error){error.code==error.TIMEOUT?scope.timeoutCount++:(new UserMessage("location_unavailable","warning",scope.wayfinder),navigator.geolocation.clearWatch(scope.positionWatch),scope.positionWatch=!1,this.locator.onProviderFailed("User position failed",error))},{maximumAge:3e3,timeout:6e3,frequency:3e3,enableHighAccuracy:!0}))},stopPositionWatch:function(){navigator.geolocation.clearWatch(this.positionWatch)}}),Locator=Class.extend({init:function(manager){this.manager=manager,this.beacons={},this.foundBeacons={},this.lastLocation,this.lowBeaconCount=0,this.SMALL=1e-10,this.floors=[],this.failCount=0},onProviderFailed:function(message,data){console.log("Location provider failed",message,data),this.manager.wayfinder.events.trigger("location-failed")},onProviderInitialSuccess:function(){this.manager.wayfinder.events.trigger("location-success")},push:function(id,type,location,strength,radius,floor,node){console.log("New beacon reading",id,type,location,strength,radius),location?(radius=radius||50,this.beacons[id]||(this.beacons[id]={id:id,type:type,location:location,radius:radius,strength:[],floor:floor,node:node}),node&&node.id&&(this.foundBeacons[node.id]={id:id,type:type,location:location,radius:radius,strength:[],floor:floor,node:node}),this.beacons[id].strength.push(strength)):console.log("No location given for",id)},shallowCopyOBJ:function(source){var i,target={};for(i in source)source.hasOwnProperty(i)&&(target[i]=source[i]);return target},median:function(numbers){var median=0,numsLen=numbers.length;if(numbers.sort(),numsLen%2==0)median=(numbers[numsLen/2-1]+numbers[numsLen/2])/2;else{if(1==numsLen)return.9*numbers[0];median=numbers[(numsLen-1)/2]}return median},distance:function(p1,p2){return Math.sqrt((p1.x-p2.x)*(p1.x-p2.x)+(p1.y-p2.y)*(p1.y-p2.y))},circleCircleIntersection:function(p1,p2){var x0,rx,d=this.distance(p1,p2),r1=p1.radius,r2=p2.radius;return r1+r2<=d||d<=Math.abs(r1-r2)?[]:(r2=(r1*r1-r2*r2+d*d)/(2*d),r1=Math.sqrt(r1*r1-r2*r2),x0=p1.x+r2*(p2.x-p1.x)/d,r2=p1.y+r2*(p2.y-p1.y)/d,[{x:x0+(rx=-(p2.y-p1.y)*(r1/d)),y:r2-(p2=-(p2.x-p1.x)*(r1/d))},{x:x0-rx,y:r2+p2}])},containedInCircles:function(point,circles){for(var i=0;i<circles.length;++i)if(this.distance(point,circles[i])>circles[i].radius+this.SMALL)return!1;return!0},getCenter:function(points){for(var center={x:0,y:0},i=0;i<points.length;++i)center.x+=points[i].x,center.y+=points[i].y;return center.x/=points.length,center.y/=points.length,center},getIntersectionPoints:function(circles){for(var ret=[],i=0;i<circles.length;++i){console.log("getIntersectionPoints",circles[i]);for(var j=i+1;j<circles.length;++j)for(var intersect=this.circleCircleIntersection(circles[i],circles[j]),k=0;k<intersect.length;++k){var p=intersect[k];p.parentIndex=[i,j],ret.push(p)}}return ret},calculateArea:function(points){for(var point1,point2,area=0,i=0,j=points.length-1;i<points.length;j=i,i++)point1=points[i].location,point2=points[j].location,area=(area+=point1[0]*point2[1])-point1[1]*point2[0];return area/=2},calculateCenter2:function(points){for(var f,point1,point2,x=0,y=0,i=0,j=points.length-1;i<points.length;j=i,i++)point1=points[i].location,point2=points[j].location,point1&&point2?(f=point1[0]*point2[1]-point2[0]*point1[1],x+=(point1[0]+point2[0])*f,y+=(point1[1]+point2[1])*f):console.log("no location",points[i]);return[x/(f=6*this.calculateArea(points)),y/f]},calculateCenter:function(points){for(var total=vec2.create(),i=0;i<points.length;i++)vec2.add(total,total,points[i].location);return vec2.divide(total,total,vec2.fromValues(points.length,points.length))},calculateDistanceFromCentre:function(centre,poing){},triangleArea:function(vertexA,vertexB,vertexC){return Math.abs(.5*((vertexA.x-vertexC.x)*(vertexB.y-vertexA.y)-(vertexA.x-vertexB.x)*(vertexC.y-vertexA.y)))},listTriples:function(N){function fn(n,src,got,all){if(0==n)0<got.length&&(all[all.length]=got);else for(var j=0;j<src.length;j++)fn(n-1,src.slice(j+1),got.concat([src[j]]),all)}var triples=[],N=Array.apply(null,{length:N}).map(Number.call,Number);return fn(3,N,[],triples),triples},isInTriangle:function(newPoint,vertexA,vertexB,vertexC){var vertexC=[vertexC.x-vertexA.x,vertexC.y-vertexA.y],vertexB=[vertexB.x-vertexA.x,vertexB.y-vertexA.y],newPoint=[newPoint.x-vertexA.x,newPoint.y-vertexA.y],vertexA=vertexC[0]*vertexC[0]+vertexC[1]*vertexC[1],dot01=vertexC[0]*vertexB[0]+vertexC[1]*vertexB[1],vertexC=vertexC[0]*newPoint[0]+vertexC[1]*newPoint[1],dot11=vertexB[0]*vertexB[0]+vertexB[1]*vertexB[1],vertexB=vertexB[0]*newPoint[0]+vertexB[1]*newPoint[1],newPoint=1/(vertexA*dot11-dot01*dot01),dot11=(dot11*vertexC-dot01*vertexB)*newPoint,vertexA=(vertexA*vertexB-dot01*vertexC)*newPoint;return 0<=dot11&&0<=vertexA&&dot11+vertexA<1},barycentricInterpolate:function(newPoint,vertexA,vertexB,vertexC){var area=this.triangleArea(vertexA,vertexB,vertexC),sub_area_1=this.triangleArea(newPoint,vertexB,vertexC),sub_area_2=this.triangleArea(vertexA,newPoint,vertexC),newPoint=this.triangleArea(vertexA,vertexB,newPoint);return(sub_area_1*vertexA.v+sub_area_2*vertexB.v+newPoint*vertexC.v)/area},interpolate:function(newPoint,data){var smallest_triangle,triangles=this.listTriples(data.length),smallest_triangle_area=Number.MAX_VALUE;for(t in triangles){var vertexA=data[triangles[t][0]],vertexB=data[triangles[t][1]],vertexC=data[triangles[t][2]];this.isInTriangle(newPoint,vertexA,vertexB,vertexC)&&this.triangleArea(vertexA,vertexB,vertexC)<smallest_triangle_area&&(smallest_triangle=[vertexA,vertexB,vertexC])}return smallest_triangle?this.barycentricInterpolate(newPoint,smallest_triangle[0],smallest_triangle[1],smallest_triangle[2]):"Interpolation failed: newPoint isn't in a triangle"},findBarycentricCoordindate:function(p1,p2,p3){var total=p1.pullValue+p2.pullValue+p3.pullValue,loc=vec2.create(),_p2=vec2.create(),_p3=vec2.create();return vec2.scale(loc,p1.location,p1.pullValue/total),vec2.scale(_p2,p2.location,p2.pullValue/total),vec2.scale(_p3,p3.location,p3.pullValue/total),vec2.add(loc,loc,_p2),vec2.add(loc,loc,_p3),{location:loc,pullValue:Math.min(p1.pullValue,p2.pullValue,p3.pullValue)}},findLocation:function(data){for(var _data=data.slice(),_newP=!1;3<=_data.length;)_newP=this.findBarycentricCoordindate(_data[0],_data[1],_data[2]),_data.splice(0,2),_data.unshift(_newP);return _newP},calcStrength:function(beacon){return beacon.calcStrength=this.median(beacon.strength),beacon.calcRadius=beacon.calcStrength*beacon.radius,beacon},calculateLowPos:function(){var a,dist,b,keys=Object.keys(this.beacons);console.log("Calculating backup location. Found beacons:",keys.length),1<keys.length?(a=this.calcStrength(this.beacons[keys[0]]),b=this.calcStrength(this.beacons[keys[1]]),a.pullValue=a.calcStrength/(a.calcStrength+b.calcStrength)*1/(parseFloat(a.radius)/(parseFloat(a.radius)+parseFloat(b.radius))),b.pullValue=b.calcStrength/(a.calcStrength+b.calcStrength)*1/(parseFloat(b.radius)/(parseFloat(a.radius)+parseFloat(b.radius))),dist=vec2.add(vec2.create(),a.location,b.location),b=a.pullValue/(a.pullValue+b.pullValue),dist=vec2.scale(vec2.create(),dist,b),this.manager.locationChange({location:dist,center:dist,strength:1,radius:1,hotspots:[],floor:a.floor})):(b=this.beacons[keys[0]],WF_DEBUG&&console.log("Single position",b),this.manager.locationChange({location:b.location,center:b.location,strength:1,radius:1,hotspots:[],floor:b.floor}))},clearBeacons:function(){this.beacons={},this.foundBeacons={}},calcFloor:function(floor,beacons){this.floors.push(floor.index),3<this.floors.length&&this.floors.shift();for(var sum=0,i=0;i<this.floors.length;i++)sum+=this.floors[i];for(var index=Math.round(sum/this.floors.length),j=0;j<beacons.length;j++)if(beacons[j].floor.index==index)return beacons[j].floor;return floor},calculate:function(){var count=Object.keys(this.beacons).length;if(count<3)0<count?(3<this.lowBeaconCount&&(this.calculateLowPos(),this.clearBeacons(),this.lowBeaconCount=0,this.failCount--),this.lowBeaconCount++):this.failCount++,console.info("Not enough beacons",count,"/",3);else{this.failCount=0,this.lowBeaconCount=0;var _beacons=this.shallowCopyOBJ(this.beacons),strength=(this.beacons={},1),totalStrength=0,radius=0,radiuses=[],__beacons=[];for(i in _beacons)_beacons[i]=this.calcStrength(_beacons[i]),totalStrength+=_beacons[i].calcStrength,strength=(strength+_beacons[i].calcStrength)/2,radius+=parseFloat(_beacons[i].radius),radiuses.push(parseFloat(_beacons[i].radius)),__beacons.push(_beacons[i]);for(var center=this.calculateCenter(__beacons),i=0;i<__beacons.length;i++)__beacons[i].distance=vec2.dist(vec2.create(),center,__beacons[i].location),__beacons[i].pullValue=__beacons[i].calcStrength/totalStrength*1/(__beacons[i].radius/radius),__beacons[i].distance;__beacons.sort(function(a,b){return a.pullValue-b.pullValue});var floor,count=this.findLocation(__beacons);!center||isNaN(count.location[0])||isNaN(count.location[1])||(floor=this.calcFloor(__beacons[__beacons.length-1].floor,__beacons),this.clearBeacons(),this.push("last.l.v","last",count.location,count.pullValue/__beacons.length,radius/__beacons.length,floor),this.manager.locationChange({location:count.location,center:center,strength:strength,radius:radius,hotspots:__beacons,floor:floor}))}}});function Proj4jsToVector(p){return vec2.fromValues(p.y,p.x)}function VectorToProj4js(p){return new Proj4js.Point(p[1],p[0])}function DegToRad(deg){return deg/180*Math.PI}function RadToDeg(rad){return rad/Math.PI*180}function RotateGeo(origin,point,angle){angle=DegToRad(angle);return vec2.fromValues(origin[0]+(Math.sin(angle)*(point[1]-origin[1])*Math.abs(Math.cos(DegToRad(origin[0])))+Math.cos(angle)*(point[0]-origin[0])),origin[1]+(Math.cos(angle)*(point[1]-origin[1])-Math.sin(angle)*(point[0]-origin[0])/Math.abs(Math.cos(DegToRad(origin[0])))))}function ProjectToLine(lineStart,lineEnd,point){var lineEnd=(lineEnd[1]-lineStart[1])/(lineEnd[0]-lineStart[0]),lineStart=(Math.abs(lineEnd)===1/0&&(lineEnd=1),lineStart[1]-lineEnd*lineStart[0]),x=(lineEnd*point[1]+point[0]-lineEnd*lineStart)/(lineEnd*lineEnd+1),point=(lineEnd*lineEnd*point[1]+lineEnd*point[0]+lineStart)/(lineEnd*lineEnd+1);return vec2.fromValues(x,point)}var Proj4js={defaultDatum:"WGS84",transform:function(a,c,b){var d;return a.readyToUse?c.readyToUse?(a.datum&&c.datum&&((a.datum.datum_type==Proj4js.common.PJD_3PARAM||a.datum.datum_type==Proj4js.common.PJD_7PARAM)&&"WGS84"!=c.datumCode||(c.datum.datum_type==Proj4js.common.PJD_3PARAM||c.datum.datum_type==Proj4js.common.PJD_7PARAM)&&"WGS84"!=a.datumCode)&&(d=Proj4js.WGS84,this.transform(a,d,b),a=d),"enu"!=a.axis&&this.adjust_axis(a,!1,b),"longlat"==a.projName?(b.x*=Proj4js.common.D2R,b.y*=Proj4js.common.D2R):(a.to_meter&&(b.x*=a.to_meter,b.y*=a.to_meter),a.inverse(b)),a.from_greenwich&&(b.x+=a.from_greenwich),b=this.datum_transform(a.datum,c.datum,b),c.from_greenwich&&(b.x-=c.from_greenwich),"longlat"==c.projName?(b.x*=Proj4js.common.R2D,b.y*=Proj4js.common.R2D):(c.forward(b),c.to_meter&&(b.x/=c.to_meter,b.y/=c.to_meter)),"enu"!=c.axis&&this.adjust_axis(c,!0,b)):this.reportError("Proj4js initialization for:"+c.srsCode+" not yet complete"):this.reportError("Proj4js initialization for:"+a.srsCode+" not yet complete"),b},datum_transform:function(a,c,b){return a.compare_datums(c)||a.datum_type==Proj4js.common.PJD_NODATUM||c.datum_type==Proj4js.common.PJD_NODATUM||a.es==c.es&&a.a==c.a&&a.datum_type!=Proj4js.common.PJD_3PARAM&&a.datum_type!=Proj4js.common.PJD_7PARAM&&c.datum_type!=Proj4js.common.PJD_3PARAM&&c.datum_type!=Proj4js.common.PJD_7PARAM||(a.geodetic_to_geocentric(b),a.datum_type!=Proj4js.common.PJD_3PARAM&&a.datum_type!=Proj4js.common.PJD_7PARAM||a.geocentric_to_wgs84(b),c.datum_type!=Proj4js.common.PJD_3PARAM&&c.datum_type!=Proj4js.common.PJD_7PARAM||c.geocentric_from_wgs84(b),c.geocentric_to_geodetic(b)),b},adjust_axis:function(a,c,b){for(var g,i,d=b.x,e=b.y,f=b.z||0,h=0;h<3;h++)if(!c||2!=h||void 0!==b.z)switch(i=0==h?(g=d,"x"):1==h?(g=e,"y"):(g=f,"z"),a.axis[h]){case"e":b[i]=g;break;case"w":b[i]=-g;break;case"n":b[i]=g;break;case"s":b[i]=-g;break;case"u":void 0!==b[i]&&(b.z=g);break;case"d":void 0!==b[i]&&(b.z=-g);break;default:return alert("ERROR: unknow axis ("+a.axis[h]+") - check definition of "+a.projName),null}return b},reportError:function(){},extend:function(a,c){if(a=a||{},c)for(var b in c){var d=c[b];void 0!==d&&(a[b]=d)}return a},Class:function(){function a(){this.initialize.apply(this,arguments)}for(var b,c={},d=0;d<arguments.length;++d)b="function"==typeof arguments[d]?arguments[d].prototype:arguments[d],Proj4js.extend(c,b);return a.prototype=c,a},bind:function(a,c){var b=Array.prototype.slice.apply(arguments,[2]);return function(){var d=b.concat(Array.prototype.slice.apply(arguments,[0]));return a.apply(c,d)}},scriptName:"proj4js-compressed.js",defsLookupService:"http://spatialreference.org/ref",libPath:null,getScriptLocation:function(){if(this.libPath)return this.libPath;for(var a=this.scriptName,c=a.length,b=document.getElementsByTagName("script"),d=0;d<b.length;d++){var e=b[d].getAttribute("src");if(e){var f=e.lastIndexOf(a);if(-1<f&&f+c==e.length){this.libPath=e.slice(0,-c);break}}}return this.libPath||""},loadScript:function(a,c,b,d){var e=document.createElement("script");e.defer=!1,e.type="text/javascript",e.id=a,e.src=a,e.onload=c,e.onerror=b,e.loadCheck=d,/MSIE/.test(navigator.userAgent)&&(e.onreadystatechange=this.checkReadyState),document.getElementsByTagName("head")[0].appendChild(e)},checkReadyState:function(){"loaded"==this.readyState&&(this.loadCheck()?this.onload():this.onerror())}};function phi4z(a,c,b,d,e,f,g,i,h){for(var j,k,m,h=f,o=1;o<=15;o++)if(j=Math.sin(h),i=Math.tan(h)*Math.sqrt(1-a*j*j),j=2*(m=c*h-b*(k=Math.sin(2*h))+d*Math.sin(4*h)-e*Math.sin(6*h))+i*(m*m+g)-2*f*(i*m+1),h+=j/=a*k*(m*m+g-2*f*m)/(2*i)+(2*(f-m)*(i*(m=c-2*b*Math.cos(2*h)+4*d*Math.cos(4*h)-6*e*Math.cos(6*h))-2/k)-2*m),Math.abs(j)<=1e-10)return h;return Proj4js.reportError("phi4z: No convergence"),null}function e4fn(a){var c=1+a;return a=1-a,Math.sqrt(Math.pow(c,c)*Math.pow(a,a))}Proj4js.Proj=Proj4js.Class({readyToUse:!1,title:null,projName:null,units:null,datum:null,x0:0,y0:0,localCS:!1,queue:null,initialize:function(a,c){var b;this.srsCodeInput=a,this.queue=[],c&&this.queue.push(c),0<=a.indexOf("GEOGCS")||0<=a.indexOf("GEOCCS")||0<=a.indexOf("PROJCS")||0<=a.indexOf("LOCAL_CS")?(this.parseWKT(a),this.deriveConstants(),this.loadProjCode(this.projName)):(0==a.indexOf("urn:")?"ogc"!=(b=a.split(":"))[1]&&"x-ogc"!=b[1]||"def"!=b[2]||"crs"!=b[3]||(a=b[4]+":"+b[b.length-1]):0==a.indexOf("http://")&&((b=a.split("#"))[0].match(/epsg.org/)?a="EPSG:"+b[1]:b[0].match(/RIG.xml/)&&(a="IGNF:"+b[1])),this.srsCode=a.toUpperCase(),0==this.srsCode.indexOf("EPSG")?(this.srsCode=this.srsCode,this.srsAuth="epsg",this.srsProjNumber=this.srsCode.substring(5)):0==this.srsCode.indexOf("IGNF")?(this.srsCode=this.srsCode,this.srsAuth="IGNF",this.srsProjNumber=this.srsCode.substring(5)):0==this.srsCode.indexOf("CRS")?(this.srsCode=this.srsCode,this.srsAuth="CRS",this.srsProjNumber=this.srsCode.substring(4)):(this.srsAuth="",this.srsProjNumber=this.srsCode),this.loadProjDefinition())},loadProjDefinition:function(){var a;Proj4js.defs[this.srsCode]?this.defsLoaded():(a=Proj4js.getScriptLocation()+"defs/"+this.srsAuth.toUpperCase()+this.srsProjNumber+".js",Proj4js.loadScript(a,Proj4js.bind(this.defsLoaded,this),Proj4js.bind(this.loadFromService,this),Proj4js.bind(this.checkDefsLoaded,this)))},loadFromService:function(){Proj4js.loadScript(Proj4js.defsLookupService+"/"+this.srsAuth+"/"+this.srsProjNumber+"/proj4js/",Proj4js.bind(this.defsLoaded,this),Proj4js.bind(this.defsFailed,this),Proj4js.bind(this.checkDefsLoaded,this))},defsLoaded:function(){this.parseDefs(),this.loadProjCode(this.projName)},checkDefsLoaded:function(){return!!Proj4js.defs[this.srsCode]},defsFailed:function(){Proj4js.reportError("failed to load projection definition for: "+this.srsCode),Proj4js.defs[this.srsCode]=Proj4js.defs.WGS84,this.defsLoaded()},loadProjCode:function(a){var c;Proj4js.Proj[a]?this.initTransforms():(c=Proj4js.getScriptLocation()+"projCode/"+a+".js",Proj4js.loadScript(c,Proj4js.bind(this.loadProjCodeSuccess,this,a),Proj4js.bind(this.loadProjCodeFailure,this,a),Proj4js.bind(this.checkCodeLoaded,this,a)))},loadProjCodeSuccess:function(a){Proj4js.Proj[a].dependsOn?this.loadProjCode(Proj4js.Proj[a].dependsOn):this.initTransforms()},loadProjCodeFailure:function(a){Proj4js.reportError("failed to find projection file for: "+a)},checkCodeLoaded:function(a){return!!Proj4js.Proj[a]},initTransforms:function(){if(Proj4js.extend(this,Proj4js.Proj[this.projName]),this.init(),this.readyToUse=!0,this.queue)for(var a;a=this.queue.shift();)a.call(this,this)},wktRE:/^(\w+)\[(.*)\]$/,parseWKT:function(a){if(a=a.match(this.wktRE)){var c=a[1],b=a[2].split(","),d="TOWGS84"==c.toUpperCase()?c:b.shift();d=(d=d.replace(/^\"/,"")).replace(/\"$/,"");for(var a=[],e=0,f="",g=0;g<b.length;++g){for(var i=b[g],h=0;h<i.length;++h)"["==i.charAt(h)&&++e,"]"==i.charAt(h)&&--e;f+=i,0===e?(a.push(f),f=""):f+=","}switch(c){case"LOCAL_CS":this.projName="identity",this.localCS=!0,this.srsCode=d;break;case"GEOGCS":this.projName="longlat",this.geocsCode=d,this.srsCode||(this.srsCode=d);break;case"PROJCS":this.srsCode=d;break;case"PROJECTION":this.projName=Proj4js.wktProjections[d];break;case"DATUM":this.datumName=d;break;case"LOCAL_DATUM":this.datumCode="none";break;case"SPHEROID":this.ellps=d,this.a=parseFloat(a.shift()),this.rf=parseFloat(a.shift());break;case"PRIMEM":this.from_greenwich=parseFloat(a.shift());break;case"UNIT":this.units=d,this.unitsPerMeter=parseFloat(a.shift());break;case"PARAMETER":switch(c=d.toLowerCase(),b=parseFloat(a.shift()),c){case"false_easting":this.x0=b;break;case"false_northing":this.y0=b;break;case"scale_factor":this.k0=b;break;case"central_meridian":this.long0=b*Proj4js.common.D2R;break;case"latitude_of_origin":this.lat0=b*Proj4js.common.D2R}break;case"TOWGS84":this.datum_params=a;break;case"AXIS":switch(c=d.toLowerCase(),b=a.shift()){case"EAST":b="e";break;case"WEST":b="w";break;case"NORTH":b="n";break;case"SOUTH":b="s";break;case"UP":b="u";break;case"DOWN":b="d";break;default:b=" "}switch(this.axis||(this.axis="enu"),c){case"x":this.axis=b+this.axis.substr(1,2);break;case"y":this.axis=this.axis.substr(0,1)+b+this.axis.substr(2,1);break;case"z":this.axis=this.axis.substr(0,2)+b}}for(g=0;g<a.length;++g)this.parseWKT(a[g])}},parseDefs:function(){var a,c;if(this.defData=Proj4js.defs[this.srsCode],this.defData){for(var b=this.defData.split("+"),d=0;d<b.length;d++)switch(c=b[d].split("="),a=c[0].toLowerCase(),c=c[1],a.replace(/\s/gi,"")){case"title":this.title=c;break;case"proj":this.projName=c.replace(/\s/gi,"");break;case"units":this.units=c.replace(/\s/gi,"");break;case"datum":this.datumCode=c.replace(/\s/gi,"");break;case"nadgrids":this.nagrids=c.replace(/\s/gi,"");break;case"ellps":this.ellps=c.replace(/\s/gi,"");break;case"a":this.a=parseFloat(c);break;case"b":this.b=parseFloat(c);break;case"rf":this.rf=parseFloat(c);break;case"lat_0":this.lat0=c*Proj4js.common.D2R;break;case"lat_1":this.lat1=c*Proj4js.common.D2R;break;case"lat_2":this.lat2=c*Proj4js.common.D2R;break;case"lat_ts":this.lat_ts=c*Proj4js.common.D2R;break;case"lon_0":this.long0=c*Proj4js.common.D2R;break;case"alpha":this.alpha=parseFloat(c)*Proj4js.common.D2R;break;case"lonc":this.longc=c*Proj4js.common.D2R;break;case"x_0":this.x0=parseFloat(c);break;case"y_0":this.y0=parseFloat(c);break;case"k_0":case"k":this.k0=parseFloat(c);break;case"r_a":this.R_A=!0;break;case"zone":this.zone=parseInt(c,10);break;case"south":this.utmSouth=!0;break;case"towgs84":this.datum_params=c.split(",");break;case"to_meter":this.to_meter=parseFloat(c);break;case"from_greenwich":this.from_greenwich=c*Proj4js.common.D2R;break;case"pm":c=c.replace(/\s/gi,""),this.from_greenwich=Proj4js.PrimeMeridian[c]||parseFloat(c),this.from_greenwich*=Proj4js.common.D2R;break;case"axis":3==(c=c.replace(/\s/gi,"")).length&&-1!="ewnsud".indexOf(c.substr(0,1))&&-1!="ewnsud".indexOf(c.substr(1,1))&&-1!="ewnsud".indexOf(c.substr(2,1))&&(this.axis=c)}this.deriveConstants()}},deriveConstants:function(){var a;"@null"==this.nagrids&&(this.datumCode="none"),this.datumCode&&"none"!=this.datumCode&&(a=Proj4js.Datum[this.datumCode])&&(this.datum_params=a.towgs84?a.towgs84.split(","):null,this.ellps=a.ellipse,this.datumName=a.datumName||this.datumCode),this.a||Proj4js.extend(this,Proj4js.Ellipsoid[this.ellps]||Proj4js.Ellipsoid.WGS84),this.rf&&!this.b&&(this.b=(1-1/this.rf)*this.a),(0===this.rf||Math.abs(this.a-this.b)<Proj4js.common.EPSLN)&&(this.sphere=!0,this.b=this.a),this.a2=this.a*this.a,this.b2=this.b*this.b,this.es=(this.a2-this.b2)/this.a2,this.e=Math.sqrt(this.es),this.R_A&&(this.a*=1-this.es*(Proj4js.common.SIXTH+this.es*(Proj4js.common.RA4+this.es*Proj4js.common.RA6)),this.a2=this.a*this.a,this.b2=this.b*this.b,this.es=0),this.ep2=(this.a2-this.b2)/this.b2,this.k0||(this.k0=1),this.axis||(this.axis="enu"),this.datum=new Proj4js.datum(this)}}),Proj4js.Proj.longlat={init:function(){},forward:function(a){return a},inverse:function(a){return a}},Proj4js.Proj.identity=Proj4js.Proj.longlat,Proj4js.defs={WGS84:"+title=long/lat:WGS84 +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees","EPSG:4326":"+title=long/lat:WGS84 +proj=longlat +a=6378137.0 +b=6356752.31424518 +ellps=WGS84 +datum=WGS84 +units=degrees","EPSG:4269":"+title=long/lat:NAD83 +proj=longlat +a=6378137.0 +b=6356752.31414036 +ellps=GRS80 +datum=NAD83 +units=degrees","EPSG:3875":"+title= Google Mercator +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs"},Proj4js.defs["EPSG:3785"]=Proj4js.defs["EPSG:3875"],Proj4js.defs.GOOGLE=Proj4js.defs["EPSG:3875"],Proj4js.defs["EPSG:900913"]=Proj4js.defs["EPSG:3875"],Proj4js.defs["EPSG:102113"]=Proj4js.defs["EPSG:3875"],Proj4js.common={PI:3.141592653589793,HALF_PI:1.5707963267948966,TWO_PI:6.283185307179586,FORTPI:.7853981633974483,R2D:57.29577951308232,D2R:.017453292519943295,SEC_TO_RAD:484813681109536e-20,EPSLN:1e-10,MAX_ITER:20,COS_67P5:.3826834323650898,AD_C:1.0026,PJD_UNKNOWN:0,PJD_3PARAM:1,PJD_7PARAM:2,PJD_GRIDSHIFT:3,PJD_WGS84:4,PJD_NODATUM:5,SRS_WGS84_SEMIMAJOR:6378137,SIXTH:.16666666666666666,RA4:.04722222222222222,RA6:.022156084656084655,RV4:.06944444444444445,RV6:.04243827160493827,msfnz:function(a,c,b){return a*=c,b/Math.sqrt(1-a*a)},tsfnz:function(a,c,b){return b*=a,b=Math.pow((1-b)/(1+b),.5*a),Math.tan(.5*(this.HALF_PI-c))/b},phi2z:function(a,c){for(var d,b=.5*a,e=this.HALF_PI-2*Math.atan(c),f=0;f<=15;f++)if(d=a*Math.sin(e),e+=d=this.HALF_PI-2*Math.atan(c*Math.pow((1-d)/(1+d),b))-e,Math.abs(d)<=1e-10)return e;return alert("phi2z has NoConvergence"),-9999},qsfnz:function(a,c){var b;return 1e-7<a?(1-a*a)*(c/(1-(b=a*c)*b)-.5/a*Math.log((1-b)/(1+b))):2*c},asinz:function(a){return 1<Math.abs(a)&&(a=1<a?1:-1),Math.asin(a)},e0fn:function(a){return 1-.25*a*(1+a/16*(3+1.25*a))},e1fn:function(a){return.375*a*(1+.25*a*(1+.46875*a))},e2fn:function(a){return.05859375*a*a*(1+.75*a)},e3fn:function(a){return a*a*a*(35/3072)},mlfn:function(a,c,b,d,e){return a*e-c*Math.sin(2*e)+b*Math.sin(4*e)-d*Math.sin(6*e)},srat:function(a,c){return Math.pow((1-a)/(1+a),c)},sign:function(a){return a<0?-1:1},adjust_lon:function(a){return Math.abs(a)<this.PI?a:a-this.sign(a)*this.TWO_PI},adjust_lat:function(a){return Math.abs(a)<this.HALF_PI?a:a-this.sign(a)*this.PI},latiso:function(a,c,b){return Math.abs(c)>this.HALF_PI?+Number.NaN:c==this.HALF_PI?Number.POSITIVE_INFINITY:c==-1*this.HALF_PI?-1*Number.POSITIVE_INFINITY:(b*=a,Math.log(Math.tan((this.HALF_PI+c)/2))+a*Math.log((1-b)/(1+b))/2)},fL:function(a,c){return 2*Math.atan(a*Math.exp(c))-this.HALF_PI},invlatiso:function(a,c){for(var d,e,b=this.fL(1,c);d=b,e=a*Math.sin(d),b=this.fL(Math.exp(a*Math.log((1+e)/(1-e))/2),c),1e-12<Math.abs(b-d););return b},sinh:function(a){return((a=Math.exp(a))-1/a)/2},cosh:function(a){return((a=Math.exp(a))+1/a)/2},tanh:function(a){return((a=Math.exp(a))-1/a)/(a+1/a)},asinh:function(a){return(0<=a?1:-1)*Math.log(Math.abs(a)+Math.sqrt(a*a+1))},acosh:function(a){return 2*Math.log(Math.sqrt((a+1)/2)+Math.sqrt((a-1)/2))},atanh:function(a){return Math.log((a-1)/(a+1))/2},gN:function(a,c,b){return c*=b,a/Math.sqrt(1-c*c)},pj_enfn:function(a){var c=[],b=(c[0]=this.C00-a*(this.C02+a*(this.C04+a*(this.C06+a*this.C08))),c[1]=a*(this.C22-a*(this.C04+a*(this.C06+a*this.C08))),a*a);return c[2]=b*(this.C44-a*(this.C46+a*this.C48)),c[3]=(b*=a)*(this.C66-a*this.C68),c[4]=b*a*this.C88,c},pj_mlfn:function(a,c,b,d){return d[0]*a-(b*=c)*(d[1]+(c*=c)*(d[2]+c*(d[3]+c*d[4])))},pj_inv_mlfn:function(a,c,b){for(var d=1/(1-c),e=a,f=Proj4js.common.MAX_ITER;f;--f){var g=Math.sin(e),i=1-c*g*g,e=e-(i=(this.pj_mlfn(e,g,Math.cos(e),b)-a)*i*Math.sqrt(i)*d);if(Math.abs(i)<Proj4js.common.EPSLN)return e}return Proj4js.reportError("cass:pj_inv_mlfn: Convergence error"),e},C00:1,C02:.25,C04:.046875,C06:.01953125,C08:.01068115234375,C22:.75,C44:.46875,C46:.013020833333333334,C48:.007120768229166667,C66:.3645833333333333,C68:.005696614583333333,C88:.3076171875},Proj4js.datum=Proj4js.Class({initialize:function(a){if(this.datum_type=Proj4js.common.PJD_WGS84,a.datumCode&&"none"==a.datumCode&&(this.datum_type=Proj4js.common.PJD_NODATUM),a&&a.datum_params){for(var c=0;c<a.datum_params.length;c++)a.datum_params[c]=parseFloat(a.datum_params[c]);0==a.datum_params[0]&&0==a.datum_params[1]&&0==a.datum_params[2]||(this.datum_type=Proj4js.common.PJD_3PARAM),3<a.datum_params.length&&(0!=a.datum_params[3]||0!=a.datum_params[4]||0!=a.datum_params[5]||0!=a.datum_params[6])&&(this.datum_type=Proj4js.common.PJD_7PARAM,a.datum_params[3]*=Proj4js.common.SEC_TO_RAD,a.datum_params[4]*=Proj4js.common.SEC_TO_RAD,a.datum_params[5]*=Proj4js.common.SEC_TO_RAD,a.datum_params[6]=a.datum_params[6]/1e6+1)}a&&(this.a=a.a,this.b=a.b,this.es=a.es,this.ep2=a.ep2,this.datum_params=a.datum_params)},compare_datums:function(a){return!(this.datum_type!=a.datum_type||this.a!=a.a||5e-11<Math.abs(this.es-a.es))&&(this.datum_type==Proj4js.common.PJD_3PARAM?this.datum_params[0]==a.datum_params[0]&&this.datum_params[1]==a.datum_params[1]&&this.datum_params[2]==a.datum_params[2]:this.datum_type==Proj4js.common.PJD_7PARAM?this.datum_params[0]==a.datum_params[0]&&this.datum_params[1]==a.datum_params[1]&&this.datum_params[2]==a.datum_params[2]&&this.datum_params[3]==a.datum_params[3]&&this.datum_params[4]==a.datum_params[4]&&this.datum_params[5]==a.datum_params[5]&&this.datum_params[6]==a.datum_params[6]:this.datum_type!=Proj4js.common.PJD_GRIDSHIFT&&a.datum_type!=Proj4js.common.PJD_GRIDSHIFT||(alert("ERROR: Grid shift transformations are not implemented."),!1))},geodetic_to_geocentric:function(a){var e,f,g,c=a.x,b=a.y,d=a.z||0;if(b<-Proj4js.common.HALF_PI&&b>-1.001*Proj4js.common.HALF_PI)b=-Proj4js.common.HALF_PI;else if(b>Proj4js.common.HALF_PI&&b<1.001*Proj4js.common.HALF_PI)b=Proj4js.common.HALF_PI;else if(b<-Proj4js.common.HALF_PI||b>Proj4js.common.HALF_PI)return Proj4js.reportError("geocent:lat out of range:"+b),null;return c>Proj4js.common.PI&&(c-=2*Proj4js.common.PI),f=Math.sin(b),g=Math.cos(b),b=((e=this.a/Math.sqrt(1-this.es*f*f))+d)*g*Math.cos(c),c=(e+d)*g*Math.sin(c),d=(e*(1-this.es)+d)*f,a.x=b,a.y=c,a.z=d,0},geocentric_to_geodetic:function(a){var e,f,g,i,h,j,k,l=a.x,d=a.y,m=a.z||0,c=Math.sqrt(l*l+d*d),b=Math.sqrt(l*l+d*d+m*m);if(c/this.a<1e-12){if(l=0,b/this.a<1e-12)return}else l=Math.atan2(d,l);for(d=m/b,e=c/b,f=1/Math.sqrt(1-this.es*(2-this.es)*e*e),i=e*(1-this.es)*f,h=d*f,k=0;k++,b=c*i+m*h-(g=this.a/Math.sqrt(1-this.es*h*h))*(1-this.es*h*h),g=e*(1-(g=this.es*g/(g+b)))*(f=1/Math.sqrt(1-g*(2-g)*e*e)),j=(f*=d)*i-g*h,i=g,h=f,1e-24<j*j&&k<30;);return c=Math.atan(f/Math.abs(g)),a.x=l,a.y=c,a.z=b,a},geocentric_to_geodetic_noniter:function(a){var e,f,g,i,c=a.x,b=a.y,d=a.z||0,c=parseFloat(c),b=parseFloat(b),d=parseFloat(d),h=!1;if(0!=c)e=Math.atan2(b,c);else if(0<b)e=Proj4js.common.HALF_PI;else if(b<0)e=-Proj4js.common.HALF_PI;else if(h=!0,(e=0)<d)f=Proj4js.common.HALF_PI;else{if(!(d<0))return;f=-Proj4js.common.HALF_PI}return g=c*c+b*b,c=Math.sqrt(g),b=d*Proj4js.common.AD_C,g=Math.sqrt(b*b+g),b=d+this.b*this.ep2*(b/=g)*b*b,i=c-this.a*this.es*(g=c/g)*g*g,b/=g=Math.sqrt(b*b+i*i),g=i/g,i=this.a/Math.sqrt(1-this.es*b*b),d=g>=Proj4js.common.COS_67P5?c/g-i:g<=-Proj4js.common.COS_67P5?c/-g-i:d/b+i*(this.es-1),0==h&&(f=Math.atan(b/g)),a.x=e,a.y=f,a.z=d,a},geocentric_to_wgs84:function(a){var b,d,e,f,c;this.datum_type==Proj4js.common.PJD_3PARAM?(a.x+=this.datum_params[0],a.y+=this.datum_params[1],a.z+=this.datum_params[2]):this.datum_type==Proj4js.common.PJD_7PARAM&&(c=this.datum_params[3],b=this.datum_params[4],d=this.datum_params[5],f=(e=this.datum_params[6])*(d*a.x+a.y-c*a.z)+this.datum_params[1],c=e*(-b*a.x+c*a.y+a.z)+this.datum_params[2],a.x=e*(a.x-d*a.y+b*a.z)+this.datum_params[0],a.y=f,a.z=c)},geocentric_from_wgs84:function(a){var c,b,d,f,g,e;this.datum_type==Proj4js.common.PJD_3PARAM?(a.x-=this.datum_params[0],a.y-=this.datum_params[1],a.z-=this.datum_params[2]):this.datum_type==Proj4js.common.PJD_7PARAM&&(c=this.datum_params[3],b=this.datum_params[4],d=this.datum_params[5],e=this.datum_params[6],f=(a.x-this.datum_params[0])/e,g=(a.y-this.datum_params[1])/e,e=(a.z-this.datum_params[2])/e,a.x=f+d*g-b*e,a.y=-d*f+g+c*e,a.z=b*f-c*g+e)}}),Proj4js.Point=Proj4js.Class({initialize:function(a,c,b){"object"==typeof a?(this.x=a[0],this.y=a[1],this.z=a[2]||0):"string"==typeof a&&void 0===c?(a=a.split(","),this.x=parseFloat(a[0]),this.y=parseFloat(a[1]),this.z=parseFloat(a[2])||0):(this.x=a,this.y=c,this.z=b||0)},clone:function(){return new Proj4js.Point(this.x,this.y,this.z)},toString:function(){return"x="+this.x+",y="+this.y},toShortString:function(){return this.x+", "+this.y}}),Proj4js.PrimeMeridian={greenwich:0,lisbon:-9.131906111111,paris:2.337229166667,bogota:-74.080916666667,madrid:-3.687938888889,rome:12.452333333333,bern:7.439583333333,jakarta:106.807719444444,ferro:-17.666666666667,brussels:4.367975,stockholm:18.058277777778,athens:23.7163375,oslo:10.722916666667},Proj4js.Ellipsoid={MERIT:{a:6378137,rf:298.257,ellipseName:"MERIT 1983"},SGS85:{a:6378136,rf:298.257,ellipseName:"Soviet Geodetic System 85"},GRS80:{a:6378137,rf:298.257222101,ellipseName:"GRS 1980(IUGG, 1980)"},IAU76:{a:6378140,rf:298.257,ellipseName:"IAU 1976"},airy:{a:6377563.396,b:6356256.91,ellipseName:"Airy 1830"},"APL4.":{a:6378137,rf:298.25,ellipseName:"Appl. Physics. 1965"},NWL9D:{a:6378145,rf:298.25,ellipseName:"Naval Weapons Lab., 1965"},mod_airy:{a:6377340.189,b:6356034.446,ellipseName:"Modified Airy"},andrae:{a:6377104.43,rf:300,ellipseName:"Andrae 1876 (Den., Iclnd.)"},aust_SA:{a:6378160,rf:298.25,ellipseName:"Australian Natl & S. Amer. 1969"},GRS67:{a:6378160,rf:298.247167427,ellipseName:"GRS 67(IUGG 1967)"},bessel:{a:6377397.155,rf:299.1528128,ellipseName:"Bessel 1841"},bess_nam:{a:6377483.865,rf:299.1528128,ellipseName:"Bessel 1841 (Namibia)"},clrk66:{a:6378206.4,b:6356583.8,ellipseName:"Clarke 1866"},clrk80:{a:6378249.145,rf:293.4663,ellipseName:"Clarke 1880 mod."},CPM:{a:6375738.7,rf:334.29,ellipseName:"Comm. des Poids et Mesures 1799"},delmbr:{a:6376428,rf:311.5,ellipseName:"Delambre 1810 (Belgium)"},engelis:{a:6378136.05,rf:298.2566,ellipseName:"Engelis 1985"},evrst30:{a:6377276.345,rf:300.8017,ellipseName:"Everest 1830"},evrst48:{a:6377304.063,rf:300.8017,ellipseName:"Everest 1948"},evrst56:{a:6377301.243,rf:300.8017,ellipseName:"Everest 1956"},evrst69:{a:6377295.664,rf:300.8017,ellipseName:"Everest 1969"},evrstSS:{a:6377298.556,rf:300.8017,ellipseName:"Everest (Sabah & Sarawak)"},fschr60:{a:6378166,rf:298.3,ellipseName:"Fischer (Mercury Datum) 1960"},fschr60m:{a:6378155,rf:298.3,ellipseName:"Fischer 1960"},fschr68:{a:6378150,rf:298.3,ellipseName:"Fischer 1968"},helmert:{a:6378200,rf:298.3,ellipseName:"Helmert 1906"},hough:{a:6378270,rf:297,ellipseName:"Hough"},intl:{a:6378388,rf:297,ellipseName:"International 1909 (Hayford)"},kaula:{a:6378163,rf:298.24,ellipseName:"Kaula 1961"},lerch:{a:6378139,rf:298.257,ellipseName:"Lerch 1979"},mprts:{a:6397300,rf:191,ellipseName:"Maupertius 1738"},new_intl:{a:6378157.5,b:6356772.2,ellipseName:"New International 1967"},plessis:{a:6376523,rf:6355863,ellipseName:"Plessis 1817 (France)"},krass:{a:6378245,rf:298.3,ellipseName:"Krassovsky, 1942"},SEasia:{a:6378155,b:6356773.3205,ellipseName:"Southeast Asia"},walbeck:{a:6376896,b:6355834.8467,ellipseName:"Walbeck"},WGS60:{a:6378165,rf:298.3,ellipseName:"WGS 60"},WGS66:{a:6378145,rf:298.25,ellipseName:"WGS 66"},WGS72:{a:6378135,rf:298.26,ellipseName:"WGS 72"},WGS84:{a:6378137,rf:298.257223563,ellipseName:"WGS 84"},sphere:{a:6370997,b:6370997,ellipseName:"Normal Sphere (r=6370997)"}},Proj4js.Datum={WGS84:{towgs84:"0,0,0",ellipse:"WGS84",datumName:"WGS84"},GGRS87:{towgs84:"-199.87,74.79,246.62",ellipse:"GRS80",datumName:"Greek_Geodetic_Reference_System_1987"},NAD83:{towgs84:"0,0,0",ellipse:"GRS80",datumName:"North_American_Datum_1983"},NAD27:{nadgrids:"@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat",ellipse:"clrk66",datumName:"North_American_Datum_1927"},potsdam:{towgs84:"606.0,23.0,413.0",ellipse:"bessel",datumName:"Potsdam Rauenberg 1950 DHDN"},carthage:{towgs84:"-263.0,6.0,431.0",ellipse:"clark80",datumName:"Carthage 1934 Tunisia"},hermannskogel:{towgs84:"653.0,-212.0,449.0",ellipse:"bessel",datumName:"Hermannskogel"},ire65:{towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"mod_airy",datumName:"Ireland 1965"},nzgd49:{towgs84:"59.47,-5.04,187.44,0.47,-0.1,1.024,-4.5993",ellipse:"intl",datumName:"New Zealand Geodetic Datum 1949"},OSGB36:{towgs84:"446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894",ellipse:"airy",datumName:"Airy 1830"}},Proj4js.WGS84=new Proj4js.Proj("WGS84"),Proj4js.Datum.OSB36=Proj4js.Datum.OSGB36,Proj4js.wktProjections={"Lambert Tangential Conformal Conic Projection":"lcc",Mercator:"merc","Popular Visualisation Pseudo Mercator":"merc",Mercator_1SP:"merc",Transverse_Mercator:"tmerc","Transverse Mercator":"tmerc","Lambert Azimuthal Equal Area":"laea","Universal Transverse Mercator System":"utm"},Proj4js.Proj.aea={init:function(){Math.abs(this.lat1+this.lat2)<Proj4js.common.EPSLN?Proj4js.reportError("aeaInitEqualLatitudes"):(this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e3=Math.sqrt(this.es),this.sin_po=Math.sin(this.lat1),this.cos_po=Math.cos(this.lat1),this.con=this.t1=this.sin_po,this.ms1=Proj4js.common.msfnz(this.e3,this.sin_po,this.cos_po),this.qs1=Proj4js.common.qsfnz(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat2),this.cos_po=Math.cos(this.lat2),this.t2=this.sin_po,this.ms2=Proj4js.common.msfnz(this.e3,this.sin_po,this.cos_po),this.qs2=Proj4js.common.qsfnz(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat0),this.cos_po=Math.cos(this.lat0),this.t3=this.sin_po,this.qs0=Proj4js.common.qsfnz(this.e3,this.sin_po,this.cos_po),this.ns0=Math.abs(this.lat1-this.lat2)>Proj4js.common.EPSLN?(this.ms1*this.ms1-this.ms2*this.ms2)/(this.qs2-this.qs1):this.con,this.c=this.ms1*this.ms1+this.ns0*this.qs1,this.rh=this.a*Math.sqrt(this.c-this.ns0*this.qs0)/this.ns0)},forward:function(a){var c=a.x,b=a.y,b=(this.sin_phi=Math.sin(b),this.cos_phi=Math.cos(b),Proj4js.common.qsfnz(this.e3,this.sin_phi,this.cos_phi)),b=this.a*Math.sqrt(this.c-this.ns0*b)/this.ns0,d=this.ns0*Proj4js.common.adjust_lon(c-this.long0),c=b*Math.sin(d)+this.x0,b=this.rh-b*Math.cos(d)+this.y0;return a.x=c,a.y=b,a},inverse:function(a){var c,b,d;return a.x-=this.x0,a.y=this.rh-a.y+this.y0,b=0<=this.ns0?(c=Math.sqrt(a.x*a.x+a.y*a.y),1):(c=-Math.sqrt(a.x*a.x+a.y*a.y),-1),(d=0)!=c&&(d=Math.atan2(b*a.x,b*a.y)),b=c*this.ns0/this.a,c=(this.c-b*b)/this.ns0,b=!(1e-10<=this.e3)||(b=1-.5*(1-this.es)*Math.log((1-this.e3)/(1+this.e3))/this.e3,1e-10<Math.abs(Math.abs(b)-Math.abs(c)))?this.phi1z(this.e3,c):0<=c?.5*Proj4js.common.PI:-.5*Proj4js.common.PI,d=Proj4js.common.adjust_lon(d/this.ns0+this.long0),a.x=d,a.y=b,a},phi1z:function(a,c){var b,e,f,g=Proj4js.common.asinz(.5*c);if(a<Proj4js.common.EPSLN)return g;for(var i=a*a,h=1;h<=25;h++)if(g+=b=.5*(f=1-(e=a*(b=Math.sin(g)))*e)*f/Math.cos(g)*(c/(1-i)-b/f+.5/a*Math.log((1-e)/(1+e))),Math.abs(b)<=1e-7)return g;return Proj4js.reportError("aea:phi1z:Convergence error"),null}},Proj4js.Proj.sterea={dependsOn:"gauss",init:function(){Proj4js.Proj.gauss.init.apply(this),this.rc?(this.sinc0=Math.sin(this.phic0),this.cosc0=Math.cos(this.phic0),this.R2=2*this.rc,this.title||(this.title="Oblique Stereographic Alternative")):Proj4js.reportError("sterea:init:E_ERROR_0")},forward:function(a){var c,b,d,e;return a.x=Proj4js.common.adjust_lon(a.x-this.long0),Proj4js.Proj.gauss.forward.apply(this,[a]),c=Math.sin(a.y),b=Math.cos(a.y),d=Math.cos(a.x),e=this.k0*this.R2/(1+this.sinc0*c+this.cosc0*b*d),a.x=e*b*Math.sin(a.x),a.y=e*(this.cosc0*c-this.sinc0*b*d),a.x=this.a*a.x+this.x0,a.y=this.a*a.y+this.y0,a},inverse:function(a){var c,b,d,e;return a.x=(a.x-this.x0)/this.a,a.y=(a.y-this.y0)/this.a,a.x/=this.k0,a.y/=this.k0,c=(e=Math.sqrt(a.x*a.x+a.y*a.y))?(d=2*Math.atan2(e,this.R2),c=Math.sin(d),b=Math.cos(d),d=Math.asin(b*this.sinc0+a.y*c*this.cosc0/e),Math.atan2(a.x*c,e*this.cosc0*b-a.y*this.sinc0*c)):(d=this.phic0,0),a.x=c,a.y=d,Proj4js.Proj.gauss.inverse.apply(this,[a]),a.x=Proj4js.common.adjust_lon(a.x+this.long0),a}},Proj4js.Proj.poly={init:function(){0==this.lat0&&(this.lat0=90),this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Proj4js.common.e0fn(this.es),this.e1=Proj4js.common.e1fn(this.es),this.e2=Proj4js.common.e2fn(this.es),this.e3=Proj4js.common.e3fn(this.es),this.ml0=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat0)},forward:function(a){var e,f,d=a.y,b=Proj4js.common.adjust_lon(a.x-this.long0),c=Math.abs(d)<=1e-7?(f=this.x0+this.a*b,this.y0-this.a*this.ml0):(c=Math.sin(d),b=Math.cos(d),d=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,d),e=Proj4js.common.msfnz(this.e,c,b),b=c,f=this.x0+this.a*e*Math.sin(b)/c,this.y0+this.a*(d-this.ml0+e*(1-Math.cos(b))/c));return a.x=f,a.y=c,a},inverse:function(a){var c,b;if(a.x-=this.x0,a.y-=this.y0,c=this.ml0+a.y/this.a,Math.abs(c)<=1e-7)c=a.x/this.a+this.long0,b=0;else{if(c=c*c+a.x/this.a*(a.x/this.a),1!=(c=phi4z(this.es,this.e0,this.e1,this.e2,this.e3,this.al,c,void 0,b)))return c;c=Proj4js.common.adjust_lon(Proj4js.common.asinz(NaN*a.x/this.a)/Math.sin(b)+this.long0)}return a.x=c,a.y=b,a}},Proj4js.Proj.equi={init:function(){this.x0||(this.x0=0),this.y0||(this.y0=0),this.lat0||(this.lat0=0),this.long0||(this.long0=0)},forward:function(a){var c=a.y,b=this.x0+this.a*Proj4js.common.adjust_lon(a.x-this.long0)*Math.cos(this.lat0),c=this.y0+this.a*c;return this.t1=b,this.t2=Math.cos(this.lat0),a.x=b,a.y=c,a},inverse:function(a){a.x-=this.x0,a.y-=this.y0;var c=a.y/this.a,b=(Math.abs(c)>Proj4js.common.HALF_PI&&Proj4js.reportError("equi:Inv:DataError"),Proj4js.common.adjust_lon(this.long0+a.x/(this.a*Math.cos(this.lat0))));a.x=b,a.y=c}},Proj4js.Proj.merc={init:function(){this.lat_ts&&(this.k0=this.sphere?Math.cos(this.lat_ts):Proj4js.common.msfnz(this.es,Math.sin(this.lat_ts),Math.cos(this.lat_ts)))},forward:function(a){var d,c=a.x,b=a.y;return 90<b*Proj4js.common.R2D&&b*Proj4js.common.R2D<-90&&180<c*Proj4js.common.R2D&&c*Proj4js.common.R2D<-180?(Proj4js.reportError("merc:forward: llInputOutOfRange: "+c+" : "+b),null):Math.abs(Math.abs(b)-Proj4js.common.HALF_PI)<=Proj4js.common.EPSLN?(Proj4js.reportError("merc:forward: ll2mAtPoles"),null):(b=this.sphere?(c=this.x0+this.a*this.k0*Proj4js.common.adjust_lon(c-this.long0),this.y0+this.a*this.k0*Math.log(Math.tan(Proj4js.common.FORTPI+.5*b))):(d=Math.sin(b),b=Proj4js.common.tsfnz(this.e,b,d),c=this.x0+this.a*this.k0*Proj4js.common.adjust_lon(c-this.long0),this.y0-this.a*this.k0*Math.log(b)),a.x=c,a.y=b,a)},inverse:function(a){var c=a.x-this.x0,b=a.y-this.y0;if(this.sphere)b=Proj4js.common.HALF_PI-2*Math.atan(Math.exp(-b/this.a*this.k0));else if(b=Math.exp(-b/(this.a*this.k0)),-9999==(b=Proj4js.common.phi2z(this.e,b)))return Proj4js.reportError("merc:inverse: lat = -9999"),null;return c=Proj4js.common.adjust_lon(this.long0+c/(this.a*this.k0)),a.x=c,a.y=b,a}},Proj4js.Proj.utm={dependsOn:"tmerc",init:function(){this.zone?(this.lat0=0,this.long0=(6*Math.abs(this.zone)-183)*Proj4js.common.D2R,this.x0=5e5,this.y0=this.utmSouth?1e7:0,this.k0=.9996,Proj4js.Proj.tmerc.init.apply(this),this.forward=Proj4js.Proj.tmerc.forward,this.inverse=Proj4js.Proj.tmerc.inverse):Proj4js.reportError("utm:init: zone must be specified for UTM")}},Proj4js.Proj.eqdc={init:function(){this.mode||(this.mode=0),this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Proj4js.common.e0fn(this.es),this.e1=Proj4js.common.e1fn(this.es),this.e2=Proj4js.common.e2fn(this.es),this.e3=Proj4js.common.e3fn(this.es),this.sinphi=Math.sin(this.lat1),this.cosphi=Math.cos(this.lat1),this.ms1=Proj4js.common.msfnz(this.e,this.sinphi,this.cosphi),this.ml1=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat1),0!=this.mode?(Math.abs(this.lat1+this.lat2)<Proj4js.common.EPSLN&&Proj4js.reportError("eqdc:Init:EqualLatitudes"),this.sinphi=Math.sin(this.lat2),this.cosphi=Math.cos(this.lat2),this.ms2=Proj4js.common.msfnz(this.e,this.sinphi,this.cosphi),this.ml2=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat2),this.ns=Math.abs(this.lat1-this.lat2)>=Proj4js.common.EPSLN?(this.ms1-this.ms2)/(this.ml2-this.ml1):this.sinphi):this.ns=this.sinphi,this.g=this.ml1+this.ms1/this.ns,this.ml0=Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat0),this.rh=this.a*(this.g-this.ml0)},forward:function(a){var c=a.x,b=this.a*(this.g-Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,a.y)),d=this.ns*Proj4js.common.adjust_lon(c-this.long0),c=this.x0+b*Math.sin(d),b=this.y0+this.rh-b*Math.cos(d);return a.x=c,a.y=b,a},inverse:function(a){a.x-=this.x0,a.y=this.rh-a.y+this.y0,c=0<=this.ns?(b=Math.sqrt(a.x*a.x+a.y*a.y),1):(b=-Math.sqrt(a.x*a.x+a.y*a.y),-1);var c,b,d=0;return 0!=b&&(d=Math.atan2(c*a.x,c*a.y)),c=this.phi3z(this.g-b/this.a,this.e0,this.e1,this.e2,this.e3),d=Proj4js.common.adjust_lon(this.long0+d/this.ns),a.x=d,a.y=c,a},phi3z:function(a,c,b,d,e){for(var g,f=a,i=0;i<15;i++)if(f+=g=(a+b*Math.sin(2*f)-d*Math.sin(4*f)+e*Math.sin(6*f))/c-f,Math.abs(g)<=1e-10)return f;return Proj4js.reportError("PHI3Z-CONV:Latitude failed to converge after 15 iterations"),null}},Proj4js.Proj.tmerc={init:function(){this.e0=Proj4js.common.e0fn(this.es),this.e1=Proj4js.common.e1fn(this.es),this.e2=Proj4js.common.e2fn(this.es),this.e3=Proj4js.common.e3fn(this.es),this.ml0=this.a*Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,this.lat0)},forward:function(a){var c=a.y,b=Proj4js.common.adjust_lon(a.x-this.long0),f=(d=Math.sin(c),Math.cos(c));if(this.sphere){var g=f*Math.sin(b);if(Math.abs(Math.abs(g)-1)<1e-10)return Proj4js.reportError("tmerc:forward: Point projects into infinity"),93;e=.5*this.a*this.k0*Math.log((1+g)/(1-g)),d=Math.acos(f*Math.cos(b)/Math.sqrt(1-g*g)),c=this.a*this.k0*((d=c<0?-d:d)-this.lat0)}else{var e=f*b,b=Math.pow(e,2),f=this.ep2*Math.pow(f,2),g=Math.tan(c),i=Math.pow(g,2),d=1-this.es*Math.pow(d,2);d=this.a/Math.sqrt(d),c=this.a*Proj4js.common.mlfn(this.e0,this.e1,this.e2,this.e3,c),e=this.k0*d*e*(1+b/6*(1-i+f+b/20*(5-18*i+Math.pow(i,2)+72*f-58*this.ep2)))+this.x0,c=this.k0*(c-this.ml0+d*g*b*(.5+b/24*(5-i+9*f+4*Math.pow(f,2)+b/30*(61-58*i+Math.pow(i,2)+600*f-330*this.ep2))))+this.y0}return a.x=e,a.y=c,a},inverse:function(a){if(this.sphere){var b,f=.5*((b=Math.exp(a.x/(this.a*this.k0)))-1/b),d=this.lat0+a.y/(this.a*this.k0),e=Math.cos(d),c=Math.sqrt((1-e*e)/(1+f*f));b=Proj4js.common.asinz(c),d<0&&(b=-b),c=0==f&&0==e?this.long0:Proj4js.common.adjust_lon(Math.atan2(f,e)+this.long0)}else{var i,h,j,k,f=a.x-this.x0,g=a.y-this.y0;for(b=c=(this.ml0+g/this.k0)/this.a,e=0;b+=d=(c+this.e1*Math.sin(2*b)-this.e2*Math.sin(4*b)+this.e3*Math.sin(6*b))/this.e0-b,!(Math.abs(d)<=Proj4js.common.EPSLN);e++)if(6<=e)return Proj4js.reportError("tmerc:inverse: Latitude failed to converge"),95;c=Math.abs(b)<Proj4js.common.HALF_PI?(c=Math.sin(b),d=Math.cos(b),i=Math.tan(b),e=this.ep2*Math.pow(d,2),g=Math.pow(e,2),h=Math.pow(i,2),j=Math.pow(h,2),c=1-this.es*Math.pow(c,2),c=(k=this.a/Math.sqrt(c))*(1-this.es)/c,f/=k*this.k0,b-=k*i*(k=Math.pow(f,2))/c*(.5-k/24*(5+3*h+10*e-4*g-9*this.ep2-k/30*(61+90*h+298*e+45*j-252*this.ep2-3*g))),Proj4js.common.adjust_lon(this.long0+f*(1-k/6*(1+2*h+e-k/20*(5-2*e+28*h-3*g+8*this.ep2+24*j)))/d)):(b=Proj4js.common.HALF_PI*Proj4js.common.sign(g),this.long0)}return a.x=c,a.y=b,a}},Proj4js.defs.GOOGLE="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs",Proj4js.defs["EPSG:900913"]=Proj4js.defs.GOOGLE,Proj4js.Proj.gstmerc={init:function(){var a=this.b/this.a,a=(this.e=Math.sqrt(1-a*a),this.lc=this.long0,this.rs=Math.sqrt(1+this.e*this.e*Math.pow(Math.cos(this.lat0),4)/(1-this.e*this.e)),Math.sin(this.lat0)),c=Math.asin(a/this.rs),b=Math.sin(c);this.cp=Proj4js.common.latiso(0,c,b)-this.rs*Proj4js.common.latiso(this.e,this.lat0,a),this.n2=this.k0*this.a*Math.sqrt(1-this.e*this.e)/(1-this.e*this.e*a*a),this.xs=this.x0,this.ys=this.y0-this.n2*c,this.title||(this.title="Gauss Schreiber transverse mercator")},forward:function(a){var c=a.y,b=this.rs*(a.x-this.lc),c=this.cp+this.rs*Proj4js.common.latiso(this.e,c,Math.sin(c)),d=Math.asin(Math.sin(b)/Proj4js.common.cosh(c)),d=Proj4js.common.latiso(0,d,Math.sin(d));return a.x=this.xs+this.n2*d,a.y=this.ys+this.n2*Math.atan(Proj4js.common.sinh(c)/Math.cos(b)),a},inverse:function(a){var c=a.x,b=a.y,d=Math.atan(Proj4js.common.sinh((c-this.xs)/this.n2)/Math.cos((b-this.ys)/this.n2)),c=Math.asin(Math.sin((b-this.ys)/this.n2)/Proj4js.common.cosh((c-this.xs)/this.n2)),c=Proj4js.common.latiso(0,c,Math.sin(c));return a.x=this.lc+d/this.rs,a.y=Proj4js.common.invlatiso(this.e,(c-this.cp)/this.rs),a}},Proj4js.Proj.ortho={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0)},forward:function(a){var e,f,g,i,b=a.y,d=Proj4js.common.adjust_lon(a.x-this.long0),c=Math.sin(b);return b=Math.cos(b),e=Math.cos(d),0<(f=this.sin_p14*c+this.cos_p14*b*e)||Math.abs(f)<=Proj4js.common.EPSLN?(g=+this.a*b*Math.sin(d),i=this.y0+ +this.a*(this.cos_p14*c-this.sin_p14*b*e)):Proj4js.reportError("orthoFwdPointError"),a.x=g,a.y=i,a},inverse:function(a){var c,b,d,e;return a.x-=this.x0,a.y-=this.y0,(c=Math.sqrt(a.x*a.x+a.y*a.y))>this.a+1e-7&&Proj4js.reportError("orthoInvDataError"),b=Proj4js.common.asinz(c/this.a),d=Math.sin(b),e=Math.cos(b),b=this.long0,Math.abs(c),d=Proj4js.common.asinz(e*this.sin_p14+a.y*d*this.cos_p14/c),c=Math.abs(this.lat0)-Proj4js.common.HALF_PI,Math.abs(c)<=Proj4js.common.EPSLN&&(b=0<=this.lat0?Proj4js.common.adjust_lon(this.long0+Math.atan2(a.x,-a.y)):Proj4js.common.adjust_lon(this.long0-Math.atan2(-a.x,a.y))),Math.sin(d),a.x=b,a.y=d,a}},Proj4js.Proj.krovak={init:function(){this.a=6377397.155,this.es=.006674372230614,this.e=Math.sqrt(this.es),this.lat0||(this.lat0=.863937979737193),this.long0||(this.long0=.4334234309119251),this.k0||(this.k0=.9999),this.s45=.785398163397448,this.s90=2*this.s45,this.fi0=this.lat0,this.e2=this.es,this.e=Math.sqrt(this.e2),this.alfa=Math.sqrt(1+this.e2*Math.pow(Math.cos(this.fi0),4)/(1-this.e2)),this.uq=1.04216856380474,this.u0=Math.asin(Math.sin(this.fi0)/this.alfa),this.g=Math.pow((1+this.e*Math.sin(this.fi0))/(1-this.e*Math.sin(this.fi0)),this.alfa*this.e/2),this.k=Math.tan(this.u0/2+this.s45)/Math.pow(Math.tan(this.fi0/2+this.s45),this.alfa)*this.g,this.k1=this.k0,this.n0=this.a*Math.sqrt(1-this.e2)/(1-this.e2*Math.pow(Math.sin(this.fi0),2)),this.s0=1.37008346281555,this.n=Math.sin(this.s0),this.ro0=this.k1*this.n0/Math.tan(this.s0),this.ad=this.s90-this.uq},forward:function(a){var b=a.y,d=Proj4js.common.adjust_lon(a.x-this.long0),c=Math.pow((1+this.e*Math.sin(b))/(1-this.e*Math.sin(b)),this.alfa*this.e/2);return c=2*(Math.atan(this.k*Math.pow(Math.tan(b/2+this.s45),this.alfa)/c)-this.s45),b=-d*this.alfa,d=Math.asin(Math.cos(this.ad)*Math.sin(c)+Math.sin(this.ad)*Math.cos(c)*Math.cos(b)),c=this.n*Math.asin(Math.cos(c)*Math.sin(b)/Math.cos(d)),d=this.ro0*Math.pow(Math.tan(this.s0/2+this.s45),this.n)/Math.pow(Math.tan(d/2+this.s45),this.n),a.y=d*Math.cos(c),a.x=d*Math.sin(c),this.czech&&(a.y*=-1,a.x*=-1),a},inverse:function(a){var d,c=a.x;a.x=a.y,a.y=c,this.czech&&(a.y*=-1,a.x*=-1),c=Math.sqrt(a.x*a.x+a.y*a.y),b=Math.atan2(a.y,a.x)/Math.sin(this.s0),d=2*(Math.atan(Math.pow(this.ro0/c,1/this.n)*Math.tan(this.s0/2+this.s45))-this.s45),c=Math.asin(Math.cos(this.ad)*Math.sin(d)-Math.sin(this.ad)*Math.cos(d)*Math.cos(b)),b=Math.asin(Math.cos(d)*Math.sin(b)/Math.cos(c)),a.x=this.long0-b/this.alfa;for(var b=c,e=d=0;a.y=2*(Math.atan(Math.pow(this.k,-1/this.alfa)*Math.pow(Math.tan(c/2+this.s45),1/this.alfa)*Math.pow((1+this.e*Math.sin(b))/(1-this.e*Math.sin(b)),this.e/2))-this.s45),Math.abs(b-a.y)<1e-10&&(d=1),b=a.y,e+=1,0==d&&e<15;);return 15<=e?(Proj4js.reportError("PHI3Z-CONV:Latitude failed to converge after 15 iterations"),null):a}},Proj4js.Proj.somerc={init:function(){var a=this.lat0,c=(this.lambda0=this.long0,Math.sin(a)),b=this.a,d=2*(d=1/this.rf)-Math.pow(d,2),e=this.e=Math.sqrt(d);this.R=this.k0*b*Math.sqrt(1-d)/(1-d*Math.pow(c,2)),this.alpha=Math.sqrt(1+d/(1-d)*Math.pow(Math.cos(a),4)),this.b0=Math.asin(c/this.alpha),this.K=Math.log(Math.tan(Math.PI/4+this.b0/2))-this.alpha*Math.log(Math.tan(Math.PI/4+a/2))+this.alpha*e/2*Math.log((1+e*c)/(1-e*c))},forward:function(a){var c=Math.log(Math.tan(Math.PI/4-a.y/2)),b=this.e/2*Math.log((1+this.e*Math.sin(a.y))/(1-this.e*Math.sin(a.y))),b=2*(Math.atan(Math.exp(-this.alpha*(c+b)+this.K))-Math.PI/4),d=this.alpha*(a.x-this.lambda0),c=Math.atan(Math.sin(d)/(Math.sin(this.b0)*Math.tan(b)+Math.cos(this.b0)*Math.cos(d))),b=Math.asin(Math.cos(this.b0)*Math.sin(b)-Math.sin(this.b0)*Math.cos(b)*Math.cos(d));return a.y=this.R/2*Math.log((1+Math.sin(b))/(1-Math.sin(b)))+this.y0,a.x=this.R*c+this.x0,a},inverse:function(a){for(var c=(a.x-this.x0)/this.R,b=2*(Math.atan(Math.exp((a.y-this.y0)/this.R))-Math.PI/4),d=Math.asin(Math.cos(this.b0)*Math.sin(b)+Math.sin(this.b0)*Math.cos(b)*Math.cos(c)),c=this.lambda0+Math.atan(Math.sin(c)/(Math.cos(this.b0)*Math.cos(c)-Math.sin(this.b0)*Math.tan(b)))/this.alpha,e=d,f=-1e3,g=0;1e-7<Math.abs(e-f);){if(20<++g)return void Proj4js.reportError("omercFwdInfinity");b=1/this.alpha*(Math.log(Math.tan(Math.PI/4+d/2))-this.K)+this.e*Math.log(Math.tan(Math.PI/4+Math.asin(this.e*Math.sin(e))/2)),f=e,e=2*Math.atan(Math.exp(b))-Math.PI/2}return a.x=c,a.y=e,a}},Proj4js.Proj.stere={ssfn_:function(a,c,b){return c*=b,Math.tan(.5*(Proj4js.common.HALF_PI+a))*Math.pow((1-c)/(1+c),.5*b)},TOL:1e-8,NITER:8,CONV:1e-10,S_POLE:0,N_POLE:1,OBLIQ:2,EQUIT:3,init:function(){this.phits=this.lat_ts||Proj4js.common.HALF_PI;var c,a=Math.abs(this.lat0);if(this.mode=Math.abs(a)-Proj4js.common.HALF_PI<Proj4js.common.EPSLN?this.lat0<0?this.S_POLE:this.N_POLE:a>Proj4js.common.EPSLN?this.OBLIQ:this.EQUIT,this.phits=Math.abs(this.phits),this.es)switch(this.mode){case this.N_POLE:case this.S_POLE:Math.abs(this.phits-Proj4js.common.HALF_PI)<Proj4js.common.EPSLN?this.akm1=2*this.k0/Math.sqrt(Math.pow(1+this.e,1+this.e)*Math.pow(1-this.e,1-this.e)):(a=Math.sin(this.phits),this.akm1=Math.cos(this.phits)/Proj4js.common.tsfnz(this.e,this.phits,a),a*=this.e,this.akm1/=Math.sqrt(1-a*a));break;case this.EQUIT:this.akm1=2*this.k0;break;case this.OBLIQ:a=Math.sin(this.lat0),c=2*Math.atan(this.ssfn_(this.lat0,a,this.e))-Proj4js.common.HALF_PI,a*=this.e,this.akm1=2*this.k0*Math.cos(this.lat0)/Math.sqrt(1-a*a),this.sinX1=Math.sin(c),this.cosX1=Math.cos(c)}else switch(this.mode){case this.OBLIQ:this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0);case this.EQUIT:this.akm1=2*this.k0;break;case this.S_POLE:case this.N_POLE:this.akm1=Math.abs(this.phits-Proj4js.common.HALF_PI)>=Proj4js.common.EPSLN?Math.cos(this.phits)/Math.tan(Proj4js.common.FORTPI-.5*this.phits):2*this.k0}},forward:function(a){var d,e,h,c=a.x,c=Proj4js.common.adjust_lon(c-this.long0),b=a.y;if(this.sphere){var f=Math.sin(b),g=Math.cos(b),i=Math.cos(c);switch(c=Math.sin(c),this.mode){case this.EQUIT:(e=1+g*i)<=Proj4js.common.EPSLN&&Proj4js.reportError("stere:forward:Equit"),d=(e=this.akm1/e)*g*c,e*=f;break;case this.OBLIQ:(e=1+this.sinph0*f+this.cosph0*g*i)<=Proj4js.common.EPSLN&&Proj4js.reportError("stere:forward:Obliq"),d=(e=this.akm1/e)*g*c,e*=this.cosph0*f-this.sinph0*g*i;break;case this.N_POLE:i=-i,b=-b;case this.S_POLE:Math.abs(b-Proj4js.common.HALF_PI)<this.TOL&&Proj4js.reportError("stere:forward:S_POLE"),d=c*(e=this.akm1*Math.tan(Proj4js.common.FORTPI+.5*b)),e*=i}}else{switch(i=Math.cos(c),c=Math.sin(c),f=Math.sin(b),this.mode!=this.OBLIQ&&this.mode!=this.EQUIT||(h=2*Math.atan(this.ssfn_(b,f,this.e)),g=Math.sin(h-Proj4js.common.HALF_PI),h=Math.cos(h)),this.mode){case this.OBLIQ:e=(b=this.akm1/(this.cosX1*(1+this.sinX1*g+this.cosX1*h*i)))*(this.cosX1*g-this.sinX1*h*i),d=b*h;break;case this.EQUIT:e=(b=2*this.akm1/(1+h*i))*g,d=b*h;break;case this.S_POLE:b=-b,i=-i,f=-f;case this.N_POLE:e=-(d=this.akm1*Proj4js.common.tsfnz(this.e,b,f))*i}d*=c}return a.x=d*this.a+this.x0,a.y=e*this.a+this.y0,a},inverse:function(a){var d,e,f,i,c=(a.x-this.x0)/this.a,b=(a.y-this.y0)/this.a,g=d=0,h=f=0;if(this.sphere){switch(g=Math.sqrt(c*c+b*b),h=2*Math.atan(g/this.akm1),f=Math.sin(h),h=Math.cos(h),d=0,this.mode){case this.EQUIT:e=Math.abs(g)<=Proj4js.common.EPSLN?0:Math.asin(b*f/g),0==h&&0==c||(d=Math.atan2(c*f,h*g));break;case this.OBLIQ:e=Math.abs(g)<=Proj4js.common.EPSLN?this.phi0:Math.asin(h*this.sinph0+b*f*this.cosph0/g),0==(h-=this.sinph0*Math.sin(e))&&0==c||(d=Math.atan2(c*f*this.cosph0,h*g));break;case this.N_POLE:b=-b;case this.S_POLE:e=Math.abs(g)<=Proj4js.common.EPSLN?this.phi0:Math.asin(this.mode==this.S_POLE?-h:h),d=0==c&&0==b?0:Math.atan2(c,b)}a.x=Proj4js.common.adjust_lon(d+this.long0),a.y=e}else{switch(i=Math.sqrt(c*c+b*b),this.mode){case this.OBLIQ:case this.EQUIT:d=2*Math.atan2(i*this.cosX1,this.akm1),f=Math.cos(d),e=Math.sin(d),g=0==i?Math.asin(f*this.sinX1):Math.asin(f*this.sinX1+b*e*this.cosX1/i),d=Math.tan(.5*(Proj4js.common.HALF_PI+g)),c*=e,b=i*this.cosX1*f-b*this.sinX1*e,h=Proj4js.common.HALF_PI,f=.5*this.e;break;case this.N_POLE:b=-b;case this.S_POLE:d=-i/this.akm1,g=Proj4js.common.HALF_PI-2*Math.atan(d),h=-Proj4js.common.HALF_PI,f=-.5*this.e}for(i=this.NITER;i--;g=e)if(e=this.e*Math.sin(g),e=2*Math.atan(d*Math.pow((1+e)/(1-e),f))-h,Math.abs(g-e)<this.CONV)return this.mode==this.S_POLE&&(e=-e),d=0==c&&0==b?0:Math.atan2(c,b),a.x=Proj4js.common.adjust_lon(d+this.long0),a.y=e,a}}},Proj4js.Proj.nzmg={iterations:1,init:function(){this.A=[],this.A[1]=.6399175073,this.A[2]=-.1358797613,this.A[3]=.063294409,this.A[4]=-.02526853,this.A[5]=.0117879,this.A[6]=-.0055161,this.A[7]=.0026906,this.A[8]=-.001333,this.A[9]=67e-5,this.A[10]=-34e-5,this.B_re=[],this.B_im=[],this.B_re[1]=.7557853228,this.B_im[1]=0,this.B_re[2]=.249204646,this.B_im[2]=.003371507,this.B_re[3]=-.001541739,this.B_im[3]=.04105856,this.B_re[4]=-.10162907,this.B_im[4]=.01727609,this.B_re[5]=-.26623489,this.B_im[5]=-.36249218,this.B_re[6]=-.6870983,this.B_im[6]=-1.1651967,this.C_re=[],this.C_im=[],this.C_re[1]=1.3231270439,this.C_im[1]=0,this.C_re[2]=-.577245789,this.C_im[2]=-.007809598,this.C_re[3]=.508307513,this.C_im[3]=-.112208952,this.C_re[4]=-.15094762,this.C_im[4]=.18200602,this.C_re[5]=1.01418179,this.C_im[5]=1.64497696,this.C_re[6]=1.9660549,this.C_im[6]=2.5127645,this.D=[],this.D[1]=1.5627014243,this.D[2]=.5185406398,this.D[3]=-.03333098,this.D[4]=-.1052906,this.D[5]=-.0368594,this.D[6]=.007317,this.D[7]=.0122,this.D[8]=.00394,this.D[9]=-.0013},forward:function(a){for(var c=(a.y-this.lat0)/Proj4js.common.SEC_TO_RAD*1e-5,b=a.x-this.long0,d=1,e=0,f=1;f<=10;f++)e+=this.A[f]*(d*=c);for(var c=e,d=1,g=0,i=0,h=0,f=1;f<=6;f++)e=d*c-g*b,g=g*c+d*b,d=e,i=i+this.B_re[f]*d-this.B_im[f]*g,h=h+this.B_im[f]*d+this.B_re[f]*g;return a.x=h*this.a+this.x0,a.y=i*this.a+this.y0,a},inverse:function(a){for(var c=(a.y-this.y0)/this.a,b=(a.x-this.x0)/this.a,d=1,e=0,g=0,i=0,h=1;h<=6;h++)f=d*c-e*b,e=e*c+d*b,d=f,g=g+this.C_re[h]*d-this.C_im[h]*e,i=i+this.C_im[h]*d+this.C_re[h]*e;for(d=0;d<this.iterations;d++){var l,j=g,k=i,f=c,e=b;for(h=2;h<=6;h++)l=j*g-k*i,k=k*g+j*i,j=l,f+=(h-1)*(this.B_re[h]*j-this.B_im[h]*k),e+=(h-1)*(this.B_im[h]*j+this.B_re[h]*k);for(var j=1,k=0,m=this.B_re[1],n=this.B_im[1],h=2;h<=6;h++)l=j*g-k*i,k=k*g+j*i,j=l,m+=h*(this.B_re[h]*j-this.B_im[h]*k),n+=h*(this.B_im[h]*j+this.B_re[h]*k);g=(f*m+e*n)/(i=m*m+n*n),i=(e*m-f*n)/i}for(c=g,g=0,h=b=1;h<=9;h++)g+=this.D[h]*(b*=c);return h=this.lat0+1e5*g*Proj4js.common.SEC_TO_RAD,a.x=this.long0+i,a.y=h,a}},Proj4js.Proj.mill={init:function(){},forward:function(a){var c=a.y,b=this.x0+this.a*Proj4js.common.adjust_lon(a.x-this.long0),c=this.y0+1.25*this.a*Math.log(Math.tan(Proj4js.common.PI/4+c/2.5));return a.x=b,a.y=c,a},inverse:function(a){a.x-=this.x0,a.y-=this.y0;var c=Proj4js.common.adjust_lon(this.long0+a.x/this.a),b=2.5*(Math.atan(Math.exp(.8*a.y/this.a))-Proj4js.common.PI/4);return a.x=c,a.y=b,a}},Proj4js.Proj.gnom={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0),this.infinity_dist=1e3*this.a,this.rc=1},forward:function(a){var e,f,b=a.y,d=Proj4js.common.adjust_lon(a.x-this.long0),c=Math.sin(b);return b=Math.cos(b),e=Math.cos(d),c=0<(f=this.sin_p14*c+this.cos_p14*b*e)||Math.abs(f)<=Proj4js.common.EPSLN?(d=this.x0+ +this.a*b*Math.sin(d)/f,this.y0+ +this.a*(this.cos_p14*c-this.sin_p14*b*e)/f):(Proj4js.reportError("orthoFwdPointError"),d=this.x0+this.infinity_dist*b*Math.sin(d),this.y0+this.infinity_dist*(this.cos_p14*c-this.sin_p14*b*e)),a.x=d,a.y=c,a},inverse:function(a){var c,b,d,e;return a.x=(a.x-this.x0)/this.a,a.y=(a.y-this.y0)/this.a,a.x/=this.k0,a.y/=this.k0,c=(c=Math.sqrt(a.x*a.x+a.y*a.y))?(e=Math.atan2(c,this.rc),b=Math.sin(e),d=Math.cos(e),e=Proj4js.common.asinz(d*this.sin_p14+a.y*b*this.cos_p14/c),c=Math.atan2(a.x*b,c*this.cos_p14*d-a.y*this.sin_p14*b),Proj4js.common.adjust_lon(this.long0+c)):(e=this.phic0,0),a.x=c,a.y=e,a}},Proj4js.Proj.sinu={init:function(){this.sphere?(this.n=1,this.es=this.m=0,this.C_y=Math.sqrt((this.m+1)/this.n),this.C_x=this.C_y/(this.m+1)):this.en=Proj4js.common.pj_enfn(this.es)},forward:function(a){var c=a.x,b=a.y;if(c=Proj4js.common.adjust_lon(c-this.long0),this.sphere){if(this.m)for(var d=this.n*Math.sin(b),e=Proj4js.common.MAX_ITER;e;--e){var f=(this.m*b+Math.sin(b)-d)/(this.m+Math.cos(b));if(b-=f,Math.abs(f)<Proj4js.common.EPSLN)break}else b=1!=this.n?Math.asin(this.n*Math.sin(b)):b;c=this.a*this.C_x*c*(this.m+Math.cos(b)),b*=this.a*this.C_y}else d=Math.sin(b),e=Math.cos(b),b=this.a*Proj4js.common.pj_mlfn(b,d,e,this.en),c=this.a*c*e/Math.sqrt(1-this.es*d*d);return a.x=c,a.y=b,a},inverse:function(a){var b,c,d;return a.x-=this.x0,a.y-=this.y0,this.sphere?(a.y/=this.C_y,c=this.m?Math.asin((this.m*a.y+Math.sin(a.y))/this.n):1!=this.n?Math.asin(Math.sin(a.y)/this.n):a.y,b=a.x/(this.C_x*(this.m+Math.cos(a.y)))):(c=Proj4js.common.pj_inv_mlfn(a.y/this.a,this.es,this.en),(d=Math.abs(c))<Proj4js.common.HALF_PI?(d=Math.sin(c),b=this.long0+a.x*Math.sqrt(1-this.es*d*d)/(this.a*Math.cos(c)),b=Proj4js.common.adjust_lon(b)):d-Proj4js.common.EPSLN<Proj4js.common.HALF_PI&&(b=this.long0)),a.x=b,a.y=c,a}},Proj4js.Proj.vandg={init:function(){this.R=6370997},forward:function(a){var c=a.y,b=Proj4js.common.adjust_lon(a.x-this.long0),d=(Math.abs(c),Proj4js.common.asinz(2*Math.abs(c/Proj4js.common.PI))),e=((Math.abs(b)<=Proj4js.common.EPSLN||Math.abs(Math.abs(c)-Proj4js.common.HALF_PI)<=Proj4js.common.EPSLN)&&Math.tan(.5*d),.5*Math.abs(Proj4js.common.PI/b-b/Proj4js.common.PI)),f=e*e,g=Math.sin(d),d=Math.cos(d),f=Proj4js.common.PI*this.R*(e*((d=d/(g+d-1))-(g=(g=d*(2/g-1))*g))+Math.sqrt(f*(d-g)*(d-g)-(g+f)*(d*d-g)))/(g+f),b=this.x0+(f=b<0?-f:f);return f=Math.abs(f/(Proj4js.common.PI*this.R)),c=0<=c?this.y0+Proj4js.common.PI*this.R*Math.sqrt(1-f*f-2*e*f):this.y0-Proj4js.common.PI*this.R*Math.sqrt(1-f*f-2*e*f),a.x=b,a.y=c,a},inverse:function(a){var c,b,d,e,f,g,i,h;return a.x-=this.x0,a.y-=this.y0,h=Proj4js.common.PI*this.R,e=(c=a.x/h)*c+(d=a.y/h)*d,h=3*(h=d*d/(g=-2*(f=-Math.abs(d)*(1+e))+1+2*d*d+e*e)+(2*(b=f-2*d*d+c*c)*b*b/g/g/g-9*f*b/g/g)/27)/(i=(f-b*b/3/g)/g)/(f=2*Math.sqrt(-i/3)),1<Math.abs(h)&&(h=0<=h?1:-1),h=Math.acos(h)/3,b=0<=a.y?(-f*Math.cos(h+Proj4js.common.PI/3)-b/3/g)*Proj4js.common.PI:-(-f*Math.cos(h+Proj4js.common.PI/3)-b/3/g)*Proj4js.common.PI,Math.abs(c),c=Proj4js.common.adjust_lon(this.long0+Proj4js.common.PI*(e-1+Math.sqrt(1+2*(c*c-d*d)+e*e))/2/c),a.x=c,a.y=b,a}},Proj4js.Proj.cea={init:function(){},forward:function(a){var c=a.y,b=this.x0+this.a*Proj4js.common.adjust_lon(a.x-this.long0)*Math.cos(this.lat_ts),c=this.y0+this.a*Math.sin(c)/Math.cos(this.lat_ts);return a.x=b,a.y=c,a},inverse:function(a){a.x-=this.x0,a.y-=this.y0;var c=Proj4js.common.adjust_lon(this.long0+a.x/this.a/Math.cos(this.lat_ts)),b=Math.asin(a.y/this.a*Math.cos(this.lat_ts));return a.x=c,a.y=b,a}},Proj4js.Proj.eqc={init:function(){this.x0||(this.x0=0),this.y0||(this.y0=0),this.lat0||(this.lat0=0),this.long0||(this.long0=0),this.lat_ts||(this.lat_ts=0),this.title||(this.title="Equidistant Cylindrical (Plate Carre)"),this.rc=Math.cos(this.lat_ts)},forward:function(a){var c=a.y,b=Proj4js.common.adjust_lon(a.x-this.long0),c=Proj4js.common.adjust_lat(c-this.lat0);return a.x=this.x0+this.a*b*this.rc,a.y=this.y0+this.a*c,a},inverse:function(a){var c=a.y;return a.x=Proj4js.common.adjust_lon(this.long0+(a.x-this.x0)/(this.a*this.rc)),a.y=Proj4js.common.adjust_lat(this.lat0+(c-this.y0)/this.a),a}},Proj4js.Proj.cass={init:function(){this.sphere||(this.en=Proj4js.common.pj_enfn(this.es),this.m0=Proj4js.common.pj_mlfn(this.lat0,Math.sin(this.lat0),Math.cos(this.lat0),this.en))},C1:.16666666666666666,C2:.008333333333333333,C3:.041666666666666664,C4:.3333333333333333,C5:.06666666666666667,forward:function(a){var c,b,d=a.x,e=a.y,d=Proj4js.common.adjust_lon(d-this.long0);return this.sphere?(c=Math.asin(Math.cos(e)*Math.sin(d)),b=Math.atan2(Math.tan(e),Math.cos(d))-this.phi0):(this.n=Math.sin(e),this.c=Math.cos(e),b=Proj4js.common.pj_mlfn(e,this.n,this.c,this.en),this.n=1/Math.sqrt(1-this.es*this.n*this.n),this.tn=Math.tan(e),this.t=this.tn*this.tn,this.a1=d*this.c,this.c*=this.es*this.c/(1-this.es),this.a2=this.a1*this.a1,c=this.n*this.a1*(1-this.a2*this.t*(this.C1-(8-this.t+8*this.c)*this.a2*this.C2)),b-=this.m0-this.n*this.tn*this.a2*(.5+(5-this.t+6*this.c)*this.a2*this.C3)),a.x=this.a*c+this.x0,a.y=this.a*b+this.y0,a},inverse:function(a){a.x-=this.x0,a.y-=this.y0;var d,c=a.x/this.a,b=a.y/this.a,c=this.sphere?(this.dd=b+this.lat0,b=Math.asin(Math.sin(this.dd)*Math.cos(c)),Math.atan2(Math.tan(c),Math.cos(this.dd))):(d=Proj4js.common.pj_inv_mlfn(this.m0+b,this.es,this.en),this.tn=Math.tan(d),this.t=this.tn*this.tn,this.n=Math.sin(d),this.r=1/(1-this.es*this.n*this.n),this.n=Math.sqrt(this.r),this.r*=(1-this.es)*this.n,this.dd=c/this.n,this.d2=this.dd*this.dd,b=d-this.n*this.tn/this.r*this.d2*(.5-(1+3*this.t)*this.d2*this.C3),this.dd*(1+this.t*this.d2*(-this.C4+(1+3*this.t)*this.d2*this.C5))/Math.cos(d));return a.x=Proj4js.common.adjust_lon(this.long0+c),a.y=b,a}},Proj4js.Proj.gauss={init:function(){var a=Math.sin(this.lat0),c=(c=Math.cos(this.lat0))*c;this.rc=Math.sqrt(1-this.es)/(1-this.es*a*a),this.C=Math.sqrt(1+this.es*c*c/(1-this.es)),this.phic0=Math.asin(a/this.C),this.ratexp=.5*this.C*this.e,this.K=Math.tan(.5*this.phic0+Proj4js.common.FORTPI)/(Math.pow(Math.tan(.5*this.lat0+Proj4js.common.FORTPI),this.C)*Proj4js.common.srat(this.e*a,this.ratexp))},forward:function(a){var c=a.x,b=a.y;return a.y=2*Math.atan(this.K*Math.pow(Math.tan(.5*b+Proj4js.common.FORTPI),this.C)*Proj4js.common.srat(this.e*Math.sin(b),this.ratexp))-Proj4js.common.HALF_PI,a.x=this.C*c,a},inverse:function(a){for(var c=a.x/this.C,b=a.y,d=Math.pow(Math.tan(.5*b+Proj4js.common.FORTPI)/this.K,1/this.C),e=Proj4js.common.MAX_ITER;0<e&&(b=2*Math.atan(d*Proj4js.common.srat(this.e*Math.sin(a.y),-.5*this.e))-Proj4js.common.HALF_PI,!(Math.abs(b-a.y)<1e-14));--e)a.y=b;return e?(a.x=c,a.y=b,a):(Proj4js.reportError("gauss:inverse:convergence failed"),null)}},Proj4js.Proj.omerc={init:function(){this.mode||(this.mode=0),this.lon1||(this.lon1=0,this.mode=1),this.lon2||(this.lon2=0),this.lat2||(this.lat2=0);var a=1-Math.pow(this.b/this.a,2);Math.sqrt(a),this.sin_p20=Math.sin(this.lat0),this.cos_p20=Math.cos(this.lat0),this.con=1-this.es*this.sin_p20*this.sin_p20,this.com=Math.sqrt(1-a),this.bl=Math.sqrt(1+this.es*Math.pow(this.cos_p20,4)/(1-a)),this.al=this.a*this.bl*this.k0*this.com/this.con,Math.abs(this.lat0)<Proj4js.common.EPSLN?this.el=this.d=this.ts=1:(this.ts=Proj4js.common.tsfnz(this.e,this.lat0,this.sin_p20),this.con=Math.sqrt(this.con),this.d=this.bl*this.com/(this.cos_p20*this.con),this.f=0<this.d*this.d-1?0<=this.lat0?this.d+Math.sqrt(this.d*this.d-1):this.d-Math.sqrt(this.d*this.d-1):this.d,this.el=this.f*Math.pow(this.ts,this.bl)),0!=this.mode?(this.g=.5*(this.f-1/this.f),this.gama=Proj4js.common.asinz(Math.sin(this.alpha)/this.d),this.longc-=Proj4js.common.asinz(this.g*Math.tan(this.gama))/this.bl,this.con=Math.abs(this.lat0),this.con>Proj4js.common.EPSLN&&Math.abs(this.con-Proj4js.common.HALF_PI)>Proj4js.common.EPSLN?(this.singam=Math.sin(this.gama),this.cosgam=Math.cos(this.gama),this.sinaz=Math.sin(this.alpha),this.cosaz=Math.cos(this.alpha),this.u=0<=this.lat0?this.al/this.bl*Math.atan(Math.sqrt(this.d*this.d-1)/this.cosaz):-(this.al/this.bl)*Math.atan(Math.sqrt(this.d*this.d-1)/this.cosaz)):Proj4js.reportError("omerc:Init:DataError")):(this.sinphi=Math.sin(this.at1),this.ts1=Proj4js.common.tsfnz(this.e,this.lat1,this.sinphi),this.sinphi=Math.sin(this.lat2),this.ts2=Proj4js.common.tsfnz(this.e,this.lat2,this.sinphi),this.h=Math.pow(this.ts1,this.bl),this.l=Math.pow(this.ts2,this.bl),this.f=this.el/this.h,this.g=.5*(this.f-1/this.f),this.j=(this.el*this.el-this.l*this.h)/(this.el*this.el+this.l*this.h),this.p=(this.l-this.h)/(this.l+this.h),this.dlon=this.lon1-this.lon2,this.dlon<-Proj4js.common.PI&&(this.lon2-=2*Proj4js.common.PI),this.dlon>Proj4js.common.PI&&(this.lon2+=2*Proj4js.common.PI),this.dlon=this.lon1-this.lon2,this.longc=.5*(this.lon1+this.lon2)-Math.atan(this.j*Math.tan(.5*this.bl*this.dlon)/this.p)/this.bl,this.dlon=Proj4js.common.adjust_lon(this.lon1-this.longc),this.gama=Math.atan(Math.sin(this.bl*this.dlon)/this.g),this.alpha=Proj4js.common.asinz(this.d*Math.sin(this.gama)),Math.abs(this.lat1-this.lat2)<=Proj4js.common.EPSLN?Proj4js.reportError("omercInitDataError"):this.con=Math.abs(this.lat1),(this.con<=Proj4js.common.EPSLN||Math.abs(this.con-Proj4js.common.HALF_PI)<=Proj4js.common.EPSLN||Math.abs(Math.abs(this.lat0)-Proj4js.common.HALF_PI)<=Proj4js.common.EPSLN)&&Proj4js.reportError("omercInitDataError"),this.singam=Math.sin(this.gam),this.cosgam=Math.cos(this.gam),this.sinaz=Math.sin(this.alpha),this.cosaz=Math.cos(this.alpha),this.u=0<=this.lat0?this.al/this.bl*Math.atan(Math.sqrt(this.d*this.d-1)/this.cosaz):-(this.al/this.bl)*Math.atan(Math.sqrt(this.d*this.d-1)/this.cosaz))},forward:function(a){var f,d=a.x,b=a.y,c=Math.sin(b),e=Proj4js.common.adjust_lon(d-this.longc);return d=Math.sin(this.bl*e),Math.abs(Math.abs(b)-Proj4js.common.HALF_PI)>Proj4js.common.EPSLN?(c=Proj4js.common.tsfnz(this.e,b,c),c=((f=.5*((c=this.el/Math.pow(c,this.bl))-1/c))*this.singam-d*this.cosgam)/(.5*(c+1/c)),b=Math.cos(this.bl*e),Math.abs(b)<1e-7?d=this.al*this.bl*e:(d=this.al*Math.atan((f*this.cosgam+d*this.singam)/b)/this.bl,b<0&&(d+=Proj4js.common.PI*this.al/this.bl))):(c=0<=b?this.singam:-this.singam,d=this.al*b/this.bl),Math.abs(Math.abs(c)-1)<=Proj4js.common.EPSLN&&Proj4js.reportError("omercFwdInfinity"),e=.5*this.al*Math.log((1-c)/(1+c))/this.bl,d-=this.u,c=this.y0+d*this.cosaz-e*this.sinaz,a.x=this.x0+e*this.cosaz+d*this.sinaz,a.y=c,a},inverse:function(a){var c,b,d,e;return a.x-=this.x0,a.y-=this.y0,c=a.x*this.cosaz-a.y*this.sinaz,d=a.y*this.cosaz+a.x*this.sinaz,d+=this.u,c=.5*((b=Math.exp(-this.bl*c/this.al))-1/b),b=.5*(b+1/b),e=((d=Math.sin(this.bl*d/this.al))*this.cosgam+c*this.singam)/b,Math.abs(Math.abs(e)-1)<=Proj4js.common.EPSLN?(c=this.longc,e=0<=e?Proj4js.common.HALF_PI:-Proj4js.common.HALF_PI):(b=1/this.bl,e=Math.pow(this.el/Math.sqrt((1+e)/(1-e)),b),e=Proj4js.common.phi2z(this.e,e),c=this.longc-Math.atan2(c*this.cosgam-d*this.singam,b)/this.bl,c=Proj4js.common.adjust_lon(c)),a.x=c,a.y=e,a}},Proj4js.Proj.lcc={init:function(){var a,c,b,e,d,f;this.lat2||(this.lat2=this.lat0),this.k0||(this.k0=1),Math.abs(this.lat1+this.lat2)<Proj4js.common.EPSLN?Proj4js.reportError("lcc:init: Equal Latitudes"):(a=this.b/this.a,this.e=Math.sqrt(1-a*a),a=Math.sin(this.lat1),c=Math.cos(this.lat1),c=Proj4js.common.msfnz(this.e,a,c),b=Proj4js.common.tsfnz(this.e,this.lat1,a),d=Math.sin(this.lat2),e=Math.cos(this.lat2),e=Proj4js.common.msfnz(this.e,d,e),d=Proj4js.common.tsfnz(this.e,this.lat2,d),f=Proj4js.common.tsfnz(this.e,this.lat0,Math.sin(this.lat0)),this.ns=Math.abs(this.lat1-this.lat2)>Proj4js.common.EPSLN?Math.log(c/e)/Math.log(b/d):a,this.f0=c/(this.ns*Math.pow(b,this.ns)),this.rh=this.a*this.f0*Math.pow(f,this.ns),this.title||(this.title="Lambert Conformal Conic"))},forward:function(a){var c=a.x,b=a.y;if(!(b<=90&&-90<=b&&c<=180&&-180<=c))return Proj4js.reportError("lcc:forward: llInputOutOfRange: "+c+" : "+b),null;if(Math.abs(Math.abs(b)-Proj4js.common.HALF_PI)>Proj4js.common.EPSLN)b=Proj4js.common.tsfnz(this.e,b,Math.sin(b)),b=this.a*this.f0*Math.pow(b,this.ns);else{if(b*this.ns<=0)return Proj4js.reportError("lcc:forward: No Projection"),null;b=0}return c=this.ns*Proj4js.common.adjust_lon(c-this.long0),a.x=this.k0*b*Math.sin(c)+this.x0,a.y=this.k0*(this.rh-b*Math.cos(c))+this.y0,a},inverse:function(a){var c,e=(a.x-this.x0)/this.k0,f=this.rh-(a.y-this.y0)/this.k0,b=0<this.ns?(c=Math.sqrt(e*e+f*f),1):(c=-Math.sqrt(e*e+f*f),-1),d=0;if(0!=c&&(d=Math.atan2(b*e,b*f)),0!=c||0<this.ns){if(b=1/this.ns,c=Math.pow(c/(this.a*this.f0),b),-9999==(c=Proj4js.common.phi2z(this.e,c)))return null}else c=-Proj4js.common.HALF_PI;return d=Proj4js.common.adjust_lon(d/this.ns+this.long0),a.x=d,a.y=c,a}},Proj4js.Proj.laea={S_POLE:1,N_POLE:2,EQUIT:3,OBLIQ:4,init:function(){var a=Math.abs(this.lat0);if(this.mode=Math.abs(a-Proj4js.common.HALF_PI)<Proj4js.common.EPSLN?this.lat0<0?this.S_POLE:this.N_POLE:Math.abs(a)<Proj4js.common.EPSLN?this.EQUIT:this.OBLIQ,0<this.es)switch(this.qp=Proj4js.common.qsfnz(this.e,1),this.mmf=.5/(1-this.es),this.apa=this.authset(this.es),this.mode){case this.N_POLE:case this.S_POLE:this.dd=1;break;case this.EQUIT:this.rq=Math.sqrt(.5*this.qp),this.dd=1/this.rq,this.xmf=1,this.ymf=.5*this.qp;break;case this.OBLIQ:this.rq=Math.sqrt(.5*this.qp),a=Math.sin(this.lat0),this.sinb1=Proj4js.common.qsfnz(this.e,a)/this.qp,this.cosb1=Math.sqrt(1-this.sinb1*this.sinb1),this.dd=Math.cos(this.lat0)/(Math.sqrt(1-this.es*a*a)*this.rq*this.cosb1),this.ymf=(this.xmf=this.rq)/this.dd,this.xmf*=this.dd}else this.mode==this.OBLIQ&&(this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0))},forward:function(a){var c,b,d=a.x,e=a.y,d=Proj4js.common.adjust_lon(d-this.long0);if(this.sphere){var i=Math.sin(e),g=Math.cos(e),f=Math.cos(d);switch(this.mode){case this.OBLIQ:case this.EQUIT:if((b=this.mode==this.EQUIT?1+g*f:1+this.sinph0*i+this.cosph0*g*f)<=Proj4js.common.EPSLN)return Proj4js.reportError("laea:fwd:y less than eps"),null;c=(b=Math.sqrt(2/b))*g*Math.sin(d),b*=this.mode==this.EQUIT?i:this.cosph0*i-this.sinph0*g*f;break;case this.N_POLE:f=-f;case this.S_POLE:if(Math.abs(e+this.phi0)<Proj4js.common.EPSLN)return Proj4js.reportError("laea:fwd:phi < eps"),null;b=Proj4js.common.FORTPI-.5*e,c=(b=2*(this.mode==this.S_POLE?Math.cos(b):Math.sin(b)))*Math.sin(d),b*=f}}else{var h=g=0,j=0;switch(f=Math.cos(d),d=Math.sin(d),i=Math.sin(e),i=Proj4js.common.qsfnz(this.e,i),this.mode!=this.OBLIQ&&this.mode!=this.EQUIT||(g=i/this.qp,h=Math.sqrt(1-g*g)),this.mode){case this.OBLIQ:j=1+this.sinb1*g+this.cosb1*h*f;break;case this.EQUIT:j=1+h*f;break;case this.N_POLE:j=Proj4js.common.HALF_PI+e,i=this.qp-i;break;case this.S_POLE:j=e-Proj4js.common.HALF_PI,i=this.qp+i}if(Math.abs(j)<Proj4js.common.EPSLN)return Proj4js.reportError("laea:fwd:b < eps"),null;switch(this.mode){case this.OBLIQ:case this.EQUIT:j=Math.sqrt(2/j),b=this.mode==this.OBLIQ?this.ymf*j*(this.cosb1*g-this.sinb1*h*f):(j=Math.sqrt(2/(1+h*f)))*g*this.ymf,c=this.xmf*j*h*d;break;case this.N_POLE:case this.S_POLE:0<=i?(c=(j=Math.sqrt(i))*d,b=f*(this.mode==this.S_POLE?j:-j)):c=b=0}}return a.x=this.a*c+this.x0,a.y=this.a*b+this.y0,a},inverse:function(a){a.x-=this.x0,a.y-=this.y0;var c=a.x/this.a,b=a.y/this.a;if(this.sphere){var d,e=0,g=0,f=Math.sqrt(c*c+b*b);if(1<(d=.5*f))return Proj4js.reportError("laea:Inv:DataError"),null;switch(d=2*Math.asin(d),this.mode!=this.OBLIQ&&this.mode!=this.EQUIT||(g=Math.sin(d),e=Math.cos(d)),this.mode){case this.EQUIT:d=Math.abs(f)<=Proj4js.common.EPSLN?0:Math.asin(b*g/f),c*=g,b=e*f;break;case this.OBLIQ:d=Math.abs(f)<=Proj4js.common.EPSLN?this.phi0:Math.asin(e*this.sinph0+b*g*this.cosph0/f),c*=g*this.cosph0,b=(e-Math.sin(d)*this.sinph0)*f;break;case this.N_POLE:b=-b,d=Proj4js.common.HALF_PI-d;break;case this.S_POLE:d-=Proj4js.common.HALF_PI}c=0!=b||this.mode!=this.EQUIT&&this.mode!=this.OBLIQ?Math.atan2(c,b):0}else{switch(d=0,this.mode){case this.EQUIT:case this.OBLIQ:if(c/=this.dd,b*=this.dd,(g=Math.sqrt(c*c+b*b))<Proj4js.common.EPSLN)return a.x=0,a.y=this.phi0,a;f=2*Math.asin(.5*g/this.rq),e=Math.cos(f),c*=f=Math.sin(f),b=this.mode==this.OBLIQ?(d=e*this.sinb1+b*f*this.cosb1/g,g*this.cosb1*e-b*this.sinb1*f):(d=b*f/g,g*e);break;case this.N_POLE:b=-b;case this.S_POLE:if(!(d=c*c+b*b))return a.x=0,a.y=this.phi0,a;d=1-d/this.qp,this.mode==this.S_POLE&&(d=-d)}c=Math.atan2(c,b),d=this.authlat(Math.asin(d),this.apa)}return a.x=Proj4js.common.adjust_lon(this.long0+c),a.y=d,a},P00:.3333333333333333,P01:.17222222222222222,P02:.10257936507936508,P10:.06388888888888888,P11:.0664021164021164,P20:.016415012942191543,authset:function(a){var c,b=[];return b[0]=a*this.P00,b[0]+=(c=a*a)*this.P01,b[1]=c*this.P10,b[0]+=(c*=a)*this.P02,b[1]+=c*this.P11,b[2]=c*this.P20,b},authlat:function(a,c){var b=a+a;return a+c[0]*Math.sin(b)+c[1]*Math.sin(b+b)+c[2]*Math.sin(b+b+b)}},Proj4js.Proj.aeqd={init:function(){this.sin_p12=Math.sin(this.lat0),this.cos_p12=Math.cos(this.lat0)},forward:function(a){var b,c=a.x,d=Math.sin(a.y),e=Math.cos(a.y),c=Proj4js.common.adjust_lon(c-this.long0),f=Math.cos(c),g=this.sin_p12*d+this.cos_p12*e*f;if(Math.abs(Math.abs(g)-1)<Proj4js.common.EPSLN){if(b=1,g<0)return void Proj4js.reportError("aeqd:Fwd:PointError")}else b=Math.acos(g),b/=Math.sin(b);return a.x=this.x0+this.a*b*e*Math.sin(c),a.y=this.y0+this.a*b*(this.cos_p12*d-this.sin_p12*e*f),a},inverse:function(a){a.x-=this.x0,a.y-=this.y0;var d,b,e,f,g,c=Math.sqrt(a.x*a.x+a.y*a.y);if(!(c>2*Proj4js.common.HALF_PI*this.a))return b=c/this.a,d=Math.sin(b),b=Math.cos(b),e=this.long0,Math.abs(c)<=Proj4js.common.EPSLN?f=this.lat0:(f=Proj4js.common.asinz(b*this.sin_p12+a.y*d*this.cos_p12/c),g=Math.abs(this.lat0)-Proj4js.common.HALF_PI,Math.abs(g)<=Proj4js.common.EPSLN?e=0<=this.lat0?Proj4js.common.adjust_lon(this.long0+Math.atan2(a.x,-a.y)):Proj4js.common.adjust_lon(this.long0-Math.atan2(-a.x,a.y)):(g=b-this.sin_p12*Math.sin(f),Math.abs(g)<Proj4js.common.EPSLN&&Math.abs(a.x)<Proj4js.common.EPSLN||(Math.atan2(a.x*d*this.cos_p12,g*c),e=Proj4js.common.adjust_lon(this.long0+Math.atan2(a.x*d*this.cos_p12,g*c))))),a.x=e,a.y=f,a;Proj4js.reportError("aeqdInvDataError")}},Proj4js.Proj.moll={init:function(){},forward:function(a){for(var c=a.y,b=Proj4js.common.adjust_lon(a.x-this.long0),d=c,e=Proj4js.common.PI*Math.sin(c),f=0;;f++){var g=-(d+Math.sin(d)-e)/(1+Math.cos(d)),d=d+g;if(Math.abs(g)<Proj4js.common.EPSLN)break;50<=f&&Proj4js.reportError("moll:Fwd:IterationError")}return d/=2,Proj4js.common.PI/2-Math.abs(c)<Proj4js.common.EPSLN&&(b=0),c=.900316316158*this.a*b*Math.cos(d)+this.x0,d=1.4142135623731*this.a*Math.sin(d)+this.y0,a.x=c,a.y=d,a},inverse:function(a){a.x-=this.x0,c=a.y/(1.4142135623731*this.a),.999999999999<Math.abs(c)&&(c=.999999999999),c=Math.asin(c);var c,b=Proj4js.common.adjust_lon(this.long0+a.x/(.900316316158*this.a*Math.cos(c)));return(b=b<-Proj4js.common.PI?-Proj4js.common.PI:b)>Proj4js.common.PI&&(b=Proj4js.common.PI),c=(2*c+Math.sin(2*c))/Proj4js.common.PI,1<Math.abs(c)&&(c=1),c=Math.asin(c),a.x=b,a.y=c,a}};